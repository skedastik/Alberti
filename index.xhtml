<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
   "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Alberti Draw</title>
<meta name="description" content="Alberti is a browser-based perspective drawing and layout application." />
<style>#selectionBox,#workspace .selected{stroke-dasharray:4,4;marker-end:url('#marker_selected');marker-start:url('#marker_selected')}#background{visibility:hidden}#master{pointer-events:none;fill:none}#overlay{stroke:red;fill:none}#underlay{stroke:red;stroke-opacity:.2}#underlayimg{position:fixed}#selectionBox{stroke:black}text{font-family:'Lucida Grande','Lucida Sans Unicode',sans-serif;font-size:11px}text,img{pointer-events:none}#static_overlay text{fill:red}.cursorDefault{cursor:auto}.cursorZoomAndPan{cursor:move}.cursorCrosshair{cursor:crosshair}.cursorBusy{cursor:wait}.optimized{shape-rendering:crispEdges}body{color:#ddd;font-family:'Lucida Grande','Lucida Sans Unicode',sans-serif;font-size:14px;margin:0;background-color:#f4f4f4;overflow:hidden}body,div,img,ul{-webkit-user-select:none;-moz-user-select:-moz-none;user-select:none}a{color:#46e}#striptop{position:fixed;height:5px;width:100%;background-color:#000}#tooltip{position:fixed;left:9px;bottom:6px;font-size:11px;color:#f00}#hidden_div{position:fixed;top:-1000px;left:-1000px;opacity:0}#js_required{position:fixed;width:450px;height:30px;top:50%;left:50%;margin-top:-15px;margin-left:-225px;color:#000;font-family:'Baskerville','Palatino Linotype','Book Antiqua','Palatino',serif;font-size:20px}.modal{position:fixed;top:50%;left:50%;margin-left:-250px;width:500px;font-family:'Georgia',serif}.modal *{-webkit-user-select:text;-moz-user-select:text;user-select:text}#about_box{margin-top:-180px}.cbox{position:relative;left:500px;width:20px;height:20px;border-radius:10px 10px 10px 0;background:#333 url(../images/closebox.png) 5px 5px no-repeat;cursor:pointer;box-shadow:0 6px 8px rgba(0,0,0,0.25);-webkit-box-shadow:0 6px 8px rgba(0,0,0,0.25)}.cbox:hover{background-color:red}#about_top{padding-left:10px;height:50px;border-top-left-radius:15px;background:#333;color:#fff}#about_bot{position:relative;top:-16px;height:290px;border-bottom-left-radius:15px;border-bottom-right-radius:15px;background:#fff url('images/splash.gif') right no-repeat;box-shadow:0 6px 10px rgba(0,0,0,0.4);-webkit-box-shadow:0 6px 10px rgba(0,0,0,0.4)}#about_left{padding:0 10px 10px 10px;float:left;font-size:12px}#about_left>p{padding:0;margin:10px 0 0 0;color:#888}#about_left p.indent{margin-top:4px;padding-left:20px;color:#000}#about_left p.license{width:220px;margin-top:16px}.kickup{position:relative;top:-25px}.masthead{color:#fff;font-family:'Baskerville','Palatino Linotype','Book Antiqua','Palatino',serif;font-size:60px}.blurb{margin-left:8px;color:#888}.subsidiary{font-size:10px;font-weight:bold}#version{position:relative;top:-15px;text-align:right}body:after{content:url('images/center_cam_sel.png') url('images/next_vp_sel.png') url('images/prev_vp_sel.png') url('images/ul_btn_selected.png') url('images/addlayer_active.png') url('images/remlayer_active.png') url('images/lpcollapse_on.png');display:none}#layer_panel{position:fixed;bottom:26px;right:0}#layer_panel_dynamic{border-top-left-radius:13px;text-shadow:1px 1px 0 #222;background-color:#000}#layer_panel_control_strip{border-bottom:1px solid #333;border-bottom-left-radius:13px;color:#888;background-image:url('images/cstripbg.png')}#layer_panel_dynamic,#layer_panel_control_strip{border-left:1px solid #333}.layer_panel_row{width:206px;height:17px;padding:4px 4px 5px 4px;border-bottom:1px solid #444;overflow:hidden}.layer_panel_row.guiBtnToggled{background:url('images/layer_row_selected.png') repeat-x}.layer_panel_row.guiBtnDisabled{color:#686868;text-shadow:none}.layer_panel_row.ghost{opacity:.5;border-top-left-radius:13px;border-bottom-left-radius:13px;border-bottom:0;background:url('images/layer_row_ghost.png') repeat-y}#layer_panel_control_strip .layer_panel_row{border-bottom:0;cursor:auto}.layer_name{float:left;cursor:default;margin-top:1px;margin-left:4px;max-width:150px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;-o-text-overflow:ellipsis}.visibility_toggle,.new_layer_button,.delete_layer_button,.lp_collapse_button{width:18px;height:18px;margin-left:4px;background-repeat:no-repeat;background-position:center;float:left;cursor:pointer}.visibility_toggle{width:24px;background-image:url('images/vistog_on.png')}.visibility_toggle.guiBtnToggled{background-image:url('images/vistog.png')}.visibility_toggle.guiBtnDisabled{background-image:url('images/vistog_disabled.png')}.new_layer_button{float:right;background-image:url('images/addlayer.png')}.new_layer_button:active{float:right;background-image:url('images/addlayer_active.png')}.delete_layer_button{float:right;background-image:url('images/remlayer.png')}.delete_layer_button:active{background-image:url('images/remlayer_active.png')}.delete_layer_button.guiBtnDisabled{background-image:url('images/remlayer_disabled.png')}.lp_collapse_button{margin-left:0;background-image:url('images/lpcollapse.png')}.lp_collapse_button.guiBtnToggled{background-image:url('images/lpcollapse_on.png')}.color_well{width:16px;height:16px;margin:1px;float:left;border-radius:8px;box-shadow:inset -1px -1px 0 rgba(255,255,255,0.75),inset 1px 1px 3px rgba(0,0,0,0.5);-o-box-shadow:inset -1px -1px 0 rgba(255,255,255,0.75),inset 1px 1px 3px rgba(0,0,0,0.5);-moz-box-shadow:inset -1px -1px 0 rgba(255,255,255,0.75),inset 1px 1px 3px rgba(0,0,0,0.5);-webkit-box-shadow:inset -1px -1px 0 rgba(255,255,255,0.75),inset 1px 1px 3px rgba(0,0,0,0.5);cursor:pointer}.layer_name_input{position:relative;right:-4px;top:-3px;margin:0;width:153px;font-family:'Lucida Grande','Lucida Sans Unicode',sans-serif;font-size:14px}input.color{position:relative;margin-right:-7px;right:6px;padding:0;width:1px;height:1px;float:left;visibility:hidden}#insertmark{position:fixed;right:0;width:180px;height:26px;background-image:url('images/linsert.png');pointer-events:none}#menubar{position:fixed;left:31px;top:0;height:29px;border-bottom-left-radius:5px;border-bottom-right-radius:5px;padding:0 5px 0 5px;cursor:default;background-color:#000}#menubar *{float:left;overflow:hidden;white-space:nowrap}.mb_vr{width:1px;height:29px;background-color:#444}ul.menu{margin:0;padding:4px 0 5px 0;border-bottom-left-radius:5px;border-bottom-right-radius:5px;border-top-right-radius:5px;list-style-type:none;cursor:default;background-color:#383838;box-shadow:0 6px 10px rgba(0,0,0,0.4);-webkit-box-shadow:0 6px 10px rgba(0,0,0,0.4)}ul.menu li{padding:0 10px 2px 20px}ul.menu li.guiMenuDisabled,ul.menu li.guiMenuDisabled:hover{color:#777;background:0}ul.menu li:hover{color:#fff;background:#35d url('images/layer_row_selected.png') repeat-x}ul.menu li *{pointer-events:none}ul.menu li.mi_hr hr{border:0;height:1px;background-color:#555}ul.menu li.mi_hr,ul.menu li.mi_hr:hover{padding:0}.mi_name{float:left}.mi_spacer{visibility:hidden}#file_menu .mi_name{width:95px}#edit_menu .mi_name{width:145px}.mb_btn{height:19px;padding:7px 6px 3px 6px}.guiMenuOpened{color:#fff;background:#35d url('images/layer_row_selected.png') bottom repeat-x}#help_menu_btn{padding-right:8px;padding-left:9px}#file_menu_btn{padding-left:8px;padding-right:8px}#edit_menu_btn{padding-left:8px}#ul_menu_btn{width:20px;background:url('images/ul_btn.png') center no-repeat}#ul_menu_btn.guiMenuOpened{background-color:#35d;background-image:url('images/layer_row_selected.png'),url('images/ul_btn_selected.png');background-repeat:repeat-x,no-repeat;background-position:bottom,center}.btn_wrapper{height:21px;margin:4px 4px 0 4px;background:#666;border-radius:3px;font-size:11px}#ul_slider_cab label{margin:1px 2px 0 0}#ul_slider_wrapper{margin-top:2px;padding:0 4px 0 4px}#ul_opac_slider{float:none;width:100px}.top_btn{width:20px;height:20px;padding:1px 5px 0 5px}#center_ws_btn{background:url('images/center_cam.png') center no-repeat}#center_ws_btn:active{background-image:url('images/center_cam_sel.png')}#next_marker_btn{background:url('images/next_vp.png') center no-repeat}#next_marker_btn:active{background-image:url('images/next_vp_sel.png')}#next_marker_btn.guiBtnDisabled{background:url('images/next_vp_disabled.png') center no-repeat}#prev_marker_btn{background:url('images/prev_vp.png') center no-repeat}#prev_marker_btn:active{background-image:url('images/prev_vp_sel.png')}#prev_marker_btn.guiBtnDisabled{background:url('images/prev_vp_disabled.png') center no-repeat}#toolbar{position:fixed;left:0;top:35px;width:26px;border-width:4px 4px 4px 1px;border-style:solid;border-color:#000;border-top-right-radius:9px;border-bottom-right-radius:9px;cursor:default;background:#666}#toolbar>div:first-child{border-top-right-radius:6px}#toolbar>div:last-child{border-bottom-right-radius:6px}.tb_hr{width:26px;height:1px;background-color:#464646;border-bottom:1px solid #7c7c7c}.side_btn>div{width:26px;height:26px}.side_btn:active{background:url('images/tb_btn_active.png') repeat-x}.side_btn.guiBtnToggled{background:url('images/tb_btn_selected.png') repeat-x}.side_btn.guiBtnToggled:active{background:url('images/tb_btn_selected.png') repeat-x;background-color:#585858}#select_tool_btn>div{background:url('images/select_tool_btn.png') center no-repeat}#line_tool_btn>div{background:url('images/line_tool_btn.png') center no-repeat}#carc_tool_btn>div{background:url('images/carc_tool_btn.png') center no-repeat}#earc_tool_btn>div{background:url('images/persp_arc_tool_btn.png') center no-repeat}#bez_tool_btn>div{background:url('images/bez_tool_btn.png') center no-repeat}#marker_tool_btn>div{background:url('images/marker_tool_btn.png') center no-repeat}</style>
<script type="text/ecmascript"> <![CDATA[
var jscolor={dir:"",bindClass:"color",binding:true,preloading:true,install:function(){jscolor.addEvent(window,"load",jscolor.init);},init:function(){if(jscolor.binding){jscolor.bind();}if(jscolor.preloading){jscolor.preload();}},getDir:function(){if(!jscolor.dir){var a=jscolor.detectDir();jscolor.dir=a!==false?a:"jscolor/";}return jscolor.dir;},detectDir:function(){var c=location.href;var d=document.getElementsByTagName("base");for(var a=0;a<d.length;a+=1){if(d[a].href){c=d[a].href;}}var d=document.getElementsByTagName("script");for(var a=0;a<d.length;a+=1){if(d[a].src&&/(^|\/)jscolor\.js([?#].*)?$/i.test(d[a].src)){var f=new jscolor.URI(d[a].src);var b=f.toAbsolute(c);b.path=b.path.replace(/[^\/]+$/,"");b.query=null;b.fragment=null;return b.toString();}}return false;},bind:function(){var matchClass=new RegExp("(^|\\s)("+jscolor.bindClass+")\\s*(\\{[^}]*\\})?","i");var e=document.getElementsByTagName("input");for(var i=0;i<e.length;i+=1){var m;if(!e[i].color&&e[i].className&&(m=e[i].className.match(matchClass))){var prop={};if(m[3]){try{eval("prop="+m[3]);}catch(eInvalidProp){}}e[i].color=new jscolor.color(e[i],prop);}}},preload:function(){for(var a in jscolor.imgRequire){if(jscolor.imgRequire.hasOwnProperty(a)){jscolor.loadImage(a);}}},images:{pad:[181,101],sld:[16,101],cross:[15,15],arrow:[7,11]},imgRequire:{},imgLoaded:{},requireImage:function(a){jscolor.imgRequire[a]=true;},loadImage:function(a){if(!jscolor.imgLoaded[a]){jscolor.imgLoaded[a]=new Image();jscolor.imgLoaded[a].src=jscolor.getDir()+a;}},fetchElement:function(a){return typeof a==="string"?document.getElementById(a):a;},addEvent:function(a,c,b){if(a.addEventListener){a.addEventListener(c,b,false);}else{if(a.attachEvent){a.attachEvent("on"+c,b);}}},fireEvent:function(a,c){if(!a){return;}if(document.createEventObject){var b=document.createEventObject();a.fireEvent("on"+c,b);}else{if(document.createEvent){var b=document.createEvent("HTMLEvents");b.initEvent(c,true,true);a.dispatchEvent(b);}else{if(a["on"+c]){a["on"+c]();}}}},getElementPos:function(c){var d=c,b=c;var a=0,f=0;if(d.offsetParent){do{a+=d.offsetLeft;f+=d.offsetTop;}while(d=d.offsetParent);}while((b=b.parentNode)&&b.nodeName.toUpperCase()!=="BODY"){a-=b.scrollLeft;f-=b.scrollTop;}return[a,f];},getElementSize:function(a){return[a.offsetWidth,a.offsetHeight];},getMousePos:function(a){if(!a){a=window.event;}if(typeof a.pageX==="number"){return[a.pageX,a.pageY];}else{if(typeof a.clientX==="number"){return[a.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,a.clientY+document.body.scrollTop+document.documentElement.scrollTop];}}},getViewPos:function(){if(typeof window.pageYOffset==="number"){return[window.pageXOffset,window.pageYOffset];}else{if(document.body&&(document.body.scrollLeft||document.body.scrollTop)){return[document.body.scrollLeft,document.body.scrollTop];}else{if(document.documentElement&&(document.documentElement.scrollLeft||document.documentElement.scrollTop)){return[document.documentElement.scrollLeft,document.documentElement.scrollTop];}else{return[0,0];}}}},getViewSize:function(){if(typeof window.innerWidth==="number"){return[window.innerWidth,window.innerHeight];}else{if(document.body&&(document.body.clientWidth||document.body.clientHeight)){return[document.body.clientWidth,document.body.clientHeight];}else{if(document.documentElement&&(document.documentElement.clientWidth||document.documentElement.clientHeight)){return[document.documentElement.clientWidth,document.documentElement.clientHeight];}else{return[0,0];}}}},URI:function(a){this.scheme=null;this.authority=null;this.path="";this.query=null;this.fragment=null;this.parse=function(d){var c=d.match(/^(([A-Za-z][0-9A-Za-z+.-]*)(:))?((\/\/)([^\/?#]*))?([^?#]*)((\?)([^#]*))?((#)(.*))?/);this.scheme=c[3]?c[2]:null;this.authority=c[5]?c[6]:null;this.path=c[7];this.query=c[9]?c[10]:null;this.fragment=c[12]?c[13]:null;return this;};this.toString=function(){var c="";if(this.scheme!==null){c=c+this.scheme+":";}if(this.authority!==null){c=c+"//"+this.authority;}if(this.path!==null){c=c+this.path;}if(this.query!==null){c=c+"?"+this.query;}if(this.fragment!==null){c=c+"#"+this.fragment;}return c;};this.toAbsolute=function(e){var e=new jscolor.URI(e);var d=this;var c=new jscolor.URI;if(e.scheme===null){return false;}if(d.scheme!==null&&d.scheme.toLowerCase()===e.scheme.toLowerCase()){d.scheme=null;}if(d.scheme!==null){c.scheme=d.scheme;c.authority=d.authority;c.path=b(d.path);c.query=d.query;}else{if(d.authority!==null){c.authority=d.authority;c.path=b(d.path);c.query=d.query;}else{if(d.path===""){c.path=e.path;if(d.query!==null){c.query=d.query;}else{c.query=e.query;}}else{if(d.path.substr(0,1)==="/"){c.path=b(d.path);}else{if(e.authority!==null&&e.path===""){c.path="/"+d.path;}else{c.path=e.path.replace(/[^\/]+$/,"")+d.path;}c.path=b(c.path);}c.query=d.query;}c.authority=e.authority;}c.scheme=e.scheme;}c.fragment=d.fragment;return c;};function b(e){var c="";while(e){if(e.substr(0,3)==="../"||e.substr(0,2)==="./"){e=e.replace(/^\.+/,"").substr(1);}else{if(e.substr(0,3)==="/./"||e==="/."){e="/"+e.substr(3);}else{if(e.substr(0,4)==="/../"||e==="/.."){e="/"+e.substr(4);c=c.replace(/\/?[^\/]*$/,"");}else{if(e==="."||e===".."){e="";}else{var d=e.match(/^\/?[^\/]*/)[0];e=e.substr(d.length);c=c+d;}}}}}return c;}if(a){this.parse(a);}},color:function(C,d){this.required=true;this.adjust=true;this.hash=false;this.caps=true;this.valueElement=C;this.styleElement=C;this.hsv=[0,0,1];this.rgb=[1,1,1];this.pickerOnfocus=true;this.pickerMode="HSV";this.pickerPosition="bottom";this.pickerFace=10;this.pickerFaceColor="ThreeDFace";this.pickerBorder=1;this.pickerBorderColor="ThreeDHighlight ThreeDShadow ThreeDShadow ThreeDHighlight";this.pickerInset=1;this.pickerInsetColor="ThreeDShadow ThreeDHighlight ThreeDHighlight ThreeDShadow";this.pickerZIndex=10000;for(var t in d){if(d.hasOwnProperty(t)){this[t]=d[t];}}this.hidePicker=function(){if(u()){f();}};this.showPicker=function(){if(!u()){var M=jscolor.getElementPos(C);var J=jscolor.getElementSize(C);var G=jscolor.getViewPos();var O=jscolor.getViewSize();var F=[2*this.pickerBorder+4*this.pickerInset+2*this.pickerFace+jscolor.images.pad[0]+2*jscolor.images.arrow[0]+jscolor.images.sld[0],2*this.pickerBorder+2*this.pickerInset+2*this.pickerFace+jscolor.images.pad[1]];var N,L,K;switch(this.pickerPosition.toLowerCase()){case"left":N=1;L=0;K=-1;break;case"right":N=1;L=0;K=1;break;case"top":N=0;L=1;K=-1;break;default:N=0;L=1;K=1;break;}var I=(J[L]+F[L])/2;var H=[-G[N]+M[N]+F[N]>O[N]?(-G[N]+M[N]+J[N]/2>O[N]/2&&M[N]+J[N]-F[N]>=0?M[N]+J[N]-F[N]:M[N]):M[N],-G[L]+M[L]+J[L]+F[L]-I+I*K>O[L]?(-G[L]+M[L]+J[L]/2>O[L]/2&&M[L]+J[L]-I-I*K>=0?M[L]+J[L]-I-I*K:M[L]+J[L]-I+I*K):(M[L]+J[L]-I+I*K>=0?M[L]+J[L]-I+I*K:M[L]+J[L]-I-I*K)];k(H[N],H[L]);}};this.importColor=function(){if(!a){this.exportColor();}else{if(!this.adjust){if(!this.fromString(a.value,x)){E.style.backgroundColor=E.jscStyle.backgroundColor;E.style.color=E.jscStyle.color;this.exportColor(x|D);}}else{if(!this.required&&/^\s*$/.test(a.value)){a.value="";E.style.backgroundColor=E.jscStyle.backgroundColor;E.style.color=E.jscStyle.color;this.exportColor(x|D);}else{if(this.fromString(a.value)){}else{this.exportColor();}}}}};this.exportColor=function(F){if(!(F&x)&&a){var G=this.toString();if(this.caps){G=G.toUpperCase();}if(this.hash){G="#"+G;}a.value=G;}if(!(F&D)&&E){E.style.backgroundColor="#"+this.toString();E.style.color=0.213*this.rgb[0]+0.715*this.rgb[1]+0.072*this.rgb[2]<0.5?"#FFF":"#000";}if(!(F&v)&&u()){s();}if(!(F&e)&&u()){B();}};this.fromHSV=function(I,H,G,F){I<0&&(I=0)||I>6&&(I=6);H<0&&(H=0)||H>1&&(H=1);G<0&&(G=0)||G>1&&(G=1);this.rgb=g(I===null?this.hsv[0]:(this.hsv[0]=I),H===null?this.hsv[1]:(this.hsv[1]=H),G===null?this.hsv[2]:(this.hsv[2]=G));this.exportColor(F);};this.fromRGB=function(J,I,F,G){J<0&&(J=0)||J>1&&(J=1);I<0&&(I=0)||I>1&&(I=1);F<0&&(F=0)||F>1&&(F=1);var H=y(J===null?this.rgb[0]:(this.rgb[0]=J),I===null?this.rgb[1]:(this.rgb[1]=I),F===null?this.rgb[2]:(this.rgb[2]=F));if(H[0]!==null){this.hsv[0]=H[0];}if(H[2]!==0){this.hsv[1]=H[1];}this.hsv[2]=H[2];this.exportColor(G);};this.fromString=function(H,G){var F=H.match(/^\W*([0-9A-F]{3}([0-9A-F]{3})?)\W*$/i);if(!F){return false;}else{if(F[1].length===6){this.fromRGB(parseInt(F[1].substr(0,2),16)/255,parseInt(F[1].substr(2,2),16)/255,parseInt(F[1].substr(4,2),16)/255,G);}else{this.fromRGB(parseInt(F[1].charAt(0)+F[1].charAt(0),16)/255,parseInt(F[1].charAt(1)+F[1].charAt(1),16)/255,parseInt(F[1].charAt(2)+F[1].charAt(2),16)/255,G);}return true;}};this.toString=function(){return((256|Math.round(255*this.rgb[0])).toString(16).substr(1)+(256|Math.round(255*this.rgb[1])).toString(16).substr(1)+(256|Math.round(255*this.rgb[2])).toString(16).substr(1));};function y(K,J,G){var L=Math.min(Math.min(K,J),G);var H=Math.max(Math.max(K,J),G);var F=H-L;if(F===0){return[null,0,H];}var I=K===L?3+(G-J)/F:(J===L?5+(K-G)/F:1+(J-K)/F);return[I===6?0:I,F/H,H];}function g(J,I,G){if(J===null){return[G,G,G];}var H=Math.floor(J);var K=H%2?J-H:1-(J-H);var F=G*(1-I);var L=G*(1-I*K);switch(H){case 6:case 0:return[G,L,F];case 1:return[L,G,F];case 2:return[F,G,L];case 3:return[F,L,G];case 4:return[L,F,G];case 5:return[G,F,L];}}function f(){delete jscolor.picker.owner;document.getElementsByTagName("body")[0].removeChild(jscolor.picker.boxB);}function k(F,M){if(!jscolor.picker){jscolor.picker={box:document.createElement("div"),boxB:document.createElement("div"),pad:document.createElement("div"),padB:document.createElement("div"),padM:document.createElement("div"),sld:document.createElement("div"),sldB:document.createElement("div"),sldM:document.createElement("div")};for(var I=0,L=4;I<jscolor.images.sld[1];I+=L){var G=document.createElement("div");G.style.height=L+"px";G.style.fontSize="1px";G.style.lineHeight="0";jscolor.picker.sld.appendChild(G);}jscolor.picker.sldB.appendChild(jscolor.picker.sld);jscolor.picker.box.appendChild(jscolor.picker.sldB);jscolor.picker.box.appendChild(jscolor.picker.sldM);jscolor.picker.padB.appendChild(jscolor.picker.pad);jscolor.picker.box.appendChild(jscolor.picker.padB);jscolor.picker.box.appendChild(jscolor.picker.padM);jscolor.picker.boxB.appendChild(jscolor.picker.box);}var K=jscolor.picker;q=[F+l.pickerBorder+l.pickerFace+l.pickerInset,M+l.pickerBorder+l.pickerFace+l.pickerInset];z=[null,M+l.pickerBorder+l.pickerFace+l.pickerInset];K.box.onmouseout=function(){C.focus();};K.box.onmousedown=function(){n=true;};window.onmousemove=function(N){c&&w(N);o&&h(N);};window.onmouseup=function(){if(c){c=false;jscolor.fireEvent(a,"change");}if(o){o=false;jscolor.fireEvent(a,"change");}};K.padM.onmousedown=function(N){c=true;w(N);};K.sldM.onmousedown=function(N){o=true;h(N);};K.box.style.width=4*l.pickerInset+2*l.pickerFace+jscolor.images.pad[0]+2*jscolor.images.arrow[0]+jscolor.images.sld[0]+"px";K.box.style.height=2*l.pickerInset+2*l.pickerFace+jscolor.images.pad[1]+"px";K.boxB.style.position="absolute";K.boxB.style.clear="both";K.boxB.style.left=F+"px";K.boxB.style.top=M+"px";K.boxB.style.zIndex=l.pickerZIndex;K.boxB.style.border=l.pickerBorder+"px solid";K.boxB.style.borderColor=l.pickerBorderColor;K.boxB.style.background=l.pickerFaceColor;K.pad.style.width=jscolor.images.pad[0]+"px";K.pad.style.height=jscolor.images.pad[1]+"px";K.padB.style.position="absolute";K.padB.style.left=l.pickerFace+"px";K.padB.style.top=l.pickerFace+"px";K.padB.style.border=l.pickerInset+"px solid";K.padB.style.borderColor=l.pickerInsetColor;K.padM.style.position="absolute";K.padM.style.left="0";K.padM.style.top="0";K.padM.style.width=l.pickerFace+2*l.pickerInset+jscolor.images.pad[0]+jscolor.images.arrow[0]+"px";K.padM.style.height=K.box.style.height;K.padM.style.cursor="crosshair";K.sld.style.overflow="hidden";K.sld.style.width=jscolor.images.sld[0]+"px";K.sld.style.height=jscolor.images.sld[1]+"px";K.sldB.style.position="absolute";K.sldB.style.right=l.pickerFace+"px";K.sldB.style.top=l.pickerFace+"px";K.sldB.style.border=l.pickerInset+"px solid";K.sldB.style.borderColor=l.pickerInsetColor;K.sldM.style.position="absolute";K.sldM.style.right="0";K.sldM.style.top="0";K.sldM.style.width=jscolor.images.sld[0]+jscolor.images.arrow[0]+l.pickerFace+2*l.pickerInset+"px";K.sldM.style.height=K.box.style.height;try{K.sldM.style.cursor="pointer";}catch(H){K.sldM.style.cursor="hand";}switch(b){case 0:var J="hs.png";break;case 1:var J="hv.png";break;}K.padM.style.background="url('"+jscolor.getDir()+"cross.gif') no-repeat";K.sldM.style.background="url('"+jscolor.getDir()+"arrow.gif') no-repeat";K.pad.style.background="url('"+jscolor.getDir()+J+"') 0 0 no-repeat";s();B();jscolor.picker.owner=l;document.getElementsByTagName("body")[0].appendChild(K.boxB);}function s(){switch(b){case 0:var I=1;break;case 1:var I=2;break;}var M=Math.round((l.hsv[0]/6)*(jscolor.images.pad[0]-1));var L=Math.round((1-l.hsv[I])*(jscolor.images.pad[1]-1));jscolor.picker.padM.style.backgroundPosition=(l.pickerFace+l.pickerInset+M-Math.floor(jscolor.images.cross[0]/2))+"px "+(l.pickerFace+l.pickerInset+L-Math.floor(jscolor.images.cross[1]/2))+"px";var F=jscolor.picker.sld.childNodes;switch(b){case 0:var K=g(l.hsv[0],l.hsv[1],1);for(var G=0;G<F.length;G+=1){F[G].style.backgroundColor="rgb("+(K[0]*(1-G/F.length)*100)+"%,"+(K[1]*(1-G/F.length)*100)+"%,"+(K[2]*(1-G/F.length)*100)+"%)";}break;case 1:var K,N,J=[l.hsv[2],0,0];var G=Math.floor(l.hsv[0]);var H=G%2?l.hsv[0]-G:1-(l.hsv[0]-G);switch(G){case 6:case 0:K=[0,1,2];break;case 1:K=[1,0,2];break;case 2:K=[2,0,1];break;case 3:K=[2,1,0];break;case 4:K=[1,2,0];break;case 5:K=[0,2,1];break;}for(var G=0;G<F.length;G+=1){N=1-1/(F.length-1)*G;J[1]=J[0]*(1-N*H);J[2]=J[0]*(1-N);F[G].style.backgroundColor="rgb("+(J[K[0]]*100)+"%,"+(J[K[1]]*100)+"%,"+(J[K[2]]*100)+"%)";}break;}}function B(){switch(b){case 0:var F=2;break;case 1:var F=1;break;}var G=Math.round((1-l.hsv[F])*(jscolor.images.sld[1]-1));jscolor.picker.sldM.style.backgroundPosition="0 "+(l.pickerFace+l.pickerInset+G-Math.floor(jscolor.images.arrow[1]/2))+"px";}function u(){return jscolor.picker&&jscolor.picker.owner===l;}function r(){if(a===C){l.importColor();}if(l.pickerOnfocus){l.hidePicker();}}function m(){if(a!==C){l.importColor();}}function w(G){var I=jscolor.getMousePos(G);var F=I[0]-q[0];var H=I[1]-q[1];switch(b){case 0:l.fromHSV(F*(6/(jscolor.images.pad[0]-1)),1-H/(jscolor.images.pad[1]-1),null,e);break;case 1:l.fromHSV(F*(6/(jscolor.images.pad[0]-1)),null,1-H/(jscolor.images.pad[1]-1),e);break;}}function h(F){var H=jscolor.getMousePos(F);var G=H[1]-q[1];switch(b){case 0:l.fromHSV(null,null,1-G/(jscolor.images.sld[1]-1),v);break;case 1:l.fromHSV(null,1-G/(jscolor.images.sld[1]-1),null,v);break;}}var l=this;var b=this.pickerMode.toLowerCase()==="hvs"?1:0;var n=false;var a=jscolor.fetchElement(this.valueElement),E=jscolor.fetchElement(this.styleElement);var c=false,o=false;var q,z;var x=1<<0,D=1<<1,v=1<<2,e=1<<3;jscolor.addEvent(C,"focus",function(){if(l.pickerOnfocus){l.showPicker();}});jscolor.addEvent(C,"blur",function(){if(!n){window.setTimeout(function(){n||r();n=false;},0);}else{n=false;}});if(a){var A=function(){l.fromString(a.value,x);};jscolor.addEvent(a,"keyup",A);jscolor.addEvent(a,"input",A);jscolor.addEvent(a,"blur",m);a.setAttribute("autocomplete","off");}if(E){E.jscStyle={backgroundColor:E.style.backgroundColor,color:E.style.color};}switch(b){case 0:jscolor.requireImage("hs.png");break;case 1:jscolor.requireImage("hv.png");break;}jscolor.requireImage("cross.gif");jscolor.requireImage("arrow.gif");this.importColor();}};jscolor.install();(function(){var o=document.createElement("input");try{o.type="range";if(o.type=="range"){return;}}catch(m){return;}if(!document.mozSetImageElement||!("MozAppearance" in o.style)){return;}var g;var l=navigator.platform=="MacIntel";var a={radius:l?9:6,width:l?22:12,height:l?16:20};var d="-moz-linear-gradient(top, transparent "+(l?"6px, #999 6px, #999 7px, #ccc 9px, #bbb 11px, #bbb 12px, transparent 12px":"9px, #999 9px, #bbb 10px, #fff 11px, transparent 11px")+", transparent)";var q={"min-width":a.width+"px","min-height":a.height+"px","max-height":a.height+"px",padding:0,border:0,"border-radius":0,cursor:"default","text-indent":"-999999px"};var n=document.createEvent("HTMLEvents");n.initEvent("change",true,false);if(document.readyState=="loading"){document.addEventListener("DOMContentLoaded",h,true);}else{h();}function h(){Array.forEach(document.querySelectorAll("input[type=range]"),f);document.addEventListener("DOMNodeInserted",k,true);}function k(r){c(r.target);if(r.target.querySelectorAll){Array.forEach(r.target.querySelectorAll("input"),c);}}function c(e,r){if(e.localName!="input"||e.type=="range"){}else{if(e.getAttribute("type")=="range"){f(e);}else{if(!r){setTimeout(c,0,e,true);}}}}function f(G){var x,M,w,L,I,J,v;var H,K,z,E,F=G.value;if(!g){g=document.body.appendChild(document.createElement("hr"));b(g,{"-moz-appearance":l?"scale-horizontal":"scalethumb-horizontal",display:"block",visibility:"visible",opacity:1,position:"fixed",top:"-999999px"});document.mozSetImageElement("__sliderthumb__",g);}G.__defineGetter__("value",function(){return""+F;});G.__defineSetter__("value",function(N){F=""+N;x=true;B();});G.__defineGetter__("type",function(){return"range";});["min","max","step"].forEach(function(N){if(G.hasAttribute(N)){M=true;}G.__defineGetter__(N,function(){return this.hasAttribute(N)?this.getAttribute(N):"";});G.__defineSetter__(N,function(O){O===null?this.removeAttribute(N):this.setAttribute(N,O);});});G.readOnly=true;b(G,q);A();G.addEventListener("DOMAttrModified",function(N){if(N.attrName=="value"&&!x){F=N.newValue;B();}else{if(~["min","max","step"].indexOf(N.attrName)){A();M=true;}}},true);G.addEventListener("mousedown",y,true);G.addEventListener("keydown",s,true);G.addEventListener("focus",u,true);G.addEventListener("blur",C,true);function y(P){L=true;setTimeout(function(){L=false;},0);if(P.button||!E){return;}var O=parseFloat(getComputedStyle(this,0).width);var Q=(O-a.width)/E;if(!Q){return;}var N=P.clientX-this.getBoundingClientRect().left-a.width/2-(F-H)*Q;if(Math.abs(N)>a.radius){w=true;this.value-=-N/Q;}J=F;v=P.clientX;this.addEventListener("mousemove",D,true);this.addEventListener("mouseup",r,true);}function D(O){var N=parseFloat(getComputedStyle(this,0).width);var P=(N-a.width)/E;if(!P){return;}J+=(O.clientX-v)/P;v=O.clientX;w=true;this.value=J;}function r(){this.removeEventListener("mousemove",D,true);this.removeEventListener("mouseup",r,true);}function s(N){if(N.keyCode>36&&N.keyCode<41){u.call(this);w=true;this.value=F+(N.keyCode==38||N.keyCode==39?z:-z);}}function u(){if(!L){this.style.boxShadow=!l?"0 0 0 2px #fb0":"0 0 2px 1px -moz-mac-focusring, inset 0 0 1px -moz-mac-focusring";}}function C(){this.style.boxShadow="";}function t(N){return !isNaN(N)&&+N==parseFloat(N);}function A(){H=t(G.min)?+G.min:0;K=t(G.max)?+G.max:100;if(K<H){K=H>100?H:100;}z=t(G.step)&&G.step>0?+G.step:1;E=K-H;B(true);}function e(){if(!x&&!M){F=G.getAttribute("value");}if(!t(F)){F=(H+K)/2;}F=Math.round((F-H)/z)*z+H;if(F<H){F=H;}else{if(F>K){F=H+~~(E/z)*z;}}}function B(P){e();if(w&&F!=I){G.dispatchEvent(n);}w=false;if(!P&&F==I){return;}I=F;var N=E?(F-H)/E*100:0;var O="-moz-element(#__sliderthumb__) "+N+"% no-repeat, ";b(G,{background:O+d});}}function b(e,r){for(var s in r){e.style.setProperty(s,r[s],"important");}}})();var SylvesterModule=(function(){var e={version:"0.1.3",precision:0.000001};function g(){}g.prototype={e:function(l){return(l<1||l>this.elements.length)?null:this.elements[l-1];},dimensions:function(){return this.elements.length;},modulus:function(){return Math.sqrt(this.dot(this));},eql:function(m){var o=this.elements.length;var l=m.elements||m;if(o!=l.length){return false;}do{if(Math.abs(this.elements[o-1]-l[o-1])>e.precision){return false;}}while(--o);return true;},dup:function(){return g.create(this.elements);},map:function(l){var m=[];this.each(function(n,o){m.push(l(n,o));});return g.create(m);},each:function(o){var q=this.elements.length,l=q,m;do{m=l-q;o(this.elements[m],m+1);}while(--q);},toUnitVector:function(){var l=this.modulus();if(l===0){return this.dup();}return this.map(function(m){return m/l;});},angleFrom:function(q){var r=q.elements||q;var o=this.elements.length,s=o,t;if(o!=r.length){return null;}var l=0,v=0,u=0;this.each(function(n,w){l+=n*r[w-1];v+=n*n;u+=r[w-1]*r[w-1];});v=Math.sqrt(v);u=Math.sqrt(u);if(v*u===0){return null;}var m=l/(v*u);if(m<-1){m=-1;}if(m>1){m=1;}return Math.acos(m);},isParallelTo:function(l){var m=this.angleFrom(l);return(m===null)?null:(m<=e.precision);},isAntiparallelTo:function(l){var m=this.angleFrom(l);return(m===null)?null:(Math.abs(m-Math.PI)<=e.precision);},isPerpendicularTo:function(l){var m=this.dot(l);return(m===null)?null:(Math.abs(m)<=e.precision);},add:function(m){var l=m.elements||m;if(this.elements.length!=l.length){return null;}return this.map(function(n,o){return n+l[o-1];});},subtract:function(m){var l=m.elements||m;if(this.elements.length!=l.length){return null;}return this.map(function(n,o){return n-l[o-1];});},multiply:function(l){return this.map(function(m){return m*l;});},x:function(l){return this.multiply(l);},dot:function(m){var l=m.elements||m;var o,q=0,r=this.elements.length;if(r!=l.length){return null;}do{q+=this.elements[r-1]*l[r-1];}while(--r);return q;},cross:function(m){var n=m.elements||m;if(this.elements.length!=3||n.length!=3){return null;}var l=this.elements;return g.create([(l[1]*n[2])-(l[2]*n[1]),(l[2]*n[0])-(l[0]*n[2]),(l[0]*n[1])-(l[1]*n[0])]);},max:function(){var l=0,r=this.elements.length,o=r,q;do{q=o-r;if(Math.abs(this.elements[q])>Math.abs(l)){l=this.elements[q];}}while(--r);return l;},indexOf:function(l){var o=null,r=this.elements.length,m=r,q;do{q=m-r;if(o===null&&this.elements[q]==l){o=q+1;}}while(--r);return o;},toDiagonalMatrix:function(){return a.Diagonal(this.elements);},round:function(){return this.map(function(l){return Math.round(l);});},snapTo:function(l){return this.map(function(m){return(Math.abs(m-l)<=e.precision)?l:m;});},distanceFrom:function(o){if(o.anchor){return o.distanceFrom(this);}var l=o.elements||o;if(l.length!=this.elements.length){return null;}var n=0,m;this.each(function(q,r){m=q-l[r-1];n+=m*m;});return Math.sqrt(n);},liesOn:function(l){return l.contains(this);},liesIn:function(l){return l.contains(this);},rotate:function(n,q){var m,o,l,u,s;switch(this.elements.length){case 2:m=q.elements||q;if(m.length!=2){return null;}o=a.Rotation(n).elements;l=this.elements[0]-m[0];u=this.elements[1]-m[1];return g.create([m[0]+o[0][0]*l+o[0][1]*u,m[1]+o[1][0]*l+o[1][1]*u]);break;case 3:if(!q.direction){return null;}var r=q.pointClosestTo(this).elements;o=a.Rotation(n,q.direction).elements;l=this.elements[0]-r[0];u=this.elements[1]-r[1];s=this.elements[2]-r[2];return g.create([r[0]+o[0][0]*l+o[0][1]*u+o[0][2]*s,r[1]+o[1][0]*l+o[1][1]*u+o[1][2]*s,r[2]+o[2][0]*l+o[2][1]*u+o[2][2]*s]);break;default:return null;}},reflectionIn:function(n){if(n.anchor){var m=this.elements.slice();var o=n.pointClosestTo(m).elements;return g.create([o[0]+(o[0]-m[0]),o[1]+(o[1]-m[1]),o[2]+(o[2]-(m[2]||0))]);}else{var l=n.elements||n;if(this.elements.length!=l.length){return null;}return this.map(function(q,r){return l[r-1]+(l[r-1]-q);});}},to3D:function(){var l=this.dup();switch(l.elements.length){case 3:break;case 2:l.elements.push(0);break;default:return null;}return l;},inspect:function(){return"["+this.elements.join(", ")+"]";},setElements:function(l){this.elements=(l.elements||l).slice();return this;}};g.create=function(m){var l=new g();return l.setElements(m);};g.i=g.create([1,0,0]);g.j=g.create([0,1,0]);g.k=g.create([0,0,1]);g.Random=function(m){var l=[];do{l.push(Math.random());}while(--m);return g.create(l);};g.Zero=function(m){var l=[];do{l.push(0);}while(--m);return g.create(l);};function a(){}a.prototype={e:function(m,l){if(m<1||m>this.elements.length||l<1||l>this.elements[0].length){return null;}return this.elements[m-1][l-1];},row:function(l){if(l>this.elements.length){return null;}return g.create(this.elements[l-1]);},col:function(o){if(o>this.elements[0].length){return null;}var m=[],r=this.elements.length,l=r,q;do{q=l-r;m.push(this.elements[q][o-1]);}while(--r);return g.create(m);},dimensions:function(){return{rows:this.elements.length,cols:this.elements[0].length};},rows:function(){return this.elements.length;},cols:function(){return this.elements[0].length;},eql:function(l){var t=l.elements||l;if(typeof(t[0][0])=="undefined"){t=a.create(t).elements;}if(this.elements.length!=t.length||this.elements[0].length!=t[0].length){return false;}var q=this.elements.length,s=q,o,n,r=this.elements[0].length,m;do{o=s-q;n=r;do{m=r-n;if(Math.abs(this.elements[o][m]-t[o][m])>e.precision){return false;}}while(--n);}while(--q);return true;},dup:function(){return a.create(this.elements);},map:function(r){var q=[],o=this.elements.length,t=o,n,m,s=this.elements[0].length,l;do{n=t-o;m=s;q[n]=[];do{l=s-m;q[n][l]=r(this.elements[n][l],n+1,l+1);}while(--m);}while(--o);return a.create(q);},isSameSizeAs:function(l){var m=l.elements||l;if(typeof(m[0][0])=="undefined"){m=a.create(m).elements;}return(this.elements.length==m.length&&this.elements[0].length==m[0].length);},add:function(l){var m=l.elements||l;if(typeof(m[0][0])=="undefined"){m=a.create(m).elements;}if(!this.isSameSizeAs(m)){return null;}return this.map(function(n,q,o){return n+m[q-1][o-1];});},subtract:function(l){var m=l.elements||l;if(typeof(m[0][0])=="undefined"){m=a.create(m).elements;}if(!this.isSameSizeAs(m)){return null;}return this.map(function(n,q,o){return n-m[q-1][o-1];});},canMultiplyFromLeft:function(l){var m=l.elements||l;if(typeof(m[0][0])=="undefined"){m=a.create(m).elements;}return(this.elements[0].length==m.length);},multiply:function(z){if(!z.elements){return this.map(function(A){return A*z;});}var s=z.modulus?true:false;var w=z.elements||z;if(typeof(w[0][0])=="undefined"){w=a.create(w).elements;}if(!this.canMultiplyFromLeft(w)){return null;}var o=this.elements.length,q=o,u,m,n=w[0].length,r;var y=this.elements[0].length,l=[],v,t,x;do{u=q-o;l[u]=[];m=n;do{r=n-m;v=0;t=y;do{x=y-t;v+=this.elements[u][x]*w[x][r];}while(--t);l[u][r]=v;}while(--m);}while(--o);var w=a.create(l);return s?w.col(1):w;},x:function(l){return this.multiply(l);},minor:function(v,u,s,r){var l=[],n=s,q,m,o;var w=this.elements.length,t=this.elements[0].length;do{q=s-n;l[q]=[];m=r;do{o=r-m;l[q][o]=this.elements[(v+q-1)%w][(u+o-1)%t];}while(--m);}while(--n);return a.create(l);},transpose:function(){var r=this.elements.length,s=this.elements[0].length;var q=[],o=s,n,m,l;do{n=s-o;q[n]=[];m=r;do{l=r-m;q[n][l]=this.elements[l][n];}while(--m);}while(--o);return a.create(q);},isSquare:function(){return(this.elements.length==this.elements[0].length);},max:function(){var l=0,r=this.elements.length,t=r,q,o,s=this.elements[0].length,n;do{q=t-r;o=s;do{n=s-o;if(Math.abs(this.elements[q][n])>Math.abs(l)){l=this.elements[q][n];}}while(--o);}while(--r);return l;},indexOf:function(l){var o=null,r=this.elements.length,t=r,q,n,s=this.elements[0].length,m;do{q=t-r;n=s;do{m=s-n;if(this.elements[q][m]==l){return{i:q+1,j:m+1};}}while(--n);}while(--r);return null;},diagonal:function(){if(!this.isSquare){return null;}var o=[],q=this.elements.length,l=q,m;do{m=l-q;o.push(this.elements[m][m]);}while(--q);return g.create(o);},toRightTriangular:function(){var s=this.dup(),q;var m=this.elements.length,o=m,r,t,u=this.elements[0].length,l;do{r=o-m;if(s.elements[r][r]==0){for(j=r+1;j<o;j++){if(s.elements[j][r]!=0){q=[];t=u;do{l=u-t;q.push(s.elements[r][l]+s.elements[j][l]);}while(--t);s.elements[r]=q;break;}}}if(s.elements[r][r]!=0){for(j=r+1;j<o;j++){var v=s.elements[j][r]/s.elements[r][r];q=[];t=u;do{l=u-t;q.push(l<=r?0:s.elements[j][l]-s.elements[r][l]*v);}while(--t);s.elements[j]=q;}}}while(--m);return s;},toUpperTriangular:function(){return this.toRightTriangular();},determinant:function(){if(!this.isSquare()){return null;}var r=this.toRightTriangular();var o=r.elements[0][0],q=r.elements.length-1,l=q,m;do{m=l-q+1;o=o*r.elements[m][m];}while(--q);return o;},det:function(){return this.determinant();},isSingular:function(){return(this.isSquare()&&this.determinant()===0);},trace:function(){if(!this.isSquare()){return null;}var o=this.elements[0][0],q=this.elements.length-1,l=q,m;do{m=l-q+1;o+=this.elements[m][m];}while(--q);return o;},tr:function(){return this.trace();},rank:function(){var t=this.toRightTriangular(),s=0;var o=this.elements.length,r=o,n,m,q=this.elements[0].length,l;do{n=r-o;m=q;do{l=q-m;if(Math.abs(t.elements[n][l])>e.precision){s++;break;}}while(--m);}while(--o);return s;},rk:function(){return this.rank();},augment:function(v){var t=v.elements||v;if(typeof(t[0][0])=="undefined"){t=a.create(t).elements;}var q=this.dup(),u=q.elements[0].length;var n=q.elements.length,o=n,s,l,m=t[0].length,r;if(n!=t.length){return null;}do{s=o-n;l=m;do{r=m-l;q.elements[s][u+r]=t[s][r];}while(--l);}while(--n);return q;},inverse:function(){if(!this.isSquare()||this.isSingular()){return null;}var n=this.elements.length,o=n,t,s;var u=this.augment(a.I(n)).toRightTriangular();var v,w=u.elements[0].length,l,r,m;var x=[],q;do{t=n-1;r=[];v=w;x[t]=[];m=u.elements[t][t];do{l=w-v;q=u.elements[t][l]/m;r.push(q);if(l>=o){x[t].push(q);}}while(--v);u.elements[t]=r;for(s=0;s<t;s++){r=[];v=w;do{l=w-v;r.push(u.elements[s][l]-u.elements[t][l]*u.elements[s][t]);}while(--v);u.elements[s]=r;}}while(--n);return a.create(x);},inv:function(){return this.inverse();},round:function(){return this.map(function(l){return Math.round(l);});},snapTo:function(l){return this.map(function(m){return(Math.abs(m-l)<=e.precision)?l:m;});},inspect:function(){var o=[];var q=this.elements.length,l=q,m;do{m=l-q;o.push(g.create(this.elements[m]).inspect());}while(--q);return o.join("\n");},setElements:function(u){var w,l=u.elements||u;if(typeof(l[0][0])!="undefined"){var q=l.length,s=q,m,o,v;this.elements=[];do{w=s-q;m=l[w].length;o=m;this.elements[w]=[];do{v=o-m;this.elements[w][v]=l[w][v];}while(--m);}while(--q);return this;}var r=l.length,t=r;this.elements=[];do{w=t-r;this.elements.push([l[w]]);}while(--r);return this;}};a.create=function(l){var m=new a();return m.setElements(l);};a.I=function(s){var r=[],l=s,q,o,m;do{q=l-s;r[q]=[];o=l;do{m=l-o;r[q][m]=(q==m)?1:0;}while(--o);}while(--s);return a.create(r);};a.Diagonal=function(o){var r=o.length,l=r,m;var q=a.I(r);do{m=l-r;q.elements[m][m]=o[m];}while(--r);return q;};a.Rotation=function(l,u){if(!u){return a.create([[Math.cos(l),-Math.sin(l)],[Math.sin(l),Math.cos(l)]]);}var m=u.dup();if(m.elements.length!=3){return null;}var r=m.modulus();var v=m.elements[0]/r,q=m.elements[1]/r,o=m.elements[2]/r;var A=Math.sin(l),n=Math.cos(l),w=1-n;return a.create([[w*v*v+n,w*v*q-A*o,w*v*o+A*q],[w*v*q+A*o,w*q*q+n,w*q*o-A*v],[w*v*o-A*q,w*q*o+A*v,w*o*o+n]]);};a.RotationX=function(l){var n=Math.cos(l),m=Math.sin(l);return a.create([[1,0,0],[0,n,-m],[0,m,n]]);};a.RotationY=function(l){var n=Math.cos(l),m=Math.sin(l);return a.create([[n,0,m],[0,1,0],[-m,0,n]]);};a.RotationZ=function(l){var n=Math.cos(l),m=Math.sin(l);return a.create([[n,-m,0],[m,n,0],[0,0,1]]);};a.Random=function(o,l){return a.Zero(o,l).map(function(){return Math.random();});};a.Zero=function(u,l){var t=[],s=u,r,q,o;do{r=u-s;t[r]=[];q=l;do{o=l-q;t[r][o]=0;}while(--q);}while(--s);return a.create(t);};function f(){}f.prototype={eql:function(l){return(this.isParallelTo(l)&&this.contains(l.anchor));},dup:function(){return f.create(this.anchor,this.direction);},translate:function(m){var l=m.elements||m;return f.create([this.anchor.elements[0]+l[0],this.anchor.elements[1]+l[1],this.anchor.elements[2]+(l[2]||0)],this.direction);},isParallelTo:function(m){if(m.normal){return m.isParallelTo(this);}var l=this.direction.angleFrom(m.direction);return(Math.abs(l)<=e.precision||Math.abs(l-Math.PI)<=e.precision);},distanceFrom:function(q){if(q.normal){return q.distanceFrom(this);}if(q.direction){if(this.isParallelTo(q)){return this.distanceFrom(q.anchor);}var u=this.direction.cross(q.direction).toUnitVector().elements;var n=this.anchor.elements,m=q.anchor.elements;return Math.abs((n[0]-m[0])*u[0]+(n[1]-m[1])*u[1]+(n[2]-m[2])*u[2]);}else{var r=q.elements||q;var n=this.anchor.elements,l=this.direction.elements;var x=r[0]-n[0],v=r[1]-n[1],s=(r[2]||0)-n[2];var w=Math.sqrt(x*x+v*v+s*s);if(w===0){return 0;}var t=(x*l[0]+v*l[1]+s*l[2])/w;var o=1-t*t;return Math.abs(w*Math.sqrt(o<0?0:o));}},contains:function(l){var m=this.distanceFrom(l);return(m!==null&&m<=e.precision);},liesIn:function(l){return l.contains(this);},intersects:function(l){if(l.normal){return l.intersects(this);}return(!this.isParallelTo(l)&&this.distanceFrom(l)<=e.precision);},intersectionWith:function(x){if(x.normal){return x.intersectionWith(this);}if(!this.intersects(x)){return null;}var v=this.anchor.elements,m=this.direction.elements,u=x.anchor.elements,l=x.direction.elements;var F=m[0],E=m[1],D=m[2],t=l[0],s=l[1],q=l[2];var B=v[0]-u[0],A=v[1]-u[1],z=v[2]-u[2];var w=-F*B-E*A-D*z;var o=t*B+s*A+q*z;var r=F*F+E*E+D*D;var C=t*t+s*s+q*q;var n=F*t+E*s+D*q;var y=(w*C/r+n*o)/(C-n*n);return g.create([v[0]+y*F,v[1]+y*E,v[2]+y*D]);},pointClosestTo:function(H){if(H.direction){if(this.intersects(H)){return this.intersectionWith(H);}if(this.isParallelTo(H)){return null;}var J=this.direction.elements,I=H.direction.elements;var r=J[0],q=J[1],n=J[2],F=I[0],B=I[1],v=I[2];var G=(n*F-r*v),C=(r*B-q*F),w=(q*v-n*B);var u=g.create([G*v-C*B,C*F-w*v,w*B-G*F]);var t=d.create(H.anchor,u);return t.intersectionWith(this);}else{var t=H.elements||H;if(this.contains(t)){return g.create(t);}var K=this.anchor.elements,J=this.direction.elements;var r=J[0],q=J[1],n=J[2],o=K[0],m=K[1],l=K[2];var G=r*(t[1]-m)-q*(t[0]-o),C=q*((t[2]||0)-l)-n*(t[1]-m),w=n*(t[0]-o)-r*((t[2]||0)-l);var s=g.create([q*G-n*w,n*C-r*G,r*w-q*C]);var L=this.distanceFrom(t)/s.modulus();return g.create([t[0]+s.elements[0]*L,t[1]+s.elements[1]*L,(t[2]||0)+s.elements[2]*L]);}},rotate:function(G,H){if(typeof(H.direction)=="undefined"){H=f.create(H.to3D(),g.k);}var s=a.Rotation(G,H.direction).elements;var m=H.pointClosestTo(this.anchor).elements;var o=this.anchor.elements,l=this.direction.elements;var w=m[0],v=m[1],u=m[2],r=o[0],q=o[1],n=o[2];var F=r-w,E=q-v,B=n-u;return f.create([w+s[0][0]*F+s[0][1]*E+s[0][2]*B,v+s[1][0]*F+s[1][1]*E+s[1][2]*B,u+s[2][0]*F+s[2][1]*E+s[2][2]*B],[s[0][0]*l[0]+s[0][1]*l[1]+s[0][2]*l[2],s[1][0]*l[0]+s[1][1]*l[1]+s[1][2]*l[2],s[2][0]*l[0]+s[2][1]*l[1]+s[2][2]*l[2]]);},reflectionIn:function(y){if(y.normal){var r=this.anchor.elements,m=this.direction.elements;var v=r[0],t=r[1],q=r[2],s=m[0],o=m[1],n=m[2];var l=this.anchor.reflectionIn(y).elements;var x=v+s,w=t+o,u=q+n;var z=y.pointClosestTo([x,w,u]).elements;var C=[z[0]+(z[0]-x)-l[0],z[1]+(z[1]-w)-l[1],z[2]+(z[2]-u)-l[2]];return f.create(l,C);}else{if(y.direction){return this.rotate(Math.PI,y);}else{var B=y.elements||y;return f.create(this.anchor.reflectionIn([B[0],B[1],(B[2]||0)]),this.direction);}}},setVectors:function(l,n){l=g.create(l);n=g.create(n);if(l.elements.length==2){l.elements.push(0);}if(n.elements.length==2){n.elements.push(0);}if(l.elements.length>3||n.elements.length>3){return null;}var m=n.modulus();if(m===0){return null;}this.anchor=l;this.direction=g.create([n.elements[0]/m,n.elements[1]/m,n.elements[2]/m]);return this;}};f.create=function(m,n){var l=new f();return l.setVectors(m,n);};f.X=f.create(g.Zero(3),g.i);f.Y=f.create(g.Zero(3),g.j);f.Z=f.create(g.Zero(3),g.k);function d(){}d.prototype={eql:function(l){return(this.contains(l.anchor)&&this.isParallelTo(l));},dup:function(){return d.create(this.anchor,this.normal);},translate:function(m){var l=m.elements||m;return d.create([this.anchor.elements[0]+l[0],this.anchor.elements[1]+l[1],this.anchor.elements[2]+(l[2]||0)],this.normal);},isParallelTo:function(m){var l;if(m.normal){l=this.normal.angleFrom(m.normal);return(Math.abs(l)<=e.precision||Math.abs(Math.PI-l)<=e.precision);}else{if(m.direction){return this.normal.isPerpendicularTo(m.direction);}}return null;},isPerpendicularTo:function(l){var m=this.normal.angleFrom(l.normal);return(Math.abs(Math.PI/2-m)<=e.precision);},distanceFrom:function(n){if(this.intersects(n)||this.contains(n)){return 0;}if(n.anchor){var l=this.anchor.elements,q=n.anchor.elements,o=this.normal.elements;return Math.abs((l[0]-q[0])*o[0]+(l[1]-q[1])*o[1]+(l[2]-q[2])*o[2]);}else{var m=n.elements||n;var l=this.anchor.elements,o=this.normal.elements;return Math.abs((l[0]-m[0])*o[0]+(l[1]-m[1])*o[1]+(l[2]-(m[2]||0))*o[2]);}},contains:function(o){if(o.normal){return null;}if(o.direction){return(this.contains(o.anchor)&&this.contains(o.anchor.add(o.direction)));}else{var m=o.elements||o;var l=this.anchor.elements,q=this.normal.elements;var n=Math.abs(q[0]*(l[0]-m[0])+q[1]*(l[1]-m[1])+q[2]*(l[2]-(m[2]||0)));return(n<=e.precision);}},intersects:function(l){if(typeof(l.direction)=="undefined"&&typeof(l.normal)=="undefined"){return null;}return !this.isParallelTo(l);},intersectionWith:function(u){if(!this.intersects(u)){return null;}if(u.direction){var o=u.anchor.elements,l=u.direction.elements,v=this.anchor.elements,z=this.normal.elements;var G=(z[0]*(v[0]-o[0])+z[1]*(v[1]-o[1])+z[2]*(v[2]-o[2]))/(z[0]*l[0]+z[1]*l[1]+z[2]*l[2]);return g.create([o[0]+l[0]*G,o[1]+l[1]*G,o[2]+l[2]*G]);}else{if(u.normal){var F=this.normal.cross(u.normal).toUnitVector();var z=this.normal.elements,o=this.anchor.elements,w=u.normal.elements,n=u.anchor.elements;var H=a.Zero(2,2),t=0;while(H.isSingular()){t++;H=a.create([[z[t%3],z[(t+1)%3]],[w[t%3],w[(t+1)%3]]]);}var r=H.inverse().elements;var E=z[0]*o[0]+z[1]*o[1]+z[2]*o[2];var C=w[0]*n[0]+w[1]*n[1]+w[2]*n[2];var m=[r[0][0]*E+r[0][1]*C,r[1][0]*E+r[1][1]*C];var s=[];for(var q=1;q<=3;q++){s.push((t==q)?0:m[(q+(5-t)%3)%3]);}return f.create(s,F);}}},pointClosestTo:function(m){var o=m.elements||m;var l=this.anchor.elements,q=this.normal.elements;var n=(l[0]-o[0])*q[0]+(l[1]-o[1])*q[1]+(l[2]-(o[2]||0))*q[2];return g.create([o[0]+q[0]*n,o[1]+q[1]*n,(o[2]||0)+q[2]*n]);},rotate:function(F,G){var r=a.Rotation(F,G.direction).elements;var l=G.pointClosestTo(this.anchor).elements;var n=this.anchor.elements,w=this.normal.elements;var v=l[0],u=l[1],s=l[2],q=n[0],o=n[1],m=n[2];var E=q-v,D=o-u,B=m-s;return d.create([v+r[0][0]*E+r[0][1]*D+r[0][2]*B,u+r[1][0]*E+r[1][1]*D+r[1][2]*B,s+r[2][0]*E+r[2][1]*D+r[2][2]*B],[r[0][0]*w[0]+r[0][1]*w[1]+r[0][2]*w[2],r[1][0]*w[0]+r[1][1]*w[1]+r[1][2]*w[2],r[2][0]*w[0]+r[2][1]*w[1]+r[2][2]*w[2]]);},reflectionIn:function(r){if(r.normal){var n=this.anchor.elements,v=this.normal.elements;var q=n[0],o=n[1],m=n[2],y=v[0],x=v[1],w=v[2];var l=this.anchor.reflectionIn(r).elements;var C=q+y,B=o+x,z=m+w;var t=r.pointClosestTo([C,B,z]).elements;var s=[t[0]+(t[0]-C)-l[0],t[1]+(t[1]-B)-l[1],t[2]+(t[2]-z)-l[2]];return d.create(l,s);}else{if(r.direction){return this.rotate(Math.PI,r);}else{var u=r.elements||r;return d.create(this.anchor.reflectionIn([u[0],u[1],(u[2]||0)]),this.normal);}}},setVectors:function(u,z,y){u=g.create(u);u=u.to3D();if(u===null){return null;}z=g.create(z);z=z.to3D();if(z===null){return null;}if(typeof(y)=="undefined"){y=null;}else{y=g.create(y);y=y.to3D();if(y===null){return null;}}var r=u.elements[0],q=u.elements[1],o=u.elements[2];var v=z.elements[0],t=z.elements[1],s=z.elements[2];var w,x;if(y!==null){var n=y.elements[0],m=y.elements[1],l=y.elements[2];w=g.create([(t-q)*(l-o)-(s-o)*(m-q),(s-o)*(n-r)-(v-r)*(l-o),(v-r)*(m-q)-(t-q)*(n-r)]);x=w.modulus();if(x===0){return null;}w=g.create([w.elements[0]/x,w.elements[1]/x,w.elements[2]/x]);}else{x=Math.sqrt(v*v+t*t+s*s);if(x===0){return null;}w=g.create([z.elements[0]/x,z.elements[1]/x,z.elements[2]/x]);}this.anchor=u;this.normal=w;return this;}};d.create=function(l,o,n){var m=new d();return m.setVectors(l,o,n);};d.XY=d.create(g.Zero(3),g.k);d.YZ=d.create(g.Zero(3),g.i);d.ZX=d.create(g.Zero(3),g.j);d.YX=d.XY;d.ZY=d.YZ;d.XZ=d.ZX;var h=g.create;var b=a.create;var c=f.create;var k=d.create;return{Sylvester:e,Matrix:a,Line:f,Plane:d};})();var Dbug={log:function(a){console.log(a);},logCoords:function(){var b="";for(i=0;i<arguments.length;i++){var a=arguments[i];b+=a===null?"(null) ":a+" ";}Dbug.log(b);}};Function.prototype.bindTo=function(b){var a=this;return function(){return a.apply(b,arguments);};};Array.prototype.peek=function(){return this[this.length-1];};Array.prototype.clone=function(){return this.slice(0);};Array.prototype.equals=function(b){return this.length==b.length&&this.every(function(c,a){return c===b[a];});};Array.prototype.isSubsetOf=function(b){return this.every(function(a){return b.indexOf(a)!=-1;});};var sin=Math.sin;var cos=Math.cos;var tan=Math.tan;var atan=Math.atan;var quarterPi=Math.PI/4;var halfPi=Math.PI/2;var pi=Math.PI;var threeHalfPi=Math.PI*1.5;var twoPi=Math.PI*2;var Util={extend:function(a,c){function b(){}b.prototype=c.prototype;a.prototype=new b();a.prototype.constructor=a;a.baseConstructor=c;a.superclass=c.prototype;},assert:function(b,a){if(!b){throw a;}},getClientY:function(a){var b=0;do{b+=a.offsetTop;}while((a=a.offsetParent));return b;},getClientX:function(b){var a=0;do{a+=b.offsetLeft;}while((b=b.offsetParent));return a;},hasChild:function(a,b){return b?(b.compareDocumentPosition(a)&Node.DOCUMENT_POSITION_CONTAINS?true:false):false;},firstNonTextChild:function(a){if(a.firstChild){return(a.firstChild.nodeType!=8&&a.firstChild.nodeType!=3)?a.firstChild:Util.nextNonTextSibling(a.firstChild);}else{return null;}},nextNonTextSibling:function(a){var b=a.nextSibling;while(b!=null&&(b.nodeType==8||b.nodeType==3)){b=b.nextSibling;}return b;},replaceElement:function(a,c){var b=a.parentNode;b.insertBefore(c,a);b.removeChild(a);},addHtmlClass:function(a,b){var c=new RegExp("(^|\\s)"+b+"($|\\s)","i");if(!a.className.match(c)){a.className+=" "+b;}},removeHtmlClass:function(a,b){var c=new RegExp("(^|\\s)"+b,"i");a.className=a.className.replace(c,"");},utf8_to_b64:function(a){return window.btoa(unescape(encodeURIComponent(a)));},b64_to_utf8:function(a){return decodeURIComponent(escape(window.atob(a)));},rgbToHex:function(b){var a=b.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);return a?"#"+a.slice(1).map(function(c){return parseInt(c).toString(16);}).join(""):b;},parseValue:function(c){var b=typeof c;var e;var a="";Util.assert(b=="number"||b=="string","Invalid, non-alphanumeric argument passed to Util::parseValue");if(b=="number"){e=c;}else{if(b=="string"){var d=c.match(/^\s*(-?[0-9]+(\.[0-9]+)?)\s*([^\s\-0-9]+)?\s*$|^\s*(-?)(([^\s\-0-9]+)\s*)?([0-9]+(\.[0-9]+)?)\s*$/);Util.assert(d!==null,"Util::parseValue found malformed quantity, or ambiguous units in string '"+c+"'");e=parseFloat(d[1]?d[1]:d[4]+d[7]);a=d[3]?d[3]:d[6];}}return{quantity:e,units:a};},roundToMultiple:function(a,b){return Math.round(a/b)*b;},roundToDecimal:function(a,c){var b=Math.pow(10,c);return Math.round(a*b)/b;},floorToDecimal:function(a,c){var b=Math.pow(10,c);return Math.floor(a*b)/b;},minMax:function(b,c,a){return Math.max(c,Math.min(a,b));},radToDeg:function(b){return(b/pi)*180;},degToRad:function(b){return(b/180)*pi;},angleIsBetweenAngles:function(f,d,c){if(c<d){var e=d;d=c;c=e;}f%=twoPi;d%=twoPi;c%=twoPi;if(d<0){d+=twoPi;c+=twoPi;}if(c<d){c+=twoPi;}if(f<0){f+=twoPi;}return Util.between(f,d,c)||Util.between(f+twoPi,d,c);},angleRelativeTo:function(d,c){return(d<c?d+twoPi-c:d-c);},sign:function(a){return a>0?1:(a<0?-1:0);},equals:function(a,c,b){b=b!==undefined?b:Alberti.tolerance;return a>=c-b&&a<=c+b;},between:function(a,d,c,b){b=b!==undefined?b:Alberti.tolerance;return(a<=Math.max(d,c)+b)&&(a>=Math.min(d,c)-b);}};var KeyCode={shift:16,ctrl:17,alt:18,esc:27,del:46,backspace:8,enter:13,arrowUp:38,arrowDown:40,number1:49,number2:50,number3:51,number4:52,number5:53,number6:54,number7:55,number8:56,number9:57,backStep:192,modParallel:76,modPerpendicular:80,modPinning:83,lpCollapse:220,snap:68,autoPan:32,manPan:69,undoRedo:90,cut:88,paste:86,selectAll:65,newDoc:78,save:83,load:79,};function SpatialHash(a){this.buckets={};this.bucketWidth=a;this.halfBucketWidth=a/2;this.bucketCount=0;this.nodeCount=0;this.fastLookup={};}SpatialHash.prototype.search=function(c,m){Util.assert(m<=this.halfBucketWidth,"Radius passed to SpatialHash::search must be no larger than half the bucket width.");var o=Util.roundToMultiple(c.x,this.bucketWidth);var n=Util.roundToMultiple(c.y,this.bucketWidth);var f=[this.buckets[o+","+n]];var s=c.x-o;var r=c.y-n;var l=Math.abs(s)+m>=this.halfBucketWidth?o+(Util.sign(s)*this.bucketWidth):null;var k=Math.abs(r)+m>=this.halfBucketWidth?n+(Util.sign(r)*this.bucketWidth):null;if(l!==null){f.push(this.buckets[l+","+n]);if(k!==null){f.push(this.buckets[l+","+k]);}}if(k!==null){f.push(this.buckets[o+","+k]);}var b=[];for(var h=0,q=f.length;h<q;h++){var d=f[h];if(d){for(var g=0,a=d.nodes.length;g<a;g++){var e=d.nodes[g];if(Math.abs(e.x-c.x)<=m&&Math.abs(e.y-c.y)<=m){b.push(e.clone());}}}}return b;};SpatialHash.prototype.insert=function(f){var b=this.getLookupIndex(f);var c=this.fastLookup[b];if(!c){this.nodeCount++;var a=this.getBucketIndex(f);var e=this.buckets[a];var d;if(!e){this.bucketCount++;this.buckets[a]={nodes:[f],dirty:false};d=0;}else{e.nodes.push(f);d=e.nodes.length-1;}this.fastLookup[b]={count:1,bucketIndex:a,nodeIndex:d};}else{c.count++;}};SpatialHash.prototype.remove=function(m){for(var g=0,l=m.length;g<l;g++){var h=m[g];var q=this.getLookupIndex(h);var o=this.fastLookup[q];if(o){if(--o.count==0){this.nodeCount--;var b=this.buckets[o.bucketIndex];b.nodes[o.nodeIndex]=null;b.dirty=true;delete this.fastLookup[q];}}}for(var n in this.buckets){var b=this.buckets[n];if(b.dirty){var f=[];var d=0;for(var e=0,a=b.nodes.length;e<a;e++){var c=b.nodes[e];if(c){f.push(c);this.fastLookup[this.getLookupIndex(c)].nodeIndex=d++;}}b.nodes=f;b.dirty=false;if(b.nodes.length==0){this.bucketCount--;delete this.buckets[n];}}}};SpatialHash.prototype.getBucketIndex=function(a){return(Util.roundToMultiple(a.x,this.bucketWidth)+","+Util.roundToMultiple(a.y,this.bucketWidth));};SpatialHash.prototype.getLookupIndex=function(a){return Util.roundToDecimal(a.x,3)+","+Util.roundToDecimal(a.y,3);};function Delegate(b){this.delegatedObject=b;this.delegationEnabled=true;Util.assert(!Array.isArray(b),"Creating Delegates for Array objects is not supported.");var c=[];var a=[];for(var d in this.delegatedObject){Util.assert(this[d]===undefined||d=="toString","Delegated object has property '"+d+"' with same name as internal property.");(typeof this.delegatedObject[d]=="function"?a:c).push(d);}c.forEach(function(f){var e=function(){return this.delegatedObject[f];};var g=function(h){this.delegatedObject[f]=h;};if(Object.defineProperty){Object.defineProperty(this,f,{get:e,set:g});}else{this.__defineGetter__(f,e);this.__defineSetter__(f,g);}},this);a.forEach(function(e){this[e]=function(){return this.delegatedObject[e].apply(this,arguments);};},this);}Delegate.prototype.enableDelegation=function(){this.delegationEnabled=true;};Delegate.prototype.disableDelegation=function(){this.delegationEnabled=false;};Delegate.prototype.mapMethod=function(a,c,b){Util.assert(this.delegatedObject[a]!==undefined,"Delegated object does not contain method name passed to Delegate::mapMethod.");this[a]=function(){if(this.delegationEnabled){if(c){this[c].apply(this,arguments);}var d=this.delegatedObject[a].apply(this,arguments);if(b){this[b].apply(this,arguments);}}else{var d=this.delegatedObject[a].apply(this,arguments);}return d;};};Animation.fpsMax=70;function Animation(a,b,c){this.length=a;this.endCallback=typeof b=="function"?b:null;this.perFrameCallback=typeof c=="function"?c:null;this.intervalId=null;this.tweenList=[];this.stepDelta=1/Animation.fpsMax;}Animation.prototype.add=function(c,b,d,a,e){this.tweenList.push(new AnimatedProperty(c,b,this.length,d,a,e));};Animation.prototype.begin=function(){if(this.intervalId===null){this.prepare();this.startTime=Date.now();this.intervalId=window.setInterval(this.run.bindTo(this),this.stepDelta*1000);}};Animation.prototype.stop=function(a){if(this.intervalId!==null){window.clearInterval(this.intervalId);this.intervalId=null;if(a&&this.endCallback){this.endCallback();}}};Animation.prototype.prepare=function(){var b=this.tweenList.length;for(var a=0;a<b;a++){this.tweenList[a].stepTo(0);}};Animation.prototype.forceUpdate=function(){this.run();};Animation.prototype.run=function(){var a=(Date.now()-this.startTime)/1000;if(a>this.length){a=this.length;}var c=this.tweenList.length;for(var b=0;b<c;b++){this.tweenList[b].stepTo(a);}if(this.perFrameCallback){this.perFrameCallback();}if(a>=this.length){this.stop(true);}};function AnimatedProperty(k,g,b,d,e,c){if(typeof c=="number"&&(c>1||c<-1)){throw"AnimatedProperty: acceleration must be within the range [-1.0:1.0]";}this.targetObject=k;this.targetProperty=g;this.setTargetProperty=typeof this.targetObject[g]=="function"?this.setFunctionProperty:this.setScalarProperty;var h=Util.parseValue(d);this.units=h.units;this.initValue=h.quantity;this.endValue=Util.parseValue(e).quantity;var f=Math.pow(b,2);var a=(this.endValue-this.initValue)/f;this.acceleration=a*(typeof c=="number"?c:0);this.initVelocity=(this.endValue-this.initValue-this.acceleration*f)/b;}AnimatedProperty.prototype.stepTo=function(a){this.setTargetProperty(Util.roundToDecimal(this.acceleration*Math.pow(a,2)+this.initVelocity*a+this.initValue,10)+(this.units===""?0:this.units));};AnimatedProperty.prototype.setScalarProperty=function(a){this.targetObject[this.targetProperty]=a;};AnimatedProperty.prototype.setFunctionProperty=function(a){this.targetObject[this.targetProperty](a);};function ClipBoard(){this.shapes=[];}ClipBoard.prototype.copy=function(b){if(b.length>0){this.shapes=[];for(var c=0,a=b.length;c<a;c++){this.shapes.push(b[c].clone());}}};ClipBoard.prototype.isEmpty=function(){return this.shapes.length==0;};ClipBoard.prototype.paste=function(c){for(var b=0,a=this.shapes.length;b<a;b++){c.insertShape(this.shapes[b].clone().generate());}};ClipBoard.prototype.clear=function(){this.shapes=[];};AlbertiDocument.exportTypeSvg="svg";AlbertiDocument.exportTypePng="png";function AlbertiDocument(b){this.workspaceGroup=null;this.undoManager=null;this.layerManager=null;this.underlayImage=new FastImage(document.getElementById("underlayimg"));this.filename=null;this.underlayImage.setSource("images/dummy.png");this.underlayImage.hide();if(b){this.importFromXML(b);}else{this.createEmptyDocument();}var a=document.getElementById("underlayimg");}AlbertiDocument.prototype.connectDelegates=function(b,a){this.layerManager=b;this.layerManager.undoManager=a;this.undoManager=a;};AlbertiDocument.prototype.createEmptyDocument=function(){this.workspaceGroup=new Group().generate().set("id","workspace");this.undoManager=new UndoManager(Alberti.maxUndos);this.layerManager=new LayerManager(this.workspaceGroup,this.undoManager);this.layerManager.newLayer();this.undoManager.enable();};AlbertiDocument.prototype.importFromXML=function(a){var d=new DOMParser();var c=d.parseFromString(a,"text/xml");Util.assert(c.documentElement.tagName!="parsererror","AlbertiDocument::importFromXML could not parse imported file.");if(Alberti.serializeUnderlayImages){var b=c.getElementById("underlayimg");Util.assert(b.hasAttributeNS(Alberti.xlinkns,"href")&&b.hasAttributeNS(null,"opacity"),"AlbertiDocument::importFromXML encountered malformed underlay image element.");this.underlayImage.setSource(b.getAttributeNS(Alberti.xlinkns,"href"));this.underlayImage.opacity=b.getAttributeNS(null,"opacity");if(b.getAttributeNS(null,"display")=="none"){this.underlayImage.hide();}else{this.underlayImage.show();}this.underlayImage.update();}this.workspaceGroup=new Group(c.getElementById("workspace"));this.undoManager=new UndoManager(Alberti.maxUndos);this.layerManager=new LayerManager(this.workspaceGroup,this.undoManager);this.loadLayers();this.undoManager.enable();};AlbertiDocument.prototype.setFilename=function(a){this.filename=a;};AlbertiDocument.prototype.loadLayers=function(){var a=Util.firstNonTextChild(this.workspaceGroup.svgNode);while(a!=null){Util.assert(a.nodeName=="g","AlbertiDocument::loadLayers encountered node of type '"+a.nodeName+"' when 'g' node expected.");var d=new Layer(a);this.layerManager.insertLayer(d);var c=Util.firstNonTextChild(a);while(c!=null){var b;switch(c.nodeName){case"line":b=new Line(c);break;case"path":switch(c.getAttributeNS(Alberti.customns,"type")){case"carc":b=new CircleArc(c);break;case"earc":b=new EllipticalArc(c);break;case"bezier":b=new Bezier(c);break;default:throw"AlbertiDocument::loadLayers encountered path node with missing Alberti type.";break;}break;case"circle":b=new Circle(c);break;case"ellipse":b=new Ellipse(c);break;case"use":b=new Point(c);break;default:throw"AlbertiDocument::loadLayers encountered unrecognized shape node of type '"+c.nodeName+"'.";break;}c=Util.nextNonTextSibling(c);b.sanitize();this.layerManager.insertShape(b);}a=Util.nextNonTextSibling(a);}this.layerManager.switchToHighestVisibleLayer();};AlbertiDocument.prototype.asXML=function(){this.layerManager.serializeAll();var b=[];var a=this.workspaceGroup.svgNode.getBBox();b[0]="<svg\n";b[0]+='	width="'+a.width+'"\n';b[0]+='	height="'+a.height+'"\n';b[0]+='	viewBox="'+a.x+" "+a.y+" "+a.width+" "+a.height+'"\n';b[0]+='	xmlns="http://www.w3.org/2000/svg" version="1.1"\n';b[0]+='	xmlns:xlink="http://www.w3.org/1999/xlink"\n';b[0]+='	xmlns:berti="'+Alberti.customns+'"\n';b[0]+='  fill="none"\n';b[0]+='  berti:version="'+Alberti.version+'">\n';b[0]+="<title>"+(this.filename?this.filename:"Alberti Document")+"</title>\n";if(Alberti.serializeUnderlayImages){b[0]+='<image id="underlayimg" xlink:href="';b[1]=this.underlayImage.imgNode.src;b[2]='" ';b[2]+='opacity="'+this.underlayImage.opacity+'" ';b[2]+=this.underlayImage.isHidden()?'display="none"':"";b[2]+="/>\n";}b[3]=new XMLSerializer().serializeToString(this.workspaceGroup.svgNode).replace(/xmlns:[^=]+="[^"]+"/g,"");b[4]="\n";b[4]+="</svg>\n";return b.join("");};AlbertiDocument.prototype.cleanup=function(){this.underlayImage.killAllListeners();};Alberti.version="0.1.0";Alberti.svgns="http://www.w3.org/2000/svg";Alberti.xlinkns="http://www.w3.org/1999/xlink";Alberti.customns="http://www.albertidraw.com/alberti";Alberti.svgRoot;function Alberti(){if(!Alberti.nonScalingLinesHack){document.styleSheets[0].cssRules[1].style.setProperty("vector-effect","non-scaling-stroke","");}this.clipBoard=new ClipBoard();Alberti.svgRoot=document.getElementById("svgroot");this.ui=new UserInterface(this.clipBoard,this,"handleNewDocument","handleSaveDocument","handleOpenDocument");this.loadDocument(new AlbertiDocument());document.getElementById("version").innerHTML="v"+Alberti.version;document.getElementById("content").style.display="";}Alberti.prototype.handleNewDocument=function(){var a=new AlbertiDocument();this.loadDocument(a);};Alberti.prototype.handleSaveDocument=function(a){switch(a){case AlbertiDocument.exportTypeSvg:default:var b=Util.utf8_to_b64(this.doc.asXML());var c="data:image/svg+xml;base64,"+b;if(Alberti.usePhpSaveScript){}else{window.open(c);}this.doc.undoManager.setCleanState();break;}};Alberti.prototype.handleOpenDocument=function(c,b){var a=new AlbertiDocument(c);a.setFilename(b);this.loadDocument(a);};Alberti.prototype.loadDocument=function(a){var b=document.getElementById("workspace");Util.replaceElement(b,a.workspaceGroup.svgNode);this.ui.prepareForDocument(a);if(this.doc){this.doc.cleanup();}this.doc=a;};Alberti.fpsMax=Animation.fpsMax;Alberti.refreshms=Math.round(1000/Alberti.fpsMax);Alberti.showToolTips=true;Alberti.snapRadius=20;Alberti.selectionPickRadius=2.5;Alberti.maxUndos=100;Alberti.tolerance=1e-8;Alberti.halfOriginalWindowWidth=Math.round(window.innerWidth/2);Alberti.halfOriginalWindowHeight=Math.round(window.innerHeight/2);Alberti.optimizedClassName="optimized";Alberti.crispLines=false;Alberti.defaultLineWidth=1;Alberti.lineWidthDeltaOptimized=0.01;Alberti.nonScalingLinesHack=true;Alberti.usePhpSaveScript=false;Alberti.serializeUnderlayImages=false;albertiApp=null;function main(){albertiApp=new Alberti();}function Coord2D(a,b){if(arguments.length>0){this.x=a;this.y=b;}}Coord2D.prototype.clone=function(){return new Coord2D(this.x,this.y);};Coord2D.prototype.isEqual=function(a){return(Util.equals(this.x,a.x)&&Util.equals(this.y,a.y));};Coord2D.prototype.angleToRelative=function(e,d){var c=Util.angleRelativeTo(this.angleTo(e),d);return c;};Coord2D.prototype.angleTo=function(e){var d=e.x-this.x;var c=0;if(!Util.equals(d,0)){var b=(e.y-this.y)/d;c=atan(b);if(e.x<this.x){c+=pi;}else{if(e.y<this.y){c+=twoPi;}}}else{c=e.y>this.y?halfPi:threeHalfPi;}return c;};Coord2D.prototype.distanceTo=function(b){var a=b.x-this.x;var c=b.y-this.y;return Math.sqrt(a*a+c*c);};Coord2D.convexHull=function(d){var e=d.clone().sort(function(h,g){return h.x<g.x?-1:(h.x>g.x?1:(h.y<g.y?-1:1));});var b=[],a=[];var f=e.length;for(var c=0;c<f;c++){while(a.length>=2&&Coord2D.threePointsClockDirection(a[a.length-2],a[a.length-1],e[c])!=-1){a.pop();}a.push(e[c]);}for(var c=f-1;c>=0;c--){while(b.length>=2&&Coord2D.threePointsClockDirection(b[b.length-2],b[b.length-1],e[c])!=-1){b.pop();}b.push(e[c]);}a.pop();b.pop();return a.concat(b);};Coord2D.threePointsClockDirection=function(c,b,a){return Util.sign((b.x-c.x)*(a.y-c.y)-(b.y-c.y)*(a.x-c.x));};Coord2D.prototype.toString=function(){return this.x+","+this.y;};function Rect2D(d,c,b,a){if(arguments.length>3){this.left=d;this.top=c;this.right=b;this.bottom=a;}}Rect2D.prototype.clone=function(){var a=new Rect2D();a.left=this.left;a.top=this.top;a.right=this.right;a.bottom=this.bottom;return a;};Rect2D.fromPoints=function(b,a){return new Rect2D(Math.min(b.x,a.x),Math.min(b.y,a.y),Math.max(b.x,a.x),Math.max(b.y,a.y));};Rect2D.prototype.intersectsRect=function(a){return !(a.left>this.right||a.right<this.left||a.top>this.bottom||a.bottom<this.top);};Rect2D.prototype.enclosesRect=function(a){return this.left<a.left&&this.right>a.right&&this.top<a.top&&this.bottom>a.bottom;};Rect2D.prototype.toString=function(){return"("+this.left+", "+this.top+", "+this.right+", "+this.bottom+")";};EventHandler.numListeners=0;EventHandler.escKeyRepeatRate=150;function EventHandler(){this.lastMouseMove=Date.now();this.lastEscapeKeydown=Date.now();this.listeners=[];}EventHandler.prototype.registerListener=function(b,c,a){if(this.getListenerIndex(b,c,a)==-1){EventHandler.numListeners++;this.listeners.push({type:b,target:c,useCapture:a});if(c.addEventListener){c.addEventListener(b,this,a);}else{c["on"+b]=this[b].bindTo(this);}}};EventHandler.prototype.unregisterListener=function(c,d,a){var b=this.getListenerIndex(c,d,a);if(b>-1){EventHandler.numListeners--;this.listeners.splice(b,1);if(d.removeEventListener){d.removeEventListener(c,this,a);}else{delete d["on"+c];}}};EventHandler.prototype.killAllListeners=function(){for(var b=0,a=this.listeners.length;b<a;b++){EventHandler.numListeners--;var c=this.listeners[b];c.target.removeEventListener(c.type,this,c.useCapture);}this.listeners=[];};EventHandler.prototype.getListenerIndex=function(d,e,b){for(var c=0,a=this.listeners.length;c<a;c++){var f=this.listeners[c];if(d==f.type&&e==f.target&&b==f.useCapture){return c;}}return -1;};EventHandler.prototype.handleEvent=function(a){switch(a.type){case"mousemove":if(Date.now()-this.lastMouseMove<Alberti.refreshms){return;}else{this.lastMouseMove=Date.now();}break;case"mouseover":case"mouseout":if(a.relatedTarget==a.currentTarget||Util.hasChild(a.currentTarget,a.relatedTarget)){return;}break;case"keydown":if(a.ctrlKey||a.metaKey){return;}if(a.keyCode==KeyCode.esc){if(Date.now()-this.lastEscapeKeydown<EventHandler.escKeyRepeatRate){return;}else{this.lastEscapeKeydown=Date.now();}}break;case"click":if(a.detail==0){return;}break;}this[a.type](a);};function DragHandler(a){DragHandler.baseConstructor.call(this);this.lastX=0;this.lastY=0;this.startX=0;this.startY=0;this.currentlyDragging=false;this.dragThreshold=(a!==undefined)?a:0;}Util.extend(DragHandler,EventHandler);DragHandler.prototype.cancelDrag=function(a){if(this.currentlyDragging){this.currentlyDragging=false;this.onDrop(a);}this.unregisterListener("mousemove",window,true);this.unregisterListener("mouseup",window,true);};DragHandler.prototype.mousedown=function(a){this.lastX=this.startX=a.clientX;this.lastY=this.startY=a.clientY;this.registerListener("mousemove",window,true);this.registerListener("mouseup",window,true);};DragHandler.prototype.mousemove=function(a){if(!this.currentlyDragging){if(Math.abs(a.clientX-this.startX)>this.dragThreshold||Math.abs(a.clientY-this.startY)>this.dragThreshold){this.currentlyDragging=true;this.onDragBegin(a);}}else{this.onDrag(a.clientX-this.lastX,a.clientY-this.lastY,a);}this.lastX=a.clientX;this.lastY=a.clientY;};DragHandler.prototype.mouseup=function(a){this.cancelDrag(a);};DragHandler.prototype.onDragBegin=function(a){};DragHandler.prototype.onDrag=function(c,b,a){this.cancelDrag(a);throw"Abstract method DragHandler::onDrag not implemented by inheriting class!";};DragHandler.prototype.onDrop=function(a){};TransformHandler.snapRecalcFreq=Math.min(20,Alberti.fpsMax);TransformHandler.recalcms=Math.round(1000/TransformHandler.snapRecalcFreq);function TransformHandler(a,c,b){TransformHandler.baseConstructor.call(this);this.masterGroup=a;this.layerManager=c;this.overlayGroup=b;this.currentSnapPoint=null;this.excludeSnapPoint=null;this.lastSnapUpdate=0;this.snappingEnabled=false;this.snapGuide=null;this.lastMouseX=null;this.lastMouseY=null;}Util.extend(TransformHandler,EventHandler);TransformHandler.prototype.getLastMousePosition=function(){return new Coord2D(this.lastMouseX,this.lastMouseY);};TransformHandler.prototype.getCurrentSnapPoint=function(){return this.currentSnapPoint?this.currentSnapPoint.clone():null;};TransformHandler.prototype.localToGlobal=function(b,a){return new Coord2D((b-Alberti.halfOriginalWindowWidth-this.masterGroup.position.x)/this.masterGroup.scale,(a-Alberti.halfOriginalWindowHeight-this.masterGroup.position.y)/this.masterGroup.scale);};TransformHandler.prototype.snap=function(a){if(this.snappingEnabled&&a.x!==null){if(Date.now()-this.lastSnapUpdate>=TransformHandler.recalcms){this.lastSnapUpdate=Date.now();newCoord=this.layerManager.snapPoints.getNearestNeighbor(a,this.excludeSnapPoint);this.currentSnapPoint=newCoord;if(newCoord){a.x=newCoord.x;a.y=newCoord.y;if(!this.snapGuide){this.snapGuide=new Point().generate();this.snapGuide.innerColor="none";this.snapGuide.set("opacity","0.65");}else{this.snapGuide.detach();}this.overlayGroup.attachChild(this.snapGuide);this.snapGuide.coord.x=a.x;this.snapGuide.coord.y=a.y;this.snapGuide.push();}else{if(this.snapGuide){this.snapGuide.detach();this.snapGuide=null;}}}else{if(this.currentSnapPoint){a.x=this.currentSnapPoint.x;a.y=this.currentSnapPoint.y;}}}};TransformHandler.prototype.enableSnapping=function(){if(!this.snappingEnabled){this.snappingEnabled=true;var a=new Coord2D(this.lastMouseX,this.lastMouseY);this.snap(a);this.onMouseMove(a.x,a.y);}};TransformHandler.prototype.disableSnapping=function(){if(this.snappingEnabled){this.snappingEnabled=false;if(this.snapGuide){this.snapGuide.detach();this.snapGuide=null;this.currentSnapPoint=null;}var a=new Coord2D(this.lastMouseX,this.lastMouseY);this.snap(a);this.onMouseMove(a.x,a.y);}};TransformHandler.prototype.mousedown=function(a){var b=this.localToGlobal(a.clientX,a.clientY);if(this.lastMouseX===null){this.lastMouseX=b.x;this.lastMouseY=b.y;}this.snap(b);this.onMouseDown(b.x,b.y,a);};TransformHandler.prototype.mouseup=function(a){var b=this.localToGlobal(a.clientX,a.clientY);this.snap(b);this.onMouseUp(b.x,b.y,a);};TransformHandler.prototype.mousemove=function(a){var b=this.localToGlobal(a.clientX,a.clientY);this.lastMouseX=b.x;this.lastMouseY=b.y;this.snap(b);this.onMouseMove(b.x,b.y,a);};TransformHandler.prototype.onMouseDown=function(c,b,a){};TransformHandler.prototype.onMouseUp=function(c,b,a){};TransformHandler.prototype.onMouseMove=function(c,b,a){};function FastImage(a){FastImage.baseConstructor.call(this);this.imgNode=a;this.x=0;this.y=0;this.scale=1;this.opacity=a.style.opacity!==""?parseFloat(a.style.opacity):1;this.hidden=a.style.display=="none"?true:false;this.updateOffset();this.registerListener("load",this.imgNode,false);}Util.extend(FastImage,EventHandler);FastImage.prototype.setSource=function(a){this.imgNode.src=a;};FastImage.prototype.setSourceToDataUrl=function(a){Util.assert(a.match(/^data:/),"Invalid data URL passed to AlbertiDocument::setUnderlayImage");this.setSource(a);};FastImage.prototype.isHidden=function(){return this.hidden;};FastImage.prototype.hide=function(){if(!this.hidden){this.hidden=true;this.imgNode.style.display="none";}};FastImage.prototype.show=function(){if(this.hidden){this.hidden=false;this.imgNode.style.display="";}};FastImage.prototype.update=function(){var a=Math.round(this.x+this.adjustx)+"px, "+Math.round(this.y+this.adjusty)+"px";this.imgNode.style.cssText="-webkit-transform: translate3d("+a+", 0) scale3d("+this.scale+", "+this.scale+", 1); -moz-transform: translate("+a+") scale("+this.scale+"); -o-transform: translate("+a+") scale("+this.scale+"); "+(this.opacity!=1?"opacity: "+this.opacity+"; ":"")+(this.hidden?"display: none":"");};FastImage.prototype.updateOffset=function(){this.adjustx=Alberti.halfOriginalWindowWidth-this.imgNode.width/2;this.adjusty=Alberti.halfOriginalWindowHeight-this.imgNode.height/2;};FastImage.prototype.translateRelative=function(b,a){this.x+=b;this.y+=a;};FastImage.prototype.load=function(a){this.updateOffset();this.update();};AutoScale.scale=0;AutoScale.lineWidth=1;AutoScale.dashArray=2;function AutoScale(){this.shapes=[];this.styles=[];this.lineWidthAdjustment=0;}AutoScale.prototype.registerObject=function(a,d,e){for(var c=0,b=this.shapes.length;c<b;c++){if(this.shapes[c]["shape"]===a){return;}}this.shapes.push({shape:a,"default":e,flag:d});};AutoScale.prototype.unregisterObject=function(a){for(var c=0,b=this.shapes.length;c<b;c++){if(this.shapes[c]["shape"]===a){this.shapes.splice(c,1);break;}}};AutoScale.prototype.registerStyle=function(c,d,e){for(var b=0,a=this.styles.length;b<a;b++){if(this.styles[b]["style"]===c){return;}}this.styles.push({style:c,"default":e,flag:d});};AutoScale.prototype.unregisterStyle=function(c){for(var b=0,a=this.styles.length;b<a;b++){if(this.styles[b]["shape"]===c){this.styles.splice(b,1);break;}}};AutoScale.prototype.update=function(d){for(var b=0,a=this.shapes.length;b<a;b++){switch(this.shapes[b]["flag"]){case AutoScale.scale:this.shapes[b]["shape"].set("transform","scale("+(this.shapes[b]["default"]/d)+")");break;case AutoScale.lineWidth:this.shapes[b]["shape"].set("stroke-width",Util.floorToDecimal((this.shapes[b]["default"]+this.lineWidthAdjustment)/d,3));break;}}for(var b=0,a=this.styles.length;b<a;b++){switch(this.styles[b]["flag"]){case AutoScale.dashArray:var c=Util.floorToDecimal(this.styles[b]["default"]/d,3);this.styles[b]["style"].setProperty("stroke-dasharray",c+","+c,"");break;}}};AutoScale.prototype.setLineWidthAdjustment=function(a){this.lineWidthAdjustment=a;};Zap.zoomFactors=[1/10,1/8,1/5,1/3,1/2,3/4,1,1.5,2,3,4,6,8,10];Zap.minZoomLevel=Zap.zoomFactors.indexOf(1/5);Zap.maxZoomLevel=Zap.zoomFactors.indexOf(4);Zap.defaultZoomLevel=Zap.zoomFactors.indexOf(1/2);Zap.autoPanTransitionLength=0.35;Zap.zoomTransitionLength=0.25;Zap.zoomTransitionAccel=-1;Zap.maxWheelEvtPerSec=30;Zap.wheelEvtRefreshMs=Math.round(1000/Zap.maxWheelEvtPerSec);function Zap(a,c,e,b,d){Zap.baseConstructor.call(this);this.masterGroup=a;this.autoScale=c;this.layerManager=e;this.underlayImage=b;this.toolTip=d;this.panningEnabled=false;this.zoomLevel=Zap.defaultZoomLevel;this.zapAnimation=null;this.center();this.autoScale.update(Zap.zoomFactors[this.zoomLevel]);this.layerManager.snapPoints.setSnapRadiusScale(Zap.zoomFactors[this.zoomLevel]);this.masterGroup.scale=Zap.zoomFactors[this.zoomLevel];this.masterGroup.push();this.updateUnderlayImage();this.lastPanPosition=new Coord2D(0,0);this.lastWheelEvent=0;this.registerListener("mousewheel",Alberti.svgRoot,false);this.registerListener("DOMMouseScroll",Alberti.svgRoot,false);}Util.extend(Zap,DragHandler);Zap.prototype.handleWheel=function(c,a){var b=Util.minMax(this.zoomLevel+c,Zap.minZoomLevel,Zap.maxZoomLevel);if(b!=this.zoomLevel){this.zoomRelative(b,a.clientX,a.clientY);this.updateMagnificationTooltip(Zap.zoomFactors[b]);}};Zap.prototype.zoomRelative=function(f,b,g){this.zoomLevel=f;this.stopZoomTransition();this.enableZoomPanOptimization();var e=Zap.zoomFactors[this.zoomLevel];var d=e/this.masterGroup.scale-1;var c=this.masterGroup.position.x+(this.masterGroup.position.x-b+Alberti.halfOriginalWindowWidth)*d;var a=this.masterGroup.position.y+(this.masterGroup.position.y-g+Alberti.halfOriginalWindowHeight)*d;this.zapAnimation=new Animation(Zap.zoomTransitionLength,function(){this.zapAnimation=null;this.layerManager.resetCurrentMarker();if(!this.panningEnabled){this.disableZoomPanOptimization();}}.bindTo(this),function(){this.autoScale.update(this.masterGroup.scale);this.layerManager.snapPoints.setSnapRadiusScale(this.masterGroup.scale);this.masterGroup.push();this.lastPanPosition.x=-this.masterGroup.position.x/e;this.lastPanPosition.y=-this.masterGroup.position.y/e;this.underlayImage.update();}.bindTo(this));this.zapAnimation.add(this.masterGroup,"scale",this.masterGroup.scale,Zap.zoomFactors[this.zoomLevel],Zap.zoomTransitionAccel);this.zapAnimation.add(this.masterGroup.position,"x",this.masterGroup.position.x,c,Zap.zoomTransitionAccel);this.zapAnimation.add(this.masterGroup.position,"y",this.masterGroup.position.y,a,Zap.zoomTransitionAccel);this.zapAnimation.add(this.underlayImage,"scale",this.masterGroup.scale,Zap.zoomFactors[this.zoomLevel],Zap.zoomTransitionAccel);this.zapAnimation.add(this.underlayImage,"x",this.masterGroup.position.x,c,Zap.zoomTransitionAccel);this.zapAnimation.add(this.underlayImage,"y",this.masterGroup.position.y,a,Zap.zoomTransitionAccel);this.zapAnimation.begin();};Zap.prototype.panTo=function(c,a){this.stopZoomTransition();this.enableZoomPanOptimization();if(a){this.lastPanPosition=c;this.layerManager.resetCurrentMarker();}this.zapAnimation=new Animation(Zap.autoPanTransitionLength,function(){this.zapAnimation=null;if(!this.panningEnabled){this.disableZoomPanOptimization();}}.bindTo(this),!this.underlayImage.isHidden()?function(){this.masterGroup.push();this.underlayImage.update();}.bindTo(this):function(){this.masterGroup.push();}.bindTo(this));var b=Zap.zoomFactors[this.zoomLevel];this.zapAnimation.add(this.masterGroup.position,"x",this.masterGroup.position.x,-c.x*b,Zap.zoomTransitionAccel);this.zapAnimation.add(this.masterGroup.position,"y",this.masterGroup.position.y,-c.y*b,Zap.zoomTransitionAccel);if(!this.underlayImage.isHidden()){this.zapAnimation.add(this.underlayImage,"x",this.underlayImage.x,-c.x*b,Zap.zoomTransitionAccel);this.zapAnimation.add(this.underlayImage,"y",this.underlayImage.y,-c.y*b,Zap.zoomTransitionAccel);}this.zapAnimation.begin();};Zap.prototype.getLastPanPosition=function(){return this.lastPanPosition.clone();};Zap.prototype.stopZoomTransition=function(){if(this.zapAnimation!==null){this.zapAnimation.forceUpdate();if(this.zapAnimation){this.zapAnimation.stop(false);this.zapAnimation=null;}}};Zap.prototype.updateUnderlayImage=function(){this.underlayImage.scale=Zap.zoomFactors[this.zoomLevel];this.underlayImage.x=this.masterGroup.position.x;this.underlayImage.y=this.masterGroup.position.y;this.underlayImage.update();};Zap.prototype.updateMagnificationTooltip=function(a){this.toolTip.setText("Magnification: "+Util.roundToDecimal((a*100),1)+"%",true,true);};Zap.prototype.mousewheel=function(a){if(Date.now()-this.lastWheelEvent>=Zap.wheelEvtRefreshMs){this.lastWheelEvent=Date.now();a.preventDefault();this.handleWheel(Util.minMax(a.wheelDelta,-1,1),a);}};Zap.prototype.DOMMouseScroll=function(a){if(Date.now()-this.lastWheelEvent>=Zap.wheelEvtRefreshMs){this.lastWheelEvent=Date.now();a.preventDefault();if(typeof a.axis===undefined||a.VERTICAL_AXIS){this.handleWheel(-Util.minMax(a.detail,-1,1),a);}}};Zap.prototype.center=function(){this.masterGroup.position.x=this.masterGroup.position.y=0;this.masterGroup.push();};Zap.prototype.enablePanning=function(){if(!this.panningEnabled){this.panningEnabled=true;this.registerListener("mousedown",Alberti.svgRoot,true);this.enableZoomPanOptimization();}};Zap.prototype.disablePanning=function(){if(this.panningEnabled){this.panningEnabled=false;this.unregisterListener("mousedown",Alberti.svgRoot,true);this.disableZoomPanOptimization();this.cancelDrag();}};Zap.prototype.enableZoomPanOptimization=function(){this.autoScale.setLineWidthAdjustment(Alberti.lineWidthDeltaOptimized);this.autoScale.update(this.masterGroup.scale);if(!Alberti.crispLines){this.masterGroup.set("class",Alberti.optimizedClassName);}};Zap.prototype.disableZoomPanOptimization=function(){this.autoScale.setLineWidthAdjustment(0);this.autoScale.update(this.masterGroup.scale);if(!Alberti.crispLines){this.masterGroup.set("class","");}};Zap.prototype.onDragBegin=function(a){a.stopPropagation();this.stopZoomTransition();};Zap.prototype.onDrag=function(c,b,a){this.masterGroup.translateRelative(c,b);this.masterGroup.push();var d=Zap.zoomFactors[this.zoomLevel];this.lastPanPosition.x=-this.masterGroup.position.x/d;this.lastPanPosition.y=-this.masterGroup.position.y/d;if(!this.underlayImage.isHidden()){this.underlayImage.translateRelative(c,b);this.underlayImage.update();}};Zap.prototype.onDrop=function(a){this.layerManager.resetCurrentMarker();};function SvgObject(a){if(typeof a=="string"){Util.assert(a!=="","Invalid SVG tag string passed to SvgObject constructor.");this.svgNode=null;this.svgTag=a;this.initialize();}else{this.svgNode=a;this.svgTag=this.svgNode.nodeName;this.pull();}}SvgObject.prototype.set=function(a,c,b){if((c===""||c===null)){this.svgNode.removeAttributeNS(arguments.length>2?b:null,a);}else{this.svgNode.setAttributeNS(arguments.length>2?b:null,a,c);}return this;};SvgObject.prototype.get=function(a,b){var c=this.svgNode.getAttributeNS(arguments.length>1?b:null,a);var d=parseFloat(c);return !isNaN(d)?d:c;};SvgObject.prototype.attach=function(a){if(this.svgNode.parentNode===null){this.push();a.appendChild(this.svgNode);}};SvgObject.prototype.attachAfter=function(a,b){if(this.svgNode.parentNode===null){this.push();a.insertBefore(this.svgNode,b.nextSibling);}};SvgObject.prototype.attachBefore=function(a,b){if(this.svgNode.parentNode===null){this.push();a.insertBefore(this.svgNode,b);}};SvgObject.prototype.detach=function(){if(this.svgNode.parentNode!==null){this.svgNode.parentNode.removeChild(this.svgNode);}return this;};SvgObject.prototype.generate=function(){if(!this.svgNode){this.svgNode=document.createElementNS(Alberti.svgns,this.svgTag);}return this;};SvgObject.prototype.initialize=function(){};SvgObject.prototype.push=function(){};SvgObject.prototype.pull=function(){};SvgObject.prototype.sanitize=function(){if(this.svgNode&&this.svgNode.parentNode){var b=this.svgNode.parentNode;var a=this.svgNode.nextSibling;this.detach();this.svgNode=null;this.generate();this.attachBefore(b,a);}};function SvgContainer(a){SvgContainer.baseConstructor.call(this,a);}Util.extend(SvgContainer,SvgObject);SvgContainer.prototype.attachChild=function(a){a.attach(this.svgNode);};SvgContainer.prototype.attachChildAfter=function(b,a){b.attachAfter(this.svgNode,a.svgNode);};SvgContainer.prototype.attachChildBefore=function(a,b){a.attachBefore(this.svgNode,b.svgNode);};Group.elementTag="g";function Group(a){Group.baseConstructor.call(this,a?a:Group.elementTag);}Util.extend(Group,SvgContainer);Group.prototype.initialize=function(){this.position=new Coord2D(0,0);this.scale=1;};Group.prototype.translateRelative=function(b,a){this.position.x+=b;this.position.y+=a;};Group.prototype.positionAbsolute=function(a,b){this.position.x=a;this.position.y=b;};Group.prototype.scaleAbsolute=function(a){this.scale=a;};Group.prototype.push=function(){this.set("transform",(this.position.x!=0||this.position.y!=0?"translate("+this.position.x+","+this.position.y+")":"")+(this.scale!=1?" scale("+this.scale+")":""));};Group.prototype.pull=function(){var a=this.get("transform");var c=null;var b=null;if(a){c=a.match(/translate\((.+),(.+)\)/);b=a.match(/scale\((.+)\)/);}this.position=c?new Coord2D(c[1],c[2]):new Coord2D(0,0);this.scale=b?b[1]:1;};Text.elementTag="text";function Text(a){Text.baseConstructor.call(this,a?a:Text.elementTag);}Util.extend(Text,SvgObject);Text.prototype.initialize=function(){this.anchor=new Coord2D();this.fontFamily="";this.fontStyle="";this.fontSize="";this.textData="";this.justification="";this.textNode=null;};Text.prototype.generate=function(){Text.superclass.generate.call(this);this.textNode=document.createTextNode(this.textData);this.svgNode.appendChild(this.textNode);return this;};Text.prototype.push=function(){this.set("x",this.anchor.x);this.set("y",this.anchor.y);this.set("font-family",this.fontFamily);this.set("font-style",this.fontStyle);this.set("font-size",this.fontSize);this.set("text-anchor",this.justification);this.textNode.data=this.textData;};Shape.sidCounter=1;function Shape(b,a){Shape.baseConstructor.call(this,b);this.shapeName=a;this.sid="s"+(Shape.sidCounter++);}Util.extend(Shape,SvgObject);Shape.prototype.serialize=function(){};Shape.prototype.getBoundingBox=function(){var a=this.svgNode.getBBox();return new Rect2D(a.x,a.y,a.x+a.width,a.y+a.height);};Shape.prototype.displaySelected=function(){this.set("class","selected");};Shape.prototype.displayDeselected=function(){this.set("class","");};Shape.prototype.clone=function(a){throw"Un-overriden 'clone' method invoked on Shape "+this.shapeName;};Point.elementTag="use";Point.shapeName="point";Point.templateId="point_template";Point.selectedTemplateId="point_template_sel";function Point(a){Point.baseConstructor.call(this,a?a:Point.elementTag,Point.shapeName);}Util.extend(Point,Shape);Point.prototype.initialize=function(){this.coord=new Coord2D(0,0);this.innerColor="black";this.outerColor="";};Point.prototype.generate=function(){Point.superclass.generate.call(this);this.set("xlink:href","#"+Point.templateId,Alberti.xlinkns);return this;};Point.fromCoord=function(b){var a=new Point();a.coord.x=b.x;a.coord.y=b.y;return a;};Point.prototype.push=function(){this.set("x",this.coord.x);this.set("y",this.coord.y);this.set("fill",this.innerColor);this.set("stroke",this.outerColor);};Point.prototype.pull=function(){this.coord=new Coord2D(this.get("x"),this.get("y"));this.innerColor=this.get("fill");this.outerColor=this.get("stroke");};Point.prototype.clone=function(){var a=new Point();a.coord=this.coord.clone();a.innerColor=this.innerColor;a.outerColor=this.outerColor;return a;};Point.prototype.displaySelected=function(){this.set("xlink:href","#"+Point.selectedTemplateId,Alberti.xlinkns);};Point.prototype.displayDeselected=function(){this.set("xlink:href","#"+Point.templateId,Alberti.xlinkns);};Point.prototype.getBoundingBox=function(){return new Rect2D(this.coord.x-0.1,this.coord.y-0.1,this.coord.x+0.1,this.coord.y+0.1);};Line.elementTag="line";Line.shapeName="line";function Line(a){Line.baseConstructor.call(this,a?a:Line.elementTag,Line.shapeName);}Util.extend(Line,Shape);Line.prototype.initialize=function(){this.p1=new Coord2D(0,0);this.p2=new Coord2D(0,0);};Line.prototype.push=function(){this.set("x1",this.p1.x);this.set("y1",this.p1.y);this.set("x2",this.p2.x);this.set("y2",this.p2.y);};Line.prototype.pull=function(){this.p1=new Coord2D(this.get("x1"),this.get("y1"));this.p2=new Coord2D(this.get("x2"),this.get("y2"));};Line.fromPoints=function(c,b){var a=new Line();a.p1.x=c.x;a.p1.y=c.y;a.p2.x=b.x;a.p2.y=b.y;return a;};Line.prototype.clone=function(){var a=new Line();a.p1=this.p1.clone();a.p2=this.p2.clone();return a;};Line.prototype.getProjectedPoint=function(f){var b=this.p2.x-this.p1.x;var a=this.p2.y-this.p1.y;var c=a/b;if(Util.equals(b,0)){return new Coord2D(this.p1.x,f.y);}else{if(Util.equals(a,0)){return new Coord2D(f.x,this.p1.y);}else{m2=-b/a;b1=this.p1.y-c*this.p1.x;b2=f.y-m2*f.x;var d=(b1-b2)/(m2-c);var e=m2*d+b2;return new Coord2D(d,e);}}};Line.prototype.extendToInfinity=function(){var b=new Line();var d=10000/this.getLength();var e=this.getMidpoint();var c=e.x-this.p1.x;var a=e.y-this.p1.y;b.p1.x=e.x-d*c;b.p1.y=e.y-d*a;b.p2.x=e.x+d*c;b.p2.y=e.y+d*a;return b;};Line.prototype.getLength=function(){return this.p1.distanceTo(this.p2);};Line.prototype.getSlope=function(){return(this.p2.y-this.p1.y)/(this.p2.x-this.p1.x);};Line.prototype.getMidpoint=function(){return new Coord2D((this.p1.x+this.p2.x)/2,(this.p1.y+this.p2.y)/2);};Line.prototype.getAngleRelative=function(b){return this.p1.angleToRelative(this.p2,b);};Line.prototype.getAngle=function(){return this.p1.angleTo(this.p2);};Line.prototype.setAngle=function(b){var c=this.getLength();this.p2.x=this.p1.x+c*cos(b);this.p2.y=this.p1.y+c*sin(b);return this;};Line.prototype.setLength=function(b){var a=b/this.getLength();this.p2.x=this.p1.x+(this.p2.x-this.p1.x)*a;this.p2.y=this.p1.y+(this.p2.y-this.p1.y)*a;return this;};Rectangle.elementTag="rect";Rectangle.shapeName="rect";function Rectangle(a){Rectangle.baseConstructor.call(this,a?a:Rectangle.elementTag,Rectangle.shapeName);}Util.extend(Rectangle,Shape);Rectangle.prototype.initialize=function(){this.rect=new Rect2D(0,0,0,0);};Rectangle.prototype.push=function(){this.set("x",this.rect.left);this.set("y",this.rect.top);this.set("width",this.rect.right-this.rect.left);this.set("height",this.rect.bottom-this.rect.top);};Rectangle.fromRect2D=function(b){var a=new Rectangle();a.rect.left=b.left;a.rect.top=b.top;a.rect.right=b.right;a.rect.bottom=b.bottom;return a;};Rectangle.prototype.clone=function(){var a=new Rectangle();a.rect=this.rect.clone();return a;};Circle.elementTag="circle";Circle.shapeName="circle";function Circle(a){Circle.baseConstructor.call(this,a?a:Circle.elementTag,Circle.shapeName);}Util.extend(Circle,Shape);Circle.prototype.initialize=function(){this.center=new Coord2D(0,0);this.radius=0;};Circle.prototype.push=function(){this.set("cx",this.center.x);this.set("cy",this.center.y);this.set("r",this.radius);};Circle.prototype.pull=function(){this.center=new Coord2D(this.get("cx"),this.get("cy"));this.radius=this.get("r");};Circle.prototype.clone=function(){var a=new Circle();a.center=this.center.clone();a.radius=this.radius;return a;};CircleArc.elementTag="path";CircleArc.shapeName="carc";function CircleArc(a){CircleArc.baseConstructor.call(this,a?a:CircleArc.elementTag,CircleArc.shapeName);}Util.extend(CircleArc,Shape);CircleArc.prototype.initialize=function(){this.center=new Coord2D(0,0);this.radius=0;this.sa=0;this.da=0;};CircleArc.prototype.push=function(){var b=this.sa+this.da;var a=new Coord2D(this.center.x+this.radius*cos(this.sa),this.center.y+this.radius*sin(this.sa));var e=new Coord2D(this.center.x+this.radius*cos(b),this.center.y+this.radius*sin(b));var c=Math.abs(this.da)>pi?1:0;var d=this.da>0?1:0;this.set("d","M"+a.x+","+a.y+" A"+this.radius+","+this.radius+", 0, "+c+","+d+", "+e.x+","+e.y);};CircleArc.prototype.serialize=function(){this.set("berti:cx",this.center.x,Alberti.customns);this.set("berti:cy",this.center.y,Alberti.customns);this.set("berti:r",this.radius,Alberti.customns);this.set("berti:sa",this.sa,Alberti.customns);this.set("berti:da",this.da,Alberti.customns);this.set("berti:type",CircleArc.shapeName,Alberti.customns);};CircleArc.prototype.pull=function(){this.center=new Coord2D(this.get("cx",Alberti.customns),this.get("cy",Alberti.customns));this.radius=this.get("r",Alberti.customns);this.sa=this.get("sa",Alberti.customns);this.da=this.get("da",Alberti.customns);};CircleArc.prototype.clone=function(){var a=new CircleArc();a.center=this.center.clone();a.radius=this.radius;a.sa=this.sa;a.da=this.da;return a;};function EllipticalShape(b,a){EllipticalShape.baseConstructor.call(this,b,a);}Util.extend(EllipticalShape,Shape);EllipticalShape.prototype.initialize=function(){this.center=new Coord2D(0,0);this.rx=0;this.ry=0;this.xrot=0;this.coeffs=[];};EllipticalShape.prototype.initialize=function(){this.center=new Coord2D(0,0);this.rx=0;this.ry=0;this.xrot=0;};EllipticalShape.prototype.push=function(){this.set("cx",this.center.x);this.set("cy",this.center.y);this.set("rx",this.rx);this.set("ry",this.ry);this.set("transform","rotate("+Util.radToDeg(this.xrot)+" "+this.center.x+" "+this.center.y+")");};EllipticalShape.prototype.serialize=function(){this.set("berti:cx",this.center.x,Alberti.customns);this.set("berti:cy",this.center.y,Alberti.customns);this.set("berti:rx",this.rx,Alberti.customns);this.set("berti:ry",this.ry,Alberti.customns);this.set("berti:xrot",this.xrot,Alberti.customns);if(this.coeffs.length>0){this.set("berti:a",this.coeffs[0],Alberti.customns);this.set("berti:b",this.coeffs[1],Alberti.customns);this.set("berti:c",this.coeffs[2],Alberti.customns);this.set("berti:d",this.coeffs[3],Alberti.customns);this.set("berti:f",this.coeffs[4],Alberti.customns);this.set("berti:g",this.coeffs[5],Alberti.customns);}};EllipticalShape.prototype.pull=function(){this.center=new Coord2D(this.get("cx",Alberti.customns),this.get("cy",Alberti.customns));this.rx=this.get("rx",Alberti.customns);this.ry=this.get("ry",Alberti.customns);this.xrot=this.get("xrot",Alberti.customns);this.coeffs=[];var b=this.get("a",Alberti.customns);if(b!==""&&b!==null){this.coeffs[0]=b;this.coeffs[1]=this.get("b",Alberti.customns);this.coeffs[2]=this.get("c",Alberti.customns);this.coeffs[3]=this.get("d",Alberti.customns);this.coeffs[4]=this.get("f",Alberti.customns);this.coeffs[5]=this.get("g",Alberti.customns);}};EllipticalShape.prototype.getPointGivenAngle=function(b){b=(b-this.xrot)%twoPi;var d=Math.abs(b);var c=atan((this.rx*tan(b))/this.ry)+((d>halfPi&&d<=threeHalfPi)?pi:twoPi);return new Coord2D(this.center.x+this.rx*cos(c)*cos(this.xrot)-this.ry*sin(c)*sin(this.xrot),this.center.y+this.rx*cos(c)*sin(this.xrot)+this.ry*sin(c)*cos(this.xrot));};EllipticalShape.projectToQuad=function(av,ao,an,am,al){var k=ao.x,h=ao.y;var aq=an.x,ap=an.y;var aj=am.x,ai=am.y;var n=al.x,l=al.y;var ah=aq*aj*l-k*aj*l-aq*ai*n+k*ai*n-k*ap*n+h*aq*n+k*ap*aj-h*aq*aj;var ag=k*aj*l-k*aq*l-aq*ai*n+ap*aj*n-h*aj*n+h*aq*n+k*aq*ai-k*ap*aj;var af=aq*aj*l-k*aq*l-k*ai*n-ap*aj*n+h*aj*n+k*ap*n+k*aq*ai-h*aq*aj;var ae=ap*aj*l-h*aj*l-k*ap*l+h*aq*l-ap*ai*n+h*ai*n+k*ap*ai-h*aq*ai;var ac=-aq*ai*l+k*ai*l+ap*aj*l-k*ap*l-h*ai*n+h*ap*n+h*aq*ai-h*ap*aj;var ab=aq*ai*l-k*ai*l+h*aj*l-h*aq*l-ap*ai*n+h*ap*n+k*ap*ai-h*ap*aj;var aa=aq*l-k*l-ap*n+h*n-aq*ai+k*ai+ap*aj-h*aj;var Z=aj*l-aq*l-ai*n+ap*n+k*ai-h*aj-k*ap+h*aq;var Y=aj*l-k*l-ai*n+h*n+aq*ai-ap*aj+k*ap-h*aq;var o=SylvesterModule.Matrix.create([[ah,ag,af],[ae,ac,ab],[aa,Z,Y]]);var m=o.inverse();var X=m.elements[0][0];var W=m.elements[0][1];var V=m.elements[0][2];var U=m.elements[1][0];var v=m.elements[1][1];var t=m.elements[1][2];var s=m.elements[2][0];var r=m.elements[2][1];var q=m.elements[2][2];var az=X*X+U*U-s*s;var ay=X*W+U*v-s*r;var ax=W*W+v*v-r*r;var aw=X*V+U*t-s*q;var au=W*V+v*t-r*q;var at=V*V+t*t-q*q;var ak=(ay*ay-az*ax);av.center.x=(ax*aw-ay*au)/ak;av.center.y=(az*au-ay*aw)/ak;var u=(2*(az*au*au+ax*aw*aw+at*ay*ay-2*ay*aw*au-az*ax*at));var ad=Math.sqrt((az-ax)*(az-ax)+4*ay*ay);av.rx=Math.sqrt(u/(ak*(ad-(az+ax))));av.ry=Math.sqrt(u/(ak*(-ad-(az+ax))));if(ay==0){if(az<ax){av.xrot=0;}else{av.xrot=halfPi;}}else{var ar=0.5*atan((2*ay)/(az-ax));if(az<ax){av.xrot=ar;}else{av.xrot=halfPi+ar;}}av.coeffs=[az,ay,ax,aw,au,at];return av;};Ellipse.elementTag="ellipse";Ellipse.shapeName="ellipse";function Ellipse(a){Ellipse.baseConstructor.call(this,a?a:Ellipse.elementTag,Ellipse.shapeName);}Util.extend(Ellipse,EllipticalShape);Ellipse.prototype.clone=function(){var a=new Ellipse();a.center=this.center.clone();a.rx=this.rx;a.ry=this.ry;a.xrot=this.xrot;a.coeffs=this.coeffs;return a;};EllipticalArc.elementTag="path";EllipticalArc.shapeName="earc";function EllipticalArc(a){EllipticalArc.baseConstructor.call(this,a?a:EllipticalArc.elementTag,EllipticalArc.shapeName);}Util.extend(EllipticalArc,EllipticalShape);EllipticalArc.prototype.initialize=function(){EllipticalArc.superclass.initialize.call(this);this.sa=0;this.da=0;};EllipticalArc.prototype.push=function(){var a=this.getPointGivenAngle(this.sa);var d=this.getPointGivenAngle(this.sa+this.da);var b=Math.abs(this.da)>pi?1:0;var c=this.da>0?1:0;this.set("d","M"+a.x+","+a.y+" A"+this.rx+","+this.ry+", "+Util.radToDeg(this.xrot)+", "+b+","+c+", "+d.x+","+d.y);};EllipticalArc.prototype.serialize=function(){EllipticalArc.superclass.serialize.call(this);this.set("berti:sa",this.sa,Alberti.customns);this.set("berti:da",this.da,Alberti.customns);this.set("berti:type",EllipticalArc.shapeName,Alberti.customns);};EllipticalArc.prototype.pull=function(){EllipticalArc.superclass.pull.call(this);this.sa=this.get("sa",Alberti.customns);this.da=this.get("da",Alberti.customns);};EllipticalArc.prototype.clone=function(){var a=new EllipticalArc();a.center=this.center.clone();a.rx=this.rx;a.ry=this.ry;a.xrot=this.xrot;a.sa=this.sa;a.da=this.da;a.coeffs=this.coeffs;return a;};EllipticalArc.fromEllipse=function(b){var a=new EllipticalArc();a.center=b.center.clone();a.rx=b.rx;a.ry=b.ry;a.xrot=b.xrot;a.coeffs=b.coeffs.clone();return a;};Bezier.elementTag="path";Bezier.shapeName="bezier";function Bezier(a){Bezier.baseConstructor.call(this,a?a:Bezier.elementTag,Bezier.shapeName);}Util.extend(Bezier,Shape);Bezier.prototype.initialize=function(){this.p1=new Coord2D(0,0);this.p2=new Coord2D(0,0);this.p3=new Coord2D(0,0);};Bezier.prototype.push=function(){this.set("d","M"+this.p1.x+","+this.p1.y+"Q"+this.p2.x+","+this.p2.y+" "+this.p3.x+","+this.p3.y);};Bezier.prototype.serialize=function(){this.set("berti:x0",this.p1.x,Alberti.customns);this.set("berti:y0",this.p1.y,Alberti.customns);this.set("berti:x1",this.p2.x,Alberti.customns);this.set("berti:y1",this.p2.y,Alberti.customns);this.set("berti:x2",this.p3.x,Alberti.customns);this.set("berti:y2",this.p3.y,Alberti.customns);this.set("berti:type",Bezier.shapeName,Alberti.customns);};Bezier.prototype.pull=function(){this.p1=new Coord2D(this.get("x0",Alberti.customns),this.get("y0",Alberti.customns));this.p2=new Coord2D(this.get("x1",Alberti.customns),this.get("y1",Alberti.customns));this.p3=new Coord2D(this.get("x2",Alberti.customns),this.get("y2",Alberti.customns));};Bezier.prototype.clone=function(){var a=new Bezier();a.p1.x=this.p1.x;a.p1.y=this.p1.y;a.p2.x=this.p2.x;a.p2.y=this.p2.y;a.p3.x=this.p3.x;a.p3.y=this.p3.y;return a;};Bezier.fromPoints=function(e,d,c){var a=new Bezier();a.p1.x=e.x;a.p1.y=e.y;a.p2.x=d.x;a.p2.y=d.y;a.p3.x=c.x;a.p3.y=c.y;return a;};var Intersect={lineline:function(f,e){var d=[];var b=f.p2.y-f.p1.y;var m=f.p1.x-f.p2.x;var h=b*f.p1.x+m*f.p1.y;var a=e.p2.y-e.p1.y;var l=e.p1.x-e.p2.x;var g=a*e.p1.x+l*e.p1.y;var k=b*l-a*m;if(!Util.equals(k,0)){var c=(l*h-m*g)/k;var n=(b*g-a*h)/k;if(Util.between(c,f.p1.x,f.p2.x)&&Util.between(n,f.p1.y,f.p2.y)&&Util.between(c,e.p1.x,e.p2.x)&&Util.between(n,e.p1.y,e.p2.y)){d.push(new Coord2D(c,n));}}return d;},ellipseline:function(M,n){var N=[];if(M.coeffs.length>0){var L=M.coeffs[0];var K=M.coeffs[1];var J=M.coeffs[2];var G=M.coeffs[3];var F=M.coeffs[4];var z=M.coeffs[5];var D=n.p1.x,h=n.p1.y;var y=n.p2.x,e=n.p2.y;var q=y-D;var o=e-h;var v=J*e*e-2*J*h*e+2*K*y*e-2*K*D*e+J*h*h-2*K*y*h+2*K*D*h+L*y*y-2*L*D*y+L*D*D;var u=2*J*h*e+2*K*D*e+2*F*e-2*J*h*h+2*K*y*h-4*K*D*h-2*F*h+2*L*D*y+2*G*y-2*L*D*D-2*G*D;var s=J*h*h+2*K*D*h+2*F*h+L*D*D+2*G*D+z;var I=u*u-4*v*s;var k=2.19e+35;var H=-5.673;var E=M.rx*M.ry;var x=(k*Math.pow(E,H))/1e+41;if(Util.equals(I,0,x)){var r=-u/(2*v);if(Util.between(r,0,1)){N[0]=new Coord2D(n.p1.x+r*q,n.p1.y+r*o);}}else{if(I>0){var w=Math.sqrt(I);var m=(-u+w)/(2*v);var l=(-u-w)/(2*v);if(Util.between(m,0,1)){N.push(new Coord2D(n.p1.x+m*q,n.p1.y+m*o));}if(Util.between(l,0,1)){N.push(new Coord2D(n.p1.x+l*q,n.p1.y+l*o));}}}}return N;},earcline:function(e,c){var g=[];var b=Intersect.ellipseline(e,c);var a=b.length;if(a>0){var f=e.sa+e.da;for(var d=0;d<a;d++){if(b[d]&&Util.angleIsBetweenAngles(e.center.angleTo(b[d]),e.sa,f)){g.push(b[d]);}}}return g;},circleline:function(d,v){var e=[];var r=v.p2.x-v.p1.x;var k=v.p2.y-v.p1.y;var q=v.p1.x-d.center.x;var g=v.p1.y-d.center.y;var o=r*r+k*k;var n=2*(q*r+g*k);var m=(q*q+g*g)-d.radius*d.radius;var u=n*n-4*o*m;if(Util.equals(u,0,1e-25)){var s=-n/(2*o);if(Util.between(s,0,1)){e[0]=new Coord2D(v.p1.x+s*r,v.p1.y+s*k);}}else{if(u>0){var l=Math.sqrt(u);var h=(-n+l)/(2*o);var f=(-n-l)/(2*o);if(Util.between(h,0,1)){e.push(new Coord2D(v.p1.x+h*r,v.p1.y+h*k));}if(Util.between(f,0,1)){e.push(new Coord2D(v.p1.x+f*r,v.p1.y+f*k));}}}return e;},carcline:function(e,c){var g=[];var b=Intersect.circleline(e,c);var a=b.length;if(a>0){var f=e.sa+e.da;for(var d=0;d<a;d++){if(b[d]&&Util.angleIsBetweenAngles(e.center.angleTo(b[d]),e.sa,f)){g.push(b[d]);}}}return g;},bezierline:function(o,n){var Q=[];var H=[];var O=o.p1.x,f=o.p1.y;var N=o.p2.x,e=o.p2.y;var M=o.p3.x,d=o.p3.y;var L=n.p1.x,c=n.p1.y;var z=n.p2.x,a=n.p2.y;var x=(M-2*N+O)*a+(-M+2*N-O)*c+(L-z)*d+(2*z-2*L)*e+(L-z)*f;var w=(2*N-2*O)*a+(2*O-2*N)*c+(2*L-2*z)*e+(2*z-2*L)*f;var v=(O-L)*a+(z-O)*c+(L-z)*f;var P=w*w-4*x*v;if(Util.equals(P,0)){var s=-w/(2*x);if(Util.between(s,0,1)){var u=(1-s)*(1-s);var r=2*(1-s)*s;var q=s*s;H[0]=new Coord2D(u*O+r*N+q*M,u*f+r*e+q*d);}}else{if(P>0){var y=Math.sqrt(P);var m=(-w+y)/(2*x);var k=(-w-y)/(2*x);if(Util.between(m,0,1)){var u=(1-m)*(1-m);var r=2*(1-m)*m;var q=m*m;H.push(new Coord2D(u*O+r*N+q*M,u*f+r*e+q*d));}if(Util.between(k,0,1)){var l=(1-k)*(1-k);var h=2*(1-k)*k;var g=k*k;H.push(new Coord2D(l*O+h*N+g*M,l*f+h*e+g*d));}}}for(var G=0;G<H.length;G++){var b=H[G];if(Util.between(b.x,n.p1.x,n.p2.x)&&Util.between(b.y,n.p1.y,n.p2.y)){Q.push(b);}}return Q;},circlecircle:function(r,q){var x=[];var v=Util.floorToDecimal(r.center.distanceTo(q.center),6);var e=Util.floorToDecimal(r.radius+q.radius,6);var u=Util.floorToDecimal(Math.abs(r.radius-q.radius),6);var l=r.radius*r.radius;var s=q.radius*q.radius;var o=q.center.x-r.center.x;var n=q.center.y-r.center.y;if(v<e&&v>u){var w=(l-s+v*v)/(2*v);var t=Math.sqrt(l-w*w);var f=w/v;var c=t/v;var k=c*o;var g=c*n;var b=new Coord2D(r.center.x+f*o,r.center.y+f*n);x[0]=new Coord2D(b.x+g,b.y-k);x[1]=new Coord2D(b.x-g,b.y+k);}else{if(v!=0&&(Util.equals(e,v)||(Util.equals(u,v)))){var m=r.radius/v;x[0]=new Coord2D(r.center.x+m*o,r.center.y+m*n);}}return x;},carccircle:function(d,f){var g=[];var b=Intersect.circlecircle(d,f);if(b.length>0){var e=d.sa+d.da;for(var c=0,a=b.length;c<a;c++){if(Util.angleIsBetweenAngles(d.center.angleTo(b[c]),d.sa,e)){g.push(b[c]);}}}return g;},carccarc:function(g,e){var h=[];var b=Intersect.circlecircle(g,e);if(b.length>0){var f=g.sa+g.da;var d=e.sa+e.da;for(var c=0,a=b.length;c<a;c++){if(Util.angleIsBetweenAngles(g.center.angleTo(b[c]),g.sa,f)&&Util.angleIsBetweenAngles(e.center.angleTo(b[c]),e.sa,d)){h.push(b[c]);}}}return h;},linerect:function(a,b){var c=[];c=c.concat(Intersect.lineline(a,Line.fromPoints(new Coord2D(b.rect.left,b.rect.top),new Coord2D(b.rect.right,b.rect.top))));c=c.concat(Intersect.lineline(a,Line.fromPoints(new Coord2D(b.rect.right,b.rect.top),new Coord2D(b.rect.right,b.rect.bottom))));c=c.concat(Intersect.lineline(a,Line.fromPoints(new Coord2D(b.rect.right,b.rect.bottom),new Coord2D(b.rect.left,b.rect.bottom))));c=c.concat(Intersect.lineline(a,Line.fromPoints(new Coord2D(b.rect.left,b.rect.bottom),new Coord2D(b.rect.left,b.rect.top))));return c;},carcrect:function(a,b){var c=[];c=c.concat(Intersect.carcline(a,Line.fromPoints(new Coord2D(b.rect.left,b.rect.top),new Coord2D(b.rect.right,b.rect.top))));c=c.concat(Intersect.carcline(a,Line.fromPoints(new Coord2D(b.rect.right,b.rect.top),new Coord2D(b.rect.right,b.rect.bottom))));c=c.concat(Intersect.carcline(a,Line.fromPoints(new Coord2D(b.rect.right,b.rect.bottom),new Coord2D(b.rect.left,b.rect.bottom))));c=c.concat(Intersect.carcline(a,Line.fromPoints(new Coord2D(b.rect.left,b.rect.bottom),new Coord2D(b.rect.left,b.rect.top))));return c;},earcrect:function(c,a){var b=[];b=b.concat(Intersect.earcline(c,Line.fromPoints(new Coord2D(a.rect.left,a.rect.top),new Coord2D(a.rect.right,a.rect.top))));b=b.concat(Intersect.earcline(c,Line.fromPoints(new Coord2D(a.rect.right,a.rect.top),new Coord2D(a.rect.right,a.rect.bottom))));b=b.concat(Intersect.earcline(c,Line.fromPoints(new Coord2D(a.rect.right,a.rect.bottom),new Coord2D(a.rect.left,a.rect.bottom))));b=b.concat(Intersect.earcline(c,Line.fromPoints(new Coord2D(a.rect.left,a.rect.bottom),new Coord2D(a.rect.left,a.rect.top))));return b;},ellipserect:function(b,a){var c=[];c=c.concat(Intersect.ellipseline(b,Line.fromPoints(new Coord2D(a.rect.left,a.rect.top),new Coord2D(a.rect.right,a.rect.top))));c=c.concat(Intersect.ellipseline(b,Line.fromPoints(new Coord2D(a.rect.right,a.rect.top),new Coord2D(a.rect.right,a.rect.bottom))));c=c.concat(Intersect.ellipseline(b,Line.fromPoints(new Coord2D(a.rect.right,a.rect.bottom),new Coord2D(a.rect.left,a.rect.bottom))));c=c.concat(Intersect.ellipseline(b,Line.fromPoints(new Coord2D(a.rect.left,a.rect.bottom),new Coord2D(a.rect.left,a.rect.top))));return c;},bezierrect:function(c,a){var b=[];b=b.concat(Intersect.bezierline(c,Line.fromPoints(new Coord2D(a.rect.left,a.rect.top),new Coord2D(a.rect.right,a.rect.top))));b=b.concat(Intersect.bezierline(c,Line.fromPoints(new Coord2D(a.rect.right,a.rect.top),new Coord2D(a.rect.right,a.rect.bottom))));b=b.concat(Intersect.bezierline(c,Line.fromPoints(new Coord2D(a.rect.right,a.rect.bottom),new Coord2D(a.rect.left,a.rect.bottom))));b=b.concat(Intersect.bezierline(c,Line.fromPoints(new Coord2D(a.rect.left,a.rect.bottom),new Coord2D(a.rect.left,a.rect.top))));return b;},circlerect:function(b,a){var c=[];c=c.concat(Intersect.circleline(b,Line.fromPoints(new Coord2D(a.rect.left,a.rect.top),new Coord2D(a.rect.right,a.rect.top))));c=c.concat(Intersect.circleline(b,Line.fromPoints(new Coord2D(a.rect.right,a.rect.top),new Coord2D(a.rect.right,a.rect.bottom))));c=c.concat(Intersect.circleline(b,Line.fromPoints(new Coord2D(a.rect.right,a.rect.bottom),new Coord2D(a.rect.left,a.rect.bottom))));c=c.concat(Intersect.circleline(b,Line.fromPoints(new Coord2D(a.rect.left,a.rect.bottom),new Coord2D(a.rect.left,a.rect.top))));return c;}};var Tangency={ellipsepoint:function(M,v){var u=[];var L=M.coeffs[0];var K=M.coeffs[1];var J=M.coeffs[2];var G=M.coeffs[3];var E=M.coeffs[4];var z=M.coeffs[5];var F=v.coord.x;var k=v.coord.y;var o=L*F+K*k+G;var n=K*F+J*k+E;var m=G*F+E*k+z;if(n==0){var s=J;var r=2*(E-(K*m)/o);var q=(L*m*m)/(o*o)-(2*G*m)/o+z;}else{var s=L-(2*K*o)/n+(J*o*o)/(n*n);var r=2*(G-(K*m+E*o)/n+(J*o*m)/(n*n));var q=z-(2*E*m)/n+(J*m*m)/(n*n);}var I=r*r-4*s*q;var l=1.86e+29;var H=-5.304;var D=M.rx*M.ry;var x=(l*Math.pow(D,H))/1e+41;if(Util.equals(I,0,x)){u[0]=new Coord2D(F,k);}else{if(I>0){var t=Math.sqrt(I);if(n==0){var h=(-r+t)/(2*s);var e=(-r-t)/(2*s);var y=-m/o;var w=-m/o;}else{var y=(-r+t)/(2*s);var w=(-r-t)/(2*s);var h=-(o*y+m)/n;var e=-(o*w+m)/n;}u[0]=new Coord2D(y,h);u[1]=new Coord2D(w,e);}}return u;},earcpoint:function(e,b){var g=[];var c=Tangency.ellipsepoint(e,b);var a=c.length;if(a>0){var f=e.sa+e.da;for(var d=0;d<a;d++){if(c[d]&&Util.angleIsBetweenAngles(e.center.angleTo(c[d]),e.sa,f)){g.push(c[d]);}}}return g;}};SnapPoints.insertFlag=0;SnapPoints.deleteFlag=1;SnapPoints.bulkDeleteFlag=2;SnapPoints.nopFlag=3;function SnapPoints(){this.points=new SpatialHash((Alberti.snapRadius/Zap.zoomFactors[Zap.minZoomLevel])*2);this.deletedPoints=[];this.snapRadiusScale=1;}SnapPoints.prototype.testIntersections=function(b,a,c){return this.test(Intersect,b,a,c);};SnapPoints.prototype.testTangencies=function(b,a,c){return this.test(Tangency,b,a,c);};SnapPoints.prototype.test=function(c,n,o,g){var a=[];var b=[];for(var k=0,f=o.length;k<f;k++){var l=o[k];if(l){var e=[];if(l.shapeName<n.shapeName){var m=l.shapeName+n.shapeName;if(c[m]){e=c[m](l,n);}}else{var m=n.shapeName+l.shapeName;if(c[m]){e=c[m](n,l);}}if(e.length>0){a.push(l);b=b.concat(e);}switch(g){case SnapPoints.insertFlag:for(var h=0,d=e.length;h<d;h++){this.points.insert(e[h]);}break;case SnapPoints.deleteFlag:for(var h=0,d=e.length;h<d;h++){this.points.remove([e[h]]);}break;case SnapPoints.bulkDeleteFlag:for(var h=0,d=e.length;h<d;h++){this.deletedPoints.push(e[h]);}break;}}}return[a,b];};SnapPoints.prototype.getNearestNeighbor=function(g,f){var b=Alberti.snapRadius/this.snapRadiusScale;var c=this.points.search(g,b);var a=null;var d=Infinity;for(i=0,ncLen=c.length;i<ncLen;i++){if(!f||!c[i].isEqual(f)){var e=g.distanceTo(c[i]);if(e<d){a=c[i];d=e;}}}return a?a.clone():null;};SnapPoints.prototype.flush=function(){this.points.remove(this.deletedPoints);this.deletedPoints=[];};SnapPoints.prototype.setSnapRadiusScale=function(a){this.snapRadiusScale=a;};Layer.counter=0;Layer.defaultLayerColor="#7788ff";function Layer(a){Layer.baseConstructor.call(this,a?a:Group.elementTag);this.shapes=[];Layer.counter++;}Util.extend(Layer,Group);Layer.prototype.initialize=function(){Layer.superclass.initialize.call(this);this.name="";this.hidden=false;this.color=Layer.defaultLayerColor;};Layer.prototype.addShape=function(a){if(a.svgNode.parentNode==null){this.attachChild(a);}this.shapes.push(a);};Layer.prototype.removeShape=function(a){var b=this.shapes.indexOf(a);Util.assert(b>=0,"Unrecognized shape passed to Layer::removeShape");a.detach();this.shapes.splice(b,1);};Layer.prototype.hide=function(){if(!this.hidden){this.hidden=true;this.set("display","none");}};Layer.prototype.show=function(){if(this.hidden){this.hidden=false;this.set("display","");}};Layer.prototype.setName=function(a){this.name=a;this.set("title",a);};Layer.prototype.setColor=function(a){this.color=a;this.set("stroke",a);};Layer.prototype.isHidden=function(){return this.hidden;};Layer.prototype.push=function(){Layer.superclass.push.call(this);this.set("title",this.name);this.set("display",this.hidden?"none":"");this.set("stroke",this.color);};Layer.prototype.pull=function(){Layer.superclass.pull.call(this);this.hidden=(this.get("display")=="none")?true:false;this.name=this.get("title");this.color=this.get("stroke");};Layer.resetCounter=function(){Layer.counter=0;};function UndoManager(a){this.undoStack=[];this.redoStack=[];this.bufferLevel=0;this.actionBuffer=null;this.cleanState=undefined;this.enabled=false;this.maxActions=a;}UndoManager.prototype.push=function(a,b,h,f,d,g,c){if(this.enabled){var e={name:a,redo:function(){h.apply(b,f);},undo:d?function(){d.apply(b,g);}:null,cascades:c?c:false};if(this.actionBuffer!==null){this.actionBuffer.push(e);}else{this.undoStack.push([e]);if(this.undoStack.length>this.maxActions){this.undoStack.shift();}}this.redoStack=[];}};UndoManager.prototype.enable=function(){this.enabled=true;};UndoManager.prototype.disable=function(){this.enabled=false;};UndoManager.prototype.getStackSize=function(){return this.undoStack.length;};UndoManager.prototype.recordStart=function(){if(this.enabled&&this.bufferLevel++==0){this.actionBuffer=[];}};UndoManager.prototype.recordStop=function(){if(this.enabled){Util.assert(this.bufferLevel>0,"UndoManager::recordStop called when no recording of actions is taking place.");if(--this.bufferLevel==0){if(this.actionBuffer.length>0){this.undoStack.push(this.actionBuffer);if(this.undoStack.length>this.maxActions){this.undoStack.shift();}}this.actionBuffer=null;}}};UndoManager.prototype.undo=function(){this.disable();if(this.undoStack.length>0){var c=this.undoStack.peek().peek().cascades?1:0;do{var b=this.undoStack.pop();for(i=b.length-1;i>=0;i--){var a=b[i];if(a.undo){a.undo();}}this.redoStack.push(b);}while(this.undoStack.length>0&&(b.peek().cascades&&((this.undoStack.peek().peek().cascades&&b.peek().name==this.undoStack.peek().peek().name)||--c>=0)));}this.enable();};UndoManager.prototype.redo=function(){this.disable();if(this.redoStack.length>0){var b=this.redoStack.peek().peek().cascades?1:0;do{var a=this.redoStack.pop();for(i=0,aLen=a.length;i<aLen;i++){a[i].redo();}this.undoStack.push(a);}while(this.redoStack.length>0&&(a[0].cascades&&((this.redoStack.peek()[0].cascades&&a[0].name==this.redoStack.peek()[0].name)||--b>=0)));}this.enable();};UndoManager.prototype.setCleanState=function(){this.cleanState=this.undoStack.peek();};UndoManager.prototype.stateIsClean=function(){return this.undoStack.peek()===this.cleanState;};function LayerManager(b,a){this.layerGroup=b;this.undoManager=a;this.layers=[];this.currentLayer=null;Layer.resetCounter();this.numHiddenLayers=0;this.shapeIndex={};this.shapeCount=0;this.selectedShapes=[];this.markers=[null];this.currentMarker=null;this.snapPoints=new SnapPoints();}LayerManager.prototype.newLayer=function(a){var b=new Layer().generate();b.setName(a?a:"Layer "+Layer.counter);this.insertLayer(b);return b;};LayerManager.prototype.insertLayer=function(b,d,c){if(b.isHidden()){this.numHiddenLayers++;}d=d?d:this.currentLayer;if(this.layers.length>0){if(c){this.layerGroup.attachChildBefore(b,d);}else{this.layerGroup.attachChildAfter(b,d);}}else{this.layerGroup.attachChild(b);}var a=this.layers.indexOf(d);a=c?a:a+1;this.layers.splice(a,0,b);this.undoManager.push("Insert Layer",this,this.insertLayer,[b,d,c],this.deleteLayer,[b,true]);this.switchToLayer(b);};LayerManager.prototype.deleteLayer=function(c,b){Util.assert(this.layers.length>1,"LayerManager::deleteLayer attempted to delete only remaining layer.");c.detach();this.undoManager.recordStart();while(c.shapes.length>0){this.removeShape(c.shapes.peek(),true);}this.undoManager.push("Flush Snap Points",this.snapPoints,this.snapPoints.flush,null);this.snapPoints.flush();var a=this.layers.indexOf(c);if(c==this.currentLayer){var d=this.getNextLowestVisibleLayer(c);var f=this.getNextHighestVisibleLayer(c);var e=b?(a>0?(d?d:f):f):(a<this.layers.length-1?(f?f:d):d);this.switchToLayer(e);}this.undoManager.push("Delete Current Layer",this,this.deleteLayer,[c],this.insertLayer,[c,a==0?this.layers[1]:this.layers[a-1],a==0]);this.layers.splice(a,1);this.undoManager.recordStop();};LayerManager.prototype.deleteCurrentLayer=function(){this.deleteLayer(this.currentLayer);};LayerManager.prototype.moveLayer=function(c,b){var a=this.layers.indexOf(c);this.undoManager.push("Move Layer",this,this.moveLayer,[c,b],this.moveLayer,[c,a<this.layers.length-1?this.layers[a+1]:undefined]);this.layers.splice(a,1);c.detach();if(b){this.layers.splice(this.layers.indexOf(b),0,c);this.layerGroup.attachChildBefore(c,b);}else{this.layers.push(c);this.layerGroup.attachChild(c);}};LayerManager.prototype.switchToLayer=function(a){Util.assert(this.layers.indexOf(a)>=0,"Invalid layer passed to LayerManager::switchToLayer.");this.undoManager.push("Change Current Layer",this,this.switchToLayer,[a],this.switchToLayer,[this.currentLayer],true);this.currentLayer=a;};LayerManager.prototype.switchToHighestVisibleLayer=function(){this.switchToLayer(this.getNextLowestVisibleLayer());};LayerManager.prototype.switchToVisibleLayerAboveCurrentLayer=function(){if(this.layers.length>1){var a=this.getNextHighestVisibleLayer(this.currentLayer);this.switchToLayer(a?a:this.getNextHighestVisibleLayer());}};LayerManager.prototype.switchToVisibleLayerBelowCurrentLayer=function(){if(this.layers.length>1){var a=this.getNextLowestVisibleLayer(this.currentLayer);this.switchToLayer(a?a:this.getNextLowestVisibleLayer());}};LayerManager.prototype.setLayerName=function(a,c){var b=a.name;a.setName(c);this.undoManager.push("Change Layer Name",this,this.setLayerName,[a,c],this.setLayerName,[a,b]);};LayerManager.prototype.setLayerColor=function(b,a){var c=b.color;b.setColor(a);this.undoManager.push("Change Layer Color",this,this.setLayerColor,[b,a],this.setLayerColor,[b,c]);};LayerManager.prototype.setLayerVisibility=function(e,h){Util.assert(e,"Invalid layer passed to LayerManager::setLayerVisibility.");if(h){if(e.isHidden()){this.numHiddenLayers--;var c=this.getVisibleShapes();for(var f=0,d=e.shapes.length;f<d;f++){var b=e.shapes[f];this.snapPoints.testIntersections(b,c,SnapPoints.insertFlag);c.push(b);}e.show();this.undoManager.push("Show Layer",this,this.setLayerVisibility,[e,true],this.setLayerVisibility,[e,false]);}}else{if(!e.isHidden()){Util.assert(this.getNumberOfVisibleLayers()>1,"LayerManager::setLayerVisibility attempted to hide only visible layer.");this.numHiddenLayers++;var c=this.getVisibleShapes();for(var f=e.shapes.length-1;f>=0;f--){var b=e.shapes[f];this.snapPoints.testIntersections(b,c,SnapPoints.bulkDeleteFlag);c[c.indexOf(b)]=null;}this.snapPoints.flush();this.undoManager.recordStart();this.setSelection([]);if(e==this.currentLayer){var a=this.getNextHighestVisibleLayer(e);var g=this.getNextLowestVisibleLayer(e);this.switchToLayer(a?a:g);}this.undoManager.push("Hide Layer",this,this.setLayerVisibility,[e,false],this.setLayerVisibility,[e,true]);e.hide();this.undoManager.recordStop();}}};LayerManager.prototype.getCurrentLayer=function(){return this.currentLayer;};LayerManager.prototype.getTopmostLayer=function(){return this.layers[this.layers.length-1];};LayerManager.prototype.getNextHighestVisibleLayer=function(d){var c=d?this.layers.indexOf(d):-1;for(var b=c+1,a=this.layers.length;b<a;b++){if(!this.layers[b].isHidden()){return this.layers[b];}}return null;};LayerManager.prototype.getNextLowestVisibleLayer=function(c){var b=c?this.layers.indexOf(c):this.layers.length;for(var a=b-1;a>=0;a--){if(!this.layers[a].isHidden()){return this.layers[a];}}return null;};LayerManager.prototype.getNumberOfVisibleLayers=function(){return this.layers.length-this.numHiddenLayers;};LayerManager.prototype.insertShape=function(c,b){var a=c.sid;Util.assert(!this.shapeIndex[a],"Duplicate shape passed to LayerManager::insertShape (sid '"+a+"').");b=b?b:this.currentLayer;b.addShape(c);if(!b.isHidden()){this.snapPoints.testIntersections(c,this.getVisibleShapes(),SnapPoints.insertFlag);}this.shapeIndex[a]={shape:c,layer:b};this.shapeCount++;if(c.shapeName=="point"){this.addMarker(c);}this.undoManager.push("Insert Shape",this,this.insertShape,[c,b],this.removeShape,[c]);return a;};LayerManager.prototype.removeShape=function(b,d){var a=b.sid;var c=this.shapeIndex[a].layer;Util.assert(this.shapeIndex[a],"Shape with unrecognized sid passed to LayerManager::removeShape.");delete this.shapeIndex[a];this.shapeCount--;c.removeShape(b);this.snapPoints.testIntersections(b,this.getVisibleShapes(),d?SnapPoints.bulkDeleteFlag:SnapPoints.deleteFlag);if(b.shapeName=="point"){this.removeMarker(b);}this.undoManager.push("Delete Shape",this,this.removeShape,[b,d],this.insertShape,[b,c]);return b;};LayerManager.prototype.getShapesInCurrentLayer=function(){return this.currentLayer.shapes.clone();};LayerManager.prototype.getSelectedShapes=function(){return this.selectedShapes.clone();};LayerManager.prototype.deleteSelectedShapes=function(){this.undoManager.recordStart();for(i=this.selectedShapes.length-1;i>=0;i--){this.removeShape(this.selectedShapes[i],true);}this.setSelection([]);this.undoManager.push("Flush Snap Points",this.snapPoints,this.snapPoints.flush,null);this.snapPoints.flush();this.undoManager.recordStop();};LayerManager.prototype.getShapesInRect=function(d){var b=[];var a=this.getVisibleShapes();for(var c=0,e=a.length;c<e;c++){if(d.enclosesRect(a[c].getBoundingBox())){b.push(a[c]);}}return b.concat(this.snapPoints.testIntersections(Rectangle.fromRect2D(d),a,SnapPoints.nopFlag)[0]);};LayerManager.prototype.pickShapes=function(e,a,d){var c=new Rect2D(e.x-a,e.y-a,e.x+a,e.y+a);var b=this.getShapesInRect(c);if(d){b=b.length>0?b.peek():null;}return b;};LayerManager.prototype.selectShape=function(a){if(this.selectedShapes.indexOf(a)==-1){this.selectedShapes.push(a);a.displaySelected();}};LayerManager.prototype.deselectShape=function(a){var b=this.selectedShapes.indexOf(a);if(b>=0){this.selectedShapes.splice(b,1);a.displayDeselected();}};LayerManager.prototype.setSelection=function(b){var e=this.getSelectedShapes();b=Array.isArray(b)?b:(b!==null?[b]:[]);for(var d=this.selectedShapes.length-1;d>=0;d--){this.deselectShape(this.selectedShapes[d]);}for(var d=0,c=b.length;d<c;d++){this.selectShape(b[d]);}var a=this.getSelectedShapes();if(!a.equals(e)){this.undoManager.push("Select Shapes",this,this.setSelection,[a],this.setSelection,[e]);}};LayerManager.prototype.xorSelection=function(b){var e=this.getSelectedShapes();b=Array.isArray(b)?b:(b!==null?[b]:[]);for(var d=0,c=b.length;d<c;d++){this[(this.selectedShapes.indexOf(b[d])==-1)?"selectShape":"deselectShape"](b[d]);}var a=this.getSelectedShapes();if(!a.equals(e)){this.undoManager.push("Modify Selection",this,this.setSelection,[a],this.setSelection,[e]);}};LayerManager.prototype.getVisibleShapes=function(){var b=[];for(var a in this.shapeIndex){var c=this.shapeIndex[a];if(!c.layer.isHidden()){b.push(c.shape);}}return b;};LayerManager.prototype.serializeAll=function(){for(var a in this.shapeIndex){this.shapeIndex[a].shape.serialize();}};LayerManager.prototype.addMarker=function(a){this.markers.push(a);};LayerManager.prototype.removeMarker=function(a){if(a==this.currentMarker){this.currentMarker=null;}this.markers.splice(this.markers.indexOf(a),1);};LayerManager.prototype.getNumMarkers=function(){return this.markers.length-1;};LayerManager.prototype.nextMarker=function(){var a=this.markers.indexOf(this.currentMarker);while(++a<this.markers.length&&this.shapeIndex[this.markers[a].sid].layer.isHidden()){}this.currentMarker=this.markers[a<this.markers.length?a:0];return this.currentMarker?this.currentMarker.coord.clone():null;};LayerManager.prototype.previousMarker=function(){var a=this.markers.indexOf(this.currentMarker);var b=(a>0?a:this.markers.length);while(--b>0&&this.shapeIndex[this.markers[b].sid].layer.isHidden()){}this.currentMarker=this.markers[b];return this.currentMarker?this.currentMarker.coord.clone():null;};LayerManager.prototype.resetCurrentMarker=function(){this.currentMarker=null;};ToolTip.hiPriorityTime=0.75;function ToolTip(a){this.div=a;this.clearTimeoutId=null;this.lastHiPriorityCall=0;}ToolTip.prototype.setText=function(e,c,d){if(Alberti.showToolTips&&(d||Date.now()-this.lastHiPriorityCall>=ToolTip.hiPriorityTime*1000)){this.cancelAutoClear();if(d&&e!=""){this.lastHiPriorityCall=Date.now();}this.div.innerHTML=e;if(c&&e){var b=e.match(/\S+/g).length;var a=(b*0.24)+1;this.clearTimeoutId=window.setTimeout(function(){this.clearText();this.clearTimeoutId=null;}.bindTo(this),a*1000);}}};ToolTip.prototype.clearText=function(){this.cancelAutoClear();this.setText("",false,true);};ToolTip.prototype.cancelAutoClear=function(){if(this.clearTimeoutId){window.clearTimeout(this.clearTimeoutId);this.clearTimeoutId=null;}};function Tool(c,a,b,d){Tool.baseConstructor.call(this,d.masterGroup,null,d.overlayGroup);this.undoManager=null;this.underlayGroup=d.underlayGroup;this.toolTip=d.toolTip;this.numSteps=c;this.minSteps=arguments.length>1?a:c;this.steps=[];this.currentStep=-1;this.mouseupFlag=arguments.length>2?b:false;this.enabled=false;this.active=false;this.auxiliarySnapPoints=[];this.constrainKeys=[];this.constrainCoordX=null;this.constrainCoordY=null;}Util.extend(Tool,TransformHandler);Tool.prototype.setManagers=function(a,b){this.layerManager=a;this.undoManager=b;};Tool.prototype.activate=function(){if(!this.active){this.active=true;this.enabled=true;this.excludeSnapPoint=null;this.registerListener("mousedown",Alberti.svgRoot,false);this.registerListener("mousemove",window,false);this.registerListener("keydown",window,false);this.registerListener("keyup",window,false);if(this.mouseupFlag){this.registerListener("mouseup",window,false);}}};Tool.prototype.deactivate=function(){if(this.active){this.active=false;this.enabled=false;this.unregisterListener("mousedown",Alberti.svgRoot,false);this.unregisterListener("mousemove",window,false);this.unregisterListener("keydown",window,false);this.unregisterListener("keyup",window,false);if(this.mouseupFlag){this.unregisterListener("mouseup",window,false);}this.toolTip.clearText();this.onDeactivate();this.reset();}};Tool.prototype.enable=function(){if(this.active&&!this.enabled){this.enabled=true;this.registerListener("mousedown",Alberti.svgRoot,false);this.registerListener("keydown",window,false);if(this.mouseupFlag){this.registerListener("mouseup",window,false);}}};Tool.prototype.disable=function(){if(this.active&&this.enabled){this.enabled=false;this.unregisterListener("mousedown",Alberti.svgRoot,false);this.unregisterListener("keydown",window,false);if(this.mouseupFlag){this.unregisterListener("mouseup",window,false);}this.toolTip.clearText();}};Tool.prototype.registerShape=function(b,c,a){Util.assert(typeof c=="string"&&c!=="","Invalid name passed to Tool::registerShape.");Util.assert(!this.getShape(c),"Duplicate name passed to Tool::registerShape.");this.steps[this.currentStep].addShape(b,c);b.push();if(a){this.underlayGroup.attachChild(b);}else{this.overlayGroup.attachChild(b);}};Tool.prototype.bakeShape=function(c){var a=this.getShapeArrayContaining(c);Util.assert(a,"Tool::bakeShape could not find shape with name '"+c+"'");var b=a[c].shape;a[c].bakeFlag=true;return b;};Tool.prototype.unregisterShape=function(c){var a=this.getShapeArrayContaining(c);Util.assert(a,"Tool::unregisterShape could not find shape with name '"+c+"'");var b=a[c].shape.detach();delete a[c];return b;};Tool.prototype.getKeyCoordFromStep=function(a){return this.steps[a]!==undefined?this.steps[a].keyCoord.clone():undefined;};Tool.prototype.updateKeyCoord=function(a){this.steps[this.currentStep].keyCoord=a.clone();};Tool.prototype.getShape=function(b){var a=this.getShapeArrayContaining(b);return a?a[b].shape:null;};Tool.prototype.getShapeArrayContaining=function(b){var a;for(var c=0;c<=this.currentStep;c++){a=this.steps[c].shapes;if(a[b]){return a;}}return null;};Tool.prototype.generateIsectSnaps=function(a){this.clearSnapPoints();this.auxiliarySnapPoints=this.layerManager.snapPoints.testIntersections(this.getShape(a),this.layerManager.getVisibleShapes(),SnapPoints.insertFlag)[1];};Tool.prototype.generateTangentSnaps=function(a){this.clearSnapPoints();this.auxiliarySnapPoints=this.layerManager.snapPoints.testTangencies(this.getShape(a),this.layerManager.getVisibleShapes(),SnapPoints.insertFlag)[1];};Tool.prototype.clearSnapPoints=function(){if(this.auxiliarySnapPoints.length>0){this.layerManager.snapPoints.points.remove(this.auxiliarySnapPoints);}this.auxiliarySnapPoints=[];};Tool.prototype.sendShapeToUnderlay=function(b){var a=this.getShape(b);Util.assert(a,"Tool::sendShapeToUnderlay could not find shape with name '"+b+"'");a.detach();this.underlayGroup.attachChild(a);return a;};Tool.prototype.sendShapeToOverlay=function(c){var a=this.getShapeArrayContaining(c);Util.assert(a,"Tool::sendShapeToOverlay could not find shape with name '"+c+"'");var b=a[c].shape;b.detach();this.overlayGroup.attachChild(b);return b;};Tool.prototype.displayTip=function(c,a,b){if(this.enabled){this.toolTip.setText(c,a,b);}};Tool.prototype.lockMouseCoords=function(a){this.constrainCoordX=a.x;this.constrainCoordY=a.y;};Tool.prototype.onMouseDown=function(c,b,a){a.stopPropagation();if(this.constrainCoordX){c=this.constrainCoordX;b=this.constrainCoordY;}this.incrementStep(c,b);this.executeStep(this.currentStep,c,b);this.invokeMouseMove(c,b);if(this.currentStep==this.numSteps-1){this.completeTool();}else{if(a.button==2){if(this.currentStep>=this.minSteps-1){this.completeTool();}}}};Tool.prototype.onMouseUp=function(c,b,a){if(this.currentStep!=-1){this.onMouseDown(c,b,a);}};Tool.prototype.invokeMouseMove=function(b,a){if(this.currentStep>=0){this.mouseMoveDuringStep(this.currentStep,b,a);}};Tool.prototype.onMouseMove=function(c,b,a){this.constrainCoordX=this.constrainCoordY=null;this.invokeMouseMove(c,b);};Tool.prototype.keydown=function(a){if(this.constrainKeys.indexOf(a.keyCode)==-1){this.constrainKeys.push(a.keyCode);}switch(a.keyCode){case KeyCode.esc:this.reset();break;case KeyCode.backStep:this.decrementStep();break;case KeyCode.enter:if(this.currentStep>=this.minSteps-1){this.completeTool();}break;case KeyCode.snap:this.enableSnapping();break;default:p=this.getLastMousePosition();this.invokeMouseMove(p.x,p.y);}};Tool.prototype.keyup=function(b){var a=this.constrainKeys.indexOf(b.keyCode);if(a!=-1){this.constrainKeys.splice(a,1);}switch(b.keyCode){case KeyCode.snap:this.disableSnapping();break;default:p=this.getLastMousePosition();this.invokeMouseMove(p.x,p.y);}};Tool.prototype.incrementStep=function(b,a){this.currentStep++;this.steps[this.currentStep]=new ToolStep(b,a);};Tool.prototype.decrementStep=function(){this.toolTip.clearText();if(this.currentStep>=0){this.unregisterShapesInCurrentStep();this.steps.pop();if(--this.currentStep==-1){this.reset();}else{var b=this.getLastMousePosition();var a=this.getKeyCoordFromStep(this.currentStep);this.unregisterShapesInCurrentStep();this.executeStep(this.currentStep,a.x,a.y);this.invokeMouseMove(b.x,b.y);}}};Tool.prototype.bake=function(){this.undoManager.recordStart();for(var c=0;c<=this.currentStep;c++){var a=this.steps[c].shapes;for(var b in a){if(a[b].bakeFlag){this.layerManager.insertShape(this.unregisterShape(b));}}}this.undoManager.recordStop();};Tool.prototype.completeTool=function(){this.complete(this.currentStep);this.bake();this.reset();};Tool.prototype.unregisterShapesInCurrentStep=function(){if(this.currentStep>=0){var a=this.steps[this.currentStep].shapes;for(var b in a){a[b].shape.detach();delete a[b];}}};Tool.prototype.reset=function(){for(var b=0;b<=this.currentStep;b++){for(var a in this.steps[b].shapes){this.steps[b].shapes[a].shape.detach();}}this.steps=[];this.currentStep=-1;this.toolTip.clearText();this.excludeSnapPoint=null;this.clearSnapPoints();this.constrainKeys=[];};Tool.prototype.checkModifierKeys=function(a){return a.isSubsetOf(this.constrainKeys);};Tool.prototype.executeStep=function(c,b,a){throw"Abstract function Tool::executeStep not implemented by inheriting class!";};Tool.prototype.complete=function(a){throw"Abstract function Tool::complete not implemented by inheriting class!";};Tool.prototype.mouseMoveDuringStep=function(c,b,a){};Tool.prototype.onDeactivate=function(){};function ToolStep(a,b){this.keyCoord=new Coord2D(a,b);this.shapes={};}ToolStep.prototype.addShape=function(b,c,a){this.shapes[c]={shape:b,bakeFlag:a};};function ToolSelection(a){ToolSelection.baseConstructor.call(this,2,2,true,a);}Util.extend(ToolSelection,Tool);ToolSelection.prototype.executeStep=function(d,c,b){switch(d){case 0:var a=new Rectangle().generate();a.rect=Rect2D.fromPoints(new Coord2D(c,b),new Coord2D(c,b));a.set("id","selectionBox");this.registerShape(a,"select_rect");break;}};ToolSelection.prototype.mouseMoveDuringStep=function(e,d,b){switch(e){case 0:var a=this.getShape("select_rect");var f=this.getKeyCoordFromStep(0);var c=new Coord2D(d,b);a.rect=Rect2D.fromPoints(f,c);a.push();break;}};ToolSelection.prototype.complete=function(e){var d=this.getShape("select_rect");var c;if(d.rect.right-d.rect.left<1&&d.rect.bottom-d.rect.top<1){var b=this.getKeyCoordFromStep(0);var a=this.currentSnapPoint?0.1/this.masterGroup.scale:Alberti.selectionPickRadius/this.masterGroup.scale;c=this.layerManager.pickShapes(b,a,this.currentSnapPoint===null);}else{c=this.layerManager.getShapesInRect(d.rect);}if(this.checkModifierKeys([KeyCode.shift])){this.layerManager.xorSelection(c);}else{this.layerManager.setSelection(c);}};ToolSelection.prototype.onDeactivate=function(){this.layerManager.setSelection([]);};function ToolMarker(a){ToolMarker.baseConstructor.call(this,1,1,false,a);}Util.extend(ToolMarker,Tool);ToolMarker.prototype.executeStep=function(d,c,a){var b=Point.fromCoord(new Coord2D(c,a)).generate();this.registerShape(b,"marker");};ToolMarker.prototype.complete=function(c,b,a){this.bakeShape("marker");};function ToolLine(a){ToolLine.baseConstructor.call(this,4,2,false,a);this.lastDeltaX=0;this.lastDeltaY=0;this.lastOrigin=null;}Util.extend(ToolLine,Tool);ToolLine.prototype.executeStep=function(g,m,k){switch(g){case 0:var b=this.getShape("startpoint");if(this.checkModifierKeys([KeyCode.modPinning])&&this.lastOrigin!==null){var h=this.lastOrigin.clone();this.updateKeyCoord(this.lastOrigin);}else{var h=new Coord2D(m,k);this.lastOrigin=h.clone();}var a=Point.fromCoord(h).generate();var e=Line.fromPoints(h,h).generate();this.registerShape(a,"startpoint");this.registerShape(e,"line");this.generateTangentSnaps("startpoint");break;case 1:var e=this.getShape("line");var b=this.getShape("startpoint");e.p1=b.coord.clone();e.p2=this.getKeyCoordFromStep(1);this.lastDeltaX=e.p2.x-e.p1.x;this.lastDeltaY=e.p2.y-e.p1.y;if(e.getLength()>0){var f=e.extendToInfinity().generate();var n=Point.fromCoord(e.p2).generate();var d=Point.fromCoord(e.p2).generate();d.innerColor="none";b.innerColor="black";this.sendShapeToOverlay("startpoint");this.registerShape(f,"line_guide",true);this.registerShape(d,"midpoint",true);this.registerShape(n,"endpoint1");}else{this.decrementStep();}break;case 2:var e=this.getShape("line");var b=this.getShape("startpoint");var n=Point.fromCoord(e.p2).generate();b.innerColor="none";this.sendShapeToUnderlay("startpoint");this.registerShape(n,"endpoint2");break;}};ToolLine.prototype.mouseMoveDuringStep=function(f,e,d){switch(f){case 0:var b=this.getShape("line");if(this.checkModifierKeys([KeyCode.shift])){b.p2.x=e;b.p2.y=d;b.setAngle(Util.roundToMultiple(b.getAngle(),quarterPi));b.p2=b.getProjectedPoint(new Coord2D(e,d));this.lockMouseCoords(b.p2);}else{if(this.checkModifierKeys([KeyCode.modParallel])&&!(this.lastDeltaX==0&&this.lastDeltaY==0)){b.p2.x=b.p1.x+this.lastDeltaX;b.p2.y=b.p1.y+this.lastDeltaY;this.lockMouseCoords(b.p2);}else{if(this.checkModifierKeys([KeyCode.modPerpendicular])&&!(this.lastDeltaX==0&&this.lastDeltaY==0)){b.p2.x=b.p1.x-this.lastDeltaY;b.p2.y=b.p1.y+this.lastDeltaX;this.lockMouseCoords(b.p2);}else{b.p2.x=e;b.p2.y=d;}}}b.push();this.displayTip("Length: "+Util.roundToDecimal(b.getLength(),2));break;case 1:var g=this.getShape("line_guide");var c=g.getProjectedPoint(new Coord2D(e,d));var b=this.getShape("line");var a=this.getShape("endpoint1");b.p2.x=a.coord.x=c.x;b.p2.y=a.coord.y=c.y;b.push();a.push();this.displayTip("Length: "+Util.roundToDecimal(b.getLength(),2));break;case 2:var b=this.getShape("line");var g=this.getShape("line_guide");var c=g.getProjectedPoint(new Coord2D(e,d));var a=this.getShape("endpoint2");b.p1.x=a.coord.x=c.x;b.p1.y=a.coord.y=c.y;b.push();a.push();this.displayTip("Length: "+Util.roundToDecimal(b.getLength(),2));break;}};ToolLine.prototype.complete=function(c){var b=this.getShape("line");if(c==1){b.p2=this.getShape("midpoint").coord.clone();}else{if(c==2){var a=this.getShape("endpoint1");b.p1=this.getShape("startpoint").coord.clone();b.p2=a.coord.clone();}}if(!(Util.equals(b.p1.x,b.p2.x)&&Util.equals(b.p1.y,b.p2.y))){this.bakeShape("line");}};function ToolArc(c,a,b,d){ToolArc.baseConstructor.call(this,c,a,b,d);this.clockDirection=1;this.lastDeltaAngle=0;}Util.extend(ToolArc,Tool);ToolArc.prototype.getClockDirection=function(b){var a=b-this.lastDeltaAngle;if(Math.abs(a)>halfPi&&Util.sign(a)==this.clockDirection){this.clockDirection*=-1;}this.lastDeltaAngle=b;return this.clockDirection;};function ToolCircleArc(a){ToolCircleArc.baseConstructor.call(this,-1,2,false,a);this.lastRadius=0;}Util.extend(ToolCircleArc,ToolArc);ToolCircleArc.prototype.executeStep=function(m,s,q){switch(m){case 0:this.excludeSnapPoint=null;this.clearSnapPoints();var b=Point.fromCoord(new Coord2D(s,q)).generate();var o=new Circle().generate();o.center.x=s;o.center.y=q;o.radius=0;this.registerShape(b,"start_point");this.registerShape(o,"radius_circle");break;case 1:var o=this.getShape("radius_circle");if(o.radius>0){this.excludeSnapPoint=o.center;this.generateIsectSnaps("radius_circle");this.lastRadius=o.radius;var e=Line.fromPoints(o.center,o.center).generate();this.registerShape(e,"radius_line");this.sendShapeToUnderlay("radius_circle");}else{this.decrementStep();break;}default:var h=this.getShape("radius_line").getLength();var f=this.getKeyCoordFromStep(0);var r=this.getKeyCoordFromStep(m);switch((m-2)%2){case 0:var d=Line.fromPoints(f,r).generate().setLength(h);var n=Point.fromCoord(d.p2).generate();var a=new CircleArc().generate();a.center=f.clone();a.radius=h;a.sa=d.getAngle();this.registerShape(n,"start_angle_point"+m);this.registerShape(d,"start_angle_line"+m,true);this.registerShape(a,"arc"+m);break;case 1:if(!Util.equals(this.getShape("arc"+(m-1)).da,0,0.0001)){var k=Line.fromPoints(f,r).generate().setLength(h);var g=Point.fromCoord(k.p2).generate();this.registerShape(g,"delta_angle_point"+m);this.registerShape(k,"delta_angle_line"+m,true);this.bakeShape("arc"+(m-1));}else{this.decrementStep();}break;}break;}};ToolCircleArc.prototype.mouseMoveDuringStep=function(g,n,m){switch(g){case 0:var h=this.getShape("radius_circle");if(this.checkModifierKeys([KeyCode.shift])&&this.lastRadius!=0){var d=Line.fromPoints(h.center,new Coord2D(n,m)).setLength(this.lastRadius);this.lockMouseCoords(d.p2);h.radius=this.lastRadius;}else{h.radius=h.center.distanceTo(new Coord2D(n,m));}h.push();this.displayTip("Radius: "+Util.roundToDecimal(h.radius,2));break;default:var d=this.getShape("radius_line");var h=this.getShape("radius_circle");var f=new Coord2D(n,m);var b=Util.radToDeg(h.center.angleTo(f));if(this.checkModifierKeys([KeyCode.shift])){b=Util.roundToMultiple(b,0.25);d.setAngle(Util.degToRad(b));f.x=d.p2.x;f.y=d.p2.y;this.lockMouseCoords(d.p2);}else{d.p2.x=n;d.p2.y=m;d.setLength(h.radius);}d.push();switch((g-1)%2){case 0:this.displayTip("Angle: "+Util.roundToDecimal(b,2)+"&#176;");break;case 1:var k=this.getShape("start_angle_line"+(g));var e=this.getShape("arc"+g);var a=h.center.angleToRelative(f,k.getAngle());e.da=this.getClockDirection(a)>0?a:a-twoPi;e.push();this.displayTip("Delta: "+Util.roundToDecimal(Util.radToDeg(Math.abs(e.da)),2)+"&#176;");break;}break;}};ToolCircleArc.prototype.complete=function(a){if(a<3){this.bakeShape("radius_circle");}};function ToolEllipticalArc(a){ToolEllipticalArc.baseConstructor.call(this,-1,4,false,a);this.quadPoints=[];}Util.extend(ToolEllipticalArc,ToolArc);ToolEllipticalArc.prototype.executeStep=function(q,v,u){switch(q){case 0:case 1:case 2:var o=new Coord2D(v,u);this.excludeSnapPoint=null;this.clearSnapPoints();if(q!=0&&o.isEqual(this.quadPoints[q-1])){this.decrementStep();}else{var c=Point.fromCoord(o).generate();this.quadPoints[q]=c.coord;this.registerShape(c,"quad_point"+q);}break;case 3:this.quadPoints[3]=new Coord2D(v,u);var a=Coord2D.convexHull(this.quadPoints);if(a.length==4){var d=Point.fromCoord(this.quadPoints[3]).generate();var r=EllipticalShape.projectToQuad(new Ellipse(),a[0],a[1],a[2],a[3]).generate();var t=Point.fromCoord(r.center).generate();var m=Line.fromPoints(a[0],a[1]).generate();var h=Line.fromPoints(a[1],a[2]).generate();var g=Line.fromPoints(a[2],a[3]).generate();var f=Line.fromPoints(a[3],a[0]).generate();var n=Line.fromPoints(r.center,r.center).generate();this.registerShape(d,"quad_point"+q);this.registerShape(t,"center_point");this.registerShape(m,"quad_line1",true);this.registerShape(h,"quad_line2",true);this.registerShape(g,"quad_line3",true);this.registerShape(f,"quad_line4",true);this.registerShape(r,"ellipse_guide",true);this.registerShape(n,"line_radius");this.excludeSnapPoint=r.center;this.generateIsectSnaps("ellipse_guide");}else{this.decrementStep();this.displayTip("Invalid point. Quad must be convex.",true,true);}break;default:var b=new Coord2D(v,u);var r=this.getShape("ellipse_guide");var c=Point.fromCoord(b).generate();var k=Line.fromPoints(r.center,b).generate();switch((q-3)%2){case 0:if(!Util.equals(this.getShape("arc"+(q-1)).da,0.0001)){this.registerShape(k,"line_delta_angle"+q,true);this.registerShape(c,"point_delta_angle"+q);this.bakeShape("arc"+(q-1));}else{this.decrementStep();}break;case 1:var s=EllipticalArc.fromEllipse(this.getShape("ellipse_guide")).generate();s.sa=k.getAngle();s.coeffs=r.coeffs;this.registerShape(s,"arc"+q);this.registerShape(k,"line_start_angle"+q,true);this.registerShape(c,"point_start_angle"+q);break;}break;}};ToolEllipticalArc.prototype.mouseMoveDuringStep=function(g,l,k){if(g>2){var h=this.getShape("ellipse_guide");var d=this.getShape("line_radius");var f=new Coord2D(l,k);var c=h.center.angleTo(f);if(this.checkModifierKeys([KeyCode.shift])){c=Util.degToRad(Util.roundToMultiple(Util.radToDeg(c),0.25));}var b=h.getPointGivenAngle(c);this.lockMouseCoords(b);d.p2.x=b.x;d.p2.y=b.y;d.push();if((g-3)%2==1){ea=this.getShape("arc"+g);var a=Util.angleRelativeTo(c,ea.sa);ea.da=this.getClockDirection(a)>0?a:a-twoPi;ea.push();}}};ToolEllipticalArc.prototype.complete=function(a){if(a<5){this.bakeShape("ellipse_guide");}};function ToolBezier(a){ToolBezier.baseConstructor.call(this,3,3,false,a);}Util.extend(ToolBezier,Tool);ToolBezier.prototype.executeStep=function(g,f,d){var c=new Coord2D(f,d);switch(g){case 0:var a=Bezier.fromPoints(c,c,c).generate();var e=Point.fromCoord(c).generate();this.registerShape(e,"p1");this.registerShape(a,"bezier");break;case 1:var e=Point.fromCoord(c).generate();this.registerShape(e,"p3");break;}};ToolBezier.prototype.mouseMoveDuringStep=function(e,d,c){var a=this.getShape("bezier");switch(e){case 0:a.p3.x=d;a.p3.y=c;a.p2.x=(a.p1.x+a.p3.x)/2;a.p2.y=(a.p1.y+a.p3.y)/2;a.push();break;case 1:a.p2.x=d;a.p2.y=c;a.push();break;}};ToolBezier.prototype.complete=function(a){this.bakeShape("bezier");};function FileImporter(e,f,b,c,d,a){FileImporter.baseConstructor.call(this);this.inputElement=e;this.importAsText=b;this.controller=c;this.importHandler=d;this.allowedExtensions=a;Util.assert(typeof FileReader!=="undefined","Your browser does not support the required FileReader object.");this.fileReader=null;this.inputElement.accept=f;this.registerListener("change",this.inputElement,false);}Util.extend(FileImporter,EventHandler);FileImporter.prototype.prompt=function(){this.inputElement.click();};FileImporter.prototype.getFilename=function(){return this.inputElement.files[0].name||null;};FileImporter.prototype.change=function(a){this.fileReader=new FileReader();this.registerListener("loadend",this.fileReader,false);if(this.importAsText){this.fileReader.readAsText(this.inputElement.files[0]);}else{this.fileReader.readAsDataURL(this.inputElement.files[0]);}};FileImporter.prototype.loadend=function(a){var b=new RegExp("\\.("+this.allowedExtensions+")$","i");if(this.getFilename().match(b)){this.controller[this.importHandler](this.fileReader.result,this.getFilename());this.regenerateInput();}this.unregisterListener("loadend",this.fileReader,false);this.fileReader=null;};FileImporter.prototype.regenerateInput=function(){this.unregisterListener("change",this.inputElement,false);var a=document.createElement("input");a.type="file";a.id=this.inputElement.id;Util.replaceElement(this.inputElement,a);this.inputElement=a;this.registerListener("change",this.inputElement,false);};function GuiControl(d,b,a,c){GuiControl.baseConstructor.call(this);this.id=d;this.htmlNode=b;this.controller=a;this.action=c;}Util.extend(GuiControl,EventHandler);GuiControl.prototype.getId=function(){return this.id;};GuiControl.prototype.connect=function(a,b){this.controller=a;this.action=b;return this;};GuiControl.prototype.invokeAction=function(b){if(this.controller[b]){var a=Array.prototype.slice.call(arguments,1);return this.controller[b].apply(this.controller,a);}};GuiControl.prototype.getClientPosition=function(){return new Coord2D(Util.getClientX(this.htmlNode),Util.getClientY(this.htmlNode));};GuiMenu.styleMenuItemOpened="guiMenuOpened";GuiMenu.styleMenuItemDisabled="guiMenuDisabled";GuiMenu.positionBelow=1;GuiMenu.positionAbove=2;GuiMenu.positionRight=3;GuiMenu.positionLeft=4;GuiMenu.fadeLength=0.15;GuiMenu.openDelay=0.2;function GuiMenu(b,a,f,c,l,g,d,h,e,k){GuiMenu.baseConstructor.call(this,b,a,f,c);this.triggerNode=l;this.position=g||GuiMenu.positionBelow;this.offsetX=h;this.offsetY=e;this.delayOpen=k||false;this.subMenus=[];this.openedSubMenu=null;this.parentMenu=d||null;this.disabledMenuItems=[];this.htmlNode.style.display="none";this.htmlNode.style.position="fixed";this.opened=false;this.openTime=0;this.fadeAnimation=null;if(this.parentMenu){this.parentMenu.addSubMenu(this);}else{if(this.delayOpen){this.openTimeoutId=null;}this.registerListener("mousedown",this.triggerNode,false);}}Util.extend(GuiMenu,GuiControl);GuiMenu.prototype.addSubMenu=function(a){this.subMenus.push(a);a.registerListener("mouseover",a.triggerNode,false);};GuiMenu.prototype.delayedOpen=function(){if(!this.openTimeoutId){this.openTimeoutId=setTimeout(function(){this.mouseup();this.open();}.bindTo(this),GuiMenu.openDelay*1000);this.registerListener("mouseup",window,false);}};GuiMenu.prototype.open=function(){if(!this.opened){this.opened=true;this.htmlNode.style.display="";if(this.parentMenu){this.parentMenu.openedSubMenu=this;}Util.addHtmlClass(this.triggerNode,GuiMenu.styleMenuItemOpened);this.registerListener("mousemove",this.htmlNode,false);if(!this.parentMenu){this.registerListener("mousedown",window,true);this.registerListener("click",window,true);this.registerListener("DOMMouseScroll",window,true);this.registerListener("mousewheel",window,true);this.registerListener("keydown",window,true);this.openTime=Date.now();}this.updatePosition();if(this.fadeAnimation){this.fadeAnimation.stop();this.htmlNode.style.opacity=1;}}};GuiMenu.prototype.close=function(a){if(this.opened){this.opened=false;this.unregisterListener("mousemove",this.htmlNode,false);if(!this.parentMenu){this.unregisterListener("mousedown",window,true);this.unregisterListener("click",window,true);this.unregisterListener("DOMMouseScroll",window,true);this.unregisterListener("mousewheel",window,true);this.unregisterListener("keydown",window,true);}if(this.openedSubMenu){this.closeSubMenu(a);}var b=function(){this.htmlNode.style.display="none";Util.removeHtmlClass(this.triggerNode,GuiMenu.styleMenuItemOpened);}.bindTo(this);if(a){b();}else{this.fadeAnimation=new Animation(GuiMenu.fadeLength,function(){b();this.htmlNode.style.opacity=1;this.fadeAnimation=null;}.bindTo(this));this.fadeAnimation.add(this.htmlNode.style,"opacity",1,0);this.fadeAnimation.begin();}}};GuiMenu.prototype.isOpen=function(){return this.opened;};GuiMenu.prototype.enableMenuItem=function(b){var a=this.disabledMenuItems.indexOf(b);if(a>-1){Util.removeHtmlClass(document.getElementById(b),GuiMenu.styleMenuItemDisabled);this.disabledMenuItems.splice(a,1);}};GuiMenu.prototype.disableMenuItem=function(a){if(this.disabledMenuItems.indexOf(a)==-1){Util.addHtmlClass(document.getElementById(a),GuiMenu.styleMenuItemDisabled);this.disabledMenuItems.push(a);}};GuiMenu.prototype.updatePosition=function(){var a=new Coord2D(Util.getClientX(this.triggerNode),Util.getClientY(this.triggerNode));switch(this.position){case GuiMenu.positionLeft:a.x-=this.htmlNode.clientWidth;break;case GuiMenu.positionRight:a.x+=this.triggerNode.clientWidth;break;case GuiMenu.positionAbove:a.y-=this.htmlNode.clientHeight;break;default:a.y+=this.triggerNode.clientHeight;break;}this.htmlNode.style.left=(a.x+(this.offsetX?this.offsetX:0))+"px";this.htmlNode.style.top=(a.y+(this.offsetY?this.offsetY:0))+"px";};GuiMenu.prototype.closeSubMenu=function(a){this.openedSubMenu.close(a);this.openedSubMenu=null;};GuiMenu.prototype.menuTreeHasElement=function(d){var b=this.hasElement(d);for(var c=0,a=this.subMenus.length;c<a&&!b;c++){b=this.subMenus[c].menuTreeHasElement(d);}return b;};GuiMenu.prototype.hasElement=function(a){return(this.htmlNode===a||Util.hasChild(this.htmlNode,a));};GuiMenu.prototype.mousemove=function(a){if(this.openedSubMenu&&a.target!==this.openedSubMenu.triggerNode){this.closeSubMenu(true);}};GuiMenu.prototype.mouseup=function(){if(this.openTimeoutId){clearTimeout(this.openTimeoutId);this.openTimeoutId=null;this.unregisterListener("mouseup",window,false);}};GuiMenu.prototype.mousedown=function(a){if(a.currentTarget===this.triggerNode){if(this.delayOpen&&a.button==0){this.delayedOpen();}else{this.open();}}else{a.stopPropagation();if(!this.menuTreeHasElement(a.target)){this.close();}}};GuiMenu.prototype.click=function(a){a.stopPropagation();if(a.target!==this.triggerNode){this.close();}if(this.menuTreeHasElement(a.target)&&this.disabledMenuItems.indexOf(a.target.id)==-1){this.invokeAction(this.action,a.target.id,a);}};GuiMenu.prototype.mouseover=function(a){if(!this.parentMenu||this.parentMenu.opened){this.open();}};GuiMenu.prototype.keydown=function(a){a.stopPropagation();if(a.keyCode==KeyCode.esc){this.close();}};GuiMenu.prototype.mousewheel=function(a){a.stopPropagation();a.preventDefault();};GuiMenu.prototype.DOMMouseScroll=function(a){a.stopPropagation();a.preventDefault();};function GuiMenuBar(){GuiMenuBar.baseConstructor.call(this);this.menuMap={};this.openMenu=null;}Util.extend(GuiMenuBar,EventHandler);GuiMenuBar.prototype.addMenu=function(a){this.menuMap[a.triggerNode.id]=a;this.registerListener("mousedown",a.triggerNode,false);};GuiMenuBar.prototype.activate=function(){for(var a in this.menuMap){this.registerListener("mouseover",this.menuMap[a].triggerNode,false);}};GuiMenuBar.prototype.deactivate=function(){if(this.openMenu){this.openMenu.close();this.openMenu=null;for(var a in this.menuMap){this.unregisterListener("mouseover",this.menuMap[a].triggerNode,false);}}};GuiMenuBar.prototype.mouseover=function(a){var b=this.menuMap[a.target.id];if(this.openMenu.isOpen()){if(b!=this.openMenu){b.open();this.openMenu.close(true);this.openMenu=b;}}else{this.deactivate();}};GuiMenuBar.prototype.mousedown=function(a){this.openMenu=this.menuMap[a.target.id];this.activate();};GuiButton.styleDisabled="guiBtnDisabled";GuiButton.styleToggled="guiBtnToggled";function GuiButton(a,d,f,c,e,k,b,g){GuiButton.baseConstructor.call(this,a,d,f,c);this.autoToggle=e;this.eventType=b?b:"click";this.respondsToBubbledEvents=g;this.tooltipOn="";this.tooltipOff="";if(k){var h=k.toString().match(/^\s*([^,]+?)\s*(,\s*(.+?)\s*)?$/);Util.assert(h!==null,"Invalid tool tip string passed to GuiButton constructor.");this.tooltipOn=h[1];this.tooltipOff=h[3]?h[3]:this.tooltipOn;}this[this.eventType]=this.respond;this.enabled=true;this.toggleOn=true;this.disable();this.toggle(false);}Util.extend(GuiButton,GuiControl);GuiButton.prototype.isToggled=function(){return this.toggleOn;};GuiButton.prototype.enable=function(){if(!this.enabled){this.enabled=true;Util.removeHtmlClass(this.htmlNode,GuiButton.styleDisabled);this.registerListener(this.eventType,this.htmlNode,false);}return this;};GuiButton.prototype.disable=function(){if(this.enabled){this.enabled=false;Util.addHtmlClass(this.htmlNode,GuiButton.styleDisabled);this.unregisterListener(this.eventType,this.htmlNode,false);}return this;};GuiButton.prototype.toggle=function(a){if(a===undefined){a=!this.toggleOn;}if(a!=this.toggleOn){if((this.toggleOn=a)){Util.addHtmlClass(this.htmlNode,GuiButton.styleToggled);if(this.tooltipOn){this.htmlNode.title=this.tooltipOn;}}else{Util.removeHtmlClass(this.htmlNode,GuiButton.styleToggled);if(this.tooltipOff){this.htmlNode.title=this.tooltipOff;}}}return this;};GuiButton.prototype.setState=function(a){if(this.state){Util.removeHtmlClass(this.htmlNode,this.state);}this.state=a;Util.addHtmlClass(this.htmlNode,this.state);};GuiButton.prototype.clearState=function(){if(this.state){Util.removeHtmlClass(this.htmlNode,this.state);delete this.state;}};GuiButton.prototype.getState=function(){return this.state;};GuiButton.prototype.respond=function(a){if(!a||(!a.defaultPrevented&&(a.target===this.htmlNode||this.respondsToBubbledEvents))){if(this.autoToggle){this.toggle();}this.invokeAction(this.action,this,a);}};function GuiButtonFamily(){this.buttons=[];this.lastToggledButton=null;}GuiButtonFamily.prototype.toggleButton=function(a){Util.assert(this.buttons.indexOf(a)>=0,"Invalid GuiButton object passed to GuiButtonFamily::toggleButton.");if(this.lastToggledButton){this.lastToggledButton.toggle(false);}a.toggle(true);this.lastToggledButton=a;};GuiButtonFamily.prototype.addButton=function(a){Util.assert(this.buttons.indexOf(a)<0,"Duplicate GuiButton object passed to GuiButtonFamily::addButton.");this.buttons.push(a);};GuiButtonFamily.prototype.removeButton=function(b){var a=this.buttons.indexOf(b);Util.assert(a>=0,"Invalid GuiButton object passed to GuiButtonFamily::removeButton.");this.buttons.splice(a,1);if(this.lastToggledButton==b){this.lastToggledButton=null;}};function GuiSelector(b,c,a){this.guiButton=b;this.guiMenu=c;this.stateMap=a;this.guiMenu.connect(this,"handleMenu");}GuiSelector.prototype.handleMenu=function(a){this.guiButton.setState(this.stateMap[a]);};function GuiTextField(e,c,b,d,a){GuiTextField.baseConstructor.call(this,e,c,b,d);this.autoHide=a;this.active=true;if(this.autoHide){this.deactivate();}}Util.extend(GuiTextField,GuiControl);GuiTextField.prototype.activate=function(a){if(!this.active){this.active=true;if(a!==undefined){this.htmlNode.value=a;}this.hideInput(false);this.htmlNode.focus();this.htmlNode.select();this.registerListener("keydown",this.htmlNode,true);this.registerListener("blur",this.htmlNode,false);}};GuiTextField.prototype.deactivate=function(){if(this.active){this.active=false;this.hideInput(true);this.unregisterListener("keydown",this.htmlNode,true);this.unregisterListener("blur",this.htmlNode,false);}};GuiTextField.prototype.hideInput=function(a){this.htmlNode.style.display=a?"none":"";};GuiTextField.prototype.keydown=function(a){switch(a.keyCode){case KeyCode.enter:this.htmlNode.blur();break;case KeyCode.esc:this.deactivate();break;}a.stopPropagation();};GuiTextField.prototype.blur=function(a){this.invokeAction(this.action,this,this.htmlNode.value,a);if(this.autoHide){this.deactivate();}};GuiDraggable.motiveDraggable=null;function GuiDraggable(b,f,a,e,d,c){GuiDraggable.baseConstructor.call(this,d);this.control=b;this.beginDragAction=f;this.dragAction=a;this.dropAction=e;this.dragThreshold=d;this.dropTargetFamily=c?c:null;this.currentDropTarget=null;this.absorbClicks=false;this.enabled=true;this.disable();}Util.extend(GuiDraggable,DragHandler);GuiDraggable.prototype.enable=function(){if(!this.enabled){this.enabled=true;this.registerListener("mousedown",this.control.htmlNode,false);this.registerListener("click",this.control.htmlNode,true);this.registerListener("dblclick",this.control.htmlNode,true);}return this;};GuiDraggable.prototype.disable=function(){if(this.enabled){this.enabled=false;this.unregisterListener("mousedown",this.control.htmlNode,false);this.unregisterListener("click",this.control.htmlNode,true);this.unregisterListener("dblclick",this.control.htmlNode,true);}return this;};GuiDraggable.prototype.onDragBegin=function(a){GuiDraggable.motiveDraggable=this;this.control.invokeAction(this.beginDragAction,this.control,a);this.absorbClicks=true;if(this.dropTargetFamily){this.dropTargetFamily.activate();}};GuiDraggable.prototype.onDrag=function(c,b,a){this.control.invokeAction(this.dragAction,this.control,c,b,a);};GuiDraggable.prototype.onDrop=function(a){GuiDraggable.motiveDraggable=null;this.control.invokeAction(this.dropAction,this.control,this.currentDropTarget,a);this.control.htmlNode.style.pointerEvents="all";window.setTimeout(function(){this.absorbClicks=false;}.bindTo(this),1);if(this.dropTargetFamily){this.dropTargetFamily.deactivate();}};GuiDraggable.prototype.setDropTarget=function(a){this.currentDropTarget=a;};GuiDraggable.prototype.click=GuiDraggable.prototype.dblclick=function(a){if(this.absorbClicks){a.stopPropagation();a.preventDefault();}};GuiDraggable.prototype.mousedown=function(a){if(a.target.tagName!="input"){GuiDraggable.superclass.mousedown.call(this,a);}};function GuiDropTarget(a,b,c,d){GuiDropTarget.baseConstructor.call(this);this.control=a;this.mouseOverAction=b;this.mouseOutAction=c;this.mouseMoveAction=d;this.active=false;this.enabled=false;}Util.extend(GuiDropTarget,EventHandler);GuiDropTarget.prototype.enable=function(){this.enabled=true;return this;};GuiDropTarget.prototype.disable=function(){this.enabled=false;return this;};GuiDropTarget.prototype.activate=function(){if(this.enabled&&!this.active){this.active=true;this.registerListener("mouseover",this.control.htmlNode,false);this.registerListener("mouseout",this.control.htmlNode,false);this.registerListener("mousemove",this.control.htmlNode,false);}};GuiDropTarget.prototype.deactivate=function(){if(this.active){this.active=false;this.unregisterListener("mouseover",this.control.htmlNode,false);this.unregisterListener("mouseout",this.control.htmlNode,false);this.unregisterListener("mousemove",this.control.htmlNode,false);}};GuiDropTarget.prototype.mouseover=function(a){if(GuiDraggable.motiveDraggable){GuiDraggable.motiveDraggable.setDropTarget(this.control);this.control.invokeAction(this.mouseOverAction,this.control,a);}};GuiDropTarget.prototype.mouseout=function(a){if(GuiDraggable.motiveDraggable){GuiDraggable.motiveDraggable.setDropTarget(null);this.control.invokeAction(this.mouseOutAction,this.control,a);}};GuiDropTarget.prototype.mousemove=function(b){if(GuiDraggable.motiveDraggable){GuiDraggable.motiveDraggable.setDropTarget(this.control);var d=this.control.getClientPosition();var c=b.clientX-d.x;var a=b.clientY-d.y;this.control.invokeAction(this.mouseMoveAction,this.control,c,a,b);}};function GuiDropTargetFamily(){this.dropTargets=[];}GuiDropTargetFamily.prototype.addDropTarget=function(a){Util.assert(this.dropTargets.indexOf(a)<0,"Duplicate drop target passed to GuiDropTargetFamily::addDropTarget");this.dropTargets.push(a);};GuiDropTargetFamily.prototype.removeDropTarget=function(a){var b=this.dropTargets.indexOf(a);Util.assert(b>=0,"Unrecognized drop target passed to GuiDropTargetFamily::removeDropTarget");this.dropTargets.splice(b,1);};GuiDropTargetFamily.prototype.activate=function(){for(var b=0,a=this.dropTargets.length;b<a;b++){this.dropTargets[b].activate();}};GuiDropTargetFamily.prototype.deactivate=function(){for(var b=0,a=this.dropTargets.length;b<a;b++){this.dropTargets[b].deactivate();}};function JsColorPicker(e,b,a,c,d){JsColorPicker.baseConstructor.call(this,e,b,a,c);this.inputElement=d;this.jscolor=new jscolor.color(this.inputElement,{hash:true,caps:false,pickerOnfocus:false,pickerPosition:"top",pickerFace:3,pickerBorder:0,pickerFaceColor:"black",pickerInsetColor:"white"});this.originalColor=null;this.lastColor=null;}Util.extend(JsColorPicker,GuiControl);JsColorPicker.prototype.activate=function(){this.originalColor=this.getColor();this.jscolor.showPicker();this.registerListener("mousedown",window,true);this.registerListener("click",window,true);this.registerListener("keydown",window,true);this.registerListener("change",this.inputElement,false);};JsColorPicker.prototype.deactivate=function(){this.jscolor.hidePicker();this.unregisterListener("mousedown",window,true);this.unregisterListener("click",window,true);this.unregisterListener("keydown",window,true);this.unregisterListener("change",this.inputElement,false);};JsColorPicker.prototype.setColor=function(a){this.lastColor=a;this.jscolor.fromString(a);};JsColorPicker.prototype.getColor=function(){return this.inputElement.value;};JsColorPicker.prototype.mousedown=function(a){if(!this.clickWasInPicker(a)){a.stopPropagation();}};JsColorPicker.prototype.clickWasInPicker=function(a){return Util.hasChild(jscolor.picker.boxB,a.target);};JsColorPicker.prototype.updateController=function(a){if(a!=this.lastColor){this.lastColor=a;this.invokeAction(this.action,this,a);}};JsColorPicker.prototype.keydown=function(a){switch(a.keyCode){case KeyCode.esc:this.updateController(this.originalColor);case KeyCode.enter:this.deactivate();a.stopPropagation();break;}};JsColorPicker.prototype.change=function(a){this.updateController(this.getColor());};JsColorPicker.prototype.click=function(a){if(!this.clickWasInPicker(a)){this.deactivate();a.stopPropagation();}};function UndoManagerDelegate(b,a){UndoManagerDelegate.baseConstructor.call(this,b);this.ui=a;this.mapMethod("push",null,"pushDelegate");this.mapMethod("recordStop",null,"pushDelegate");this.mapMethod("undo",null,"undoDelegate");this.mapMethod("redo",null,"undoDelegate");}Util.extend(UndoManagerDelegate,Delegate);UndoManagerDelegate.prototype.pushDelegate=function(){if(this.enabled&&this.bufferLevel==0){this.undoDelegate();}};UndoManagerDelegate.prototype.undoDelegate=function(){this.ui.updateUndoMenuItems(this.undoStack.length>0,this.redoStack.length>0);};function LayerManagerDelegate(b,c,a){LayerManagerDelegate.baseConstructor.call(this,b);this.lpController=c;this.ui=a;this.mapMethod("insertLayer","insertLayerPreDelegate","insertLayerPostDelegate");this.mapMethod("deleteLayer",null,"deleteLayerDelegate");this.mapMethod("moveLayer","moveLayerDelegate");this.mapMethod("switchToLayer","switchToLayerDelegate");this.mapMethod("setLayerVisibility",null,"setLayerVisibilityDelegate");this.mapMethod("setLayerName","setLayerNameDelegate");this.mapMethod("setLayerColor","setLayerColorDelegate");this.mapMethod("setSelection",null,"shapeSelectionDelegate");this.mapMethod("xorSelection",null,"shapeSelectionDelegate");this.mapMethod("addMarker",null,"addMarkerDelegate");this.mapMethod("removeMarker",null,"removeMarkerDelegate");}Util.extend(LayerManagerDelegate,Delegate);LayerManagerDelegate.prototype.insertLayerPreDelegate=function(a,c,b){c=c?c:this.currentLayer;if(b){this.lpController.insertNewRow(a,c);}else{if(a==this.getTopmostLayer()){this.lpController.insertNewRow(a);}else{this.lpController.insertNewRow(a,this.layers[this.layers.indexOf(c)+1]);}}};LayerManagerDelegate.prototype.insertLayerPostDelegate=function(a,c,b){this.lpController.updateButtons();};LayerManagerDelegate.prototype.deleteLayerDelegate=function(b,a){this.lpController.deleteRow(b);this.lpController.updateButtons();};LayerManagerDelegate.prototype.moveLayerDelegate=function(b,a){this.lpController.moveRow(b,a);};LayerManagerDelegate.prototype.switchToLayerDelegate=function(a){this.lpController.selectRow(a);};LayerManagerDelegate.prototype.setLayerVisibilityDelegate=function(a,b){this.lpController.updateButtons();};LayerManagerDelegate.prototype.setLayerNameDelegate=function(a,b){this.lpController.updateRowLayerName(a,b);};LayerManagerDelegate.prototype.setLayerColorDelegate=function(b,a){this.lpController.updateRowColor(b,a);};LayerManagerDelegate.prototype.shapeSelectionDelegate=function(a){this.ui.updateClippingMenuItems(this.getSelectedShapes().length>0);};LayerManagerDelegate.prototype.addMarkerDelegate=function(a){this.ui.updateNavBar();};LayerManagerDelegate.prototype.removeMarkerDelegate=function(a){this.ui.updateNavBar();};function LayerPanelController(a){this.layerPanel=a;this.rowLayerMap={};}LayerPanelController.prototype.setLayerManagerDelegate=function(a){this.lmDelegate=a;};LayerPanelController.prototype.getRowForLayer=function(a){return this.layerPanel.rows[this.getRowIndexForLayer(a)];};LayerPanelController.prototype.getRowIndexForLayer=function(a){for(var b in this.rowLayerMap){if(this.rowLayerMap[b]==a){return this.layerPanel.getRowIndexForId(b);}}throw"Unrecognized layer passed to LayerPanelController::getRowIndexForLayer";};LayerPanelController.prototype.populateLayerPanel=function(){this.layerPanel.clearAllRows();var c=this.lmDelegate.layers;for(var b=0,a=c.length;b<a;b++){this.insertNewRow(c[b]);}this.layerPanel.selectRow(this.getRowIndexForLayer(this.lmDelegate.currentLayer));this.updateButtons();};LayerPanelController.prototype.switchToLayer=function(a){this.lmDelegate.switchToLayer(this.rowLayerMap[a]);};LayerPanelController.prototype.setLayerVisibility=function(b,a){this.lmDelegate.setLayerVisibility(this.rowLayerMap[b],a);};LayerPanelController.prototype.newLayer=function(){this.lmDelegate.newLayer();};LayerPanelController.prototype.deleteCurrentLayer=function(){this.lmDelegate.deleteCurrentLayer();};LayerPanelController.prototype.moveLayer=function(b,a){this.lmDelegate.moveLayer(this.rowLayerMap[b],a?this.rowLayerMap[a]:undefined);};LayerPanelController.prototype.setLayerName=function(a,b){this.lmDelegate.setLayerName(this.rowLayerMap[a],b);};LayerPanelController.prototype.setLayerColor=function(b,a){this.lmDelegate.setLayerColor(this.rowLayerMap[b],a);};LayerPanelController.prototype.insertNewRow=function(b,a){var c=this.layerPanel.newRow(b.name,b.color,b.isHidden(),a?this.getRowIndexForLayer(a):undefined);this.rowLayerMap[c]=b;};LayerPanelController.prototype.deleteRow=function(a){var b=this.getRowForLayer(a);this.layerPanel.removeRow(this.getRowIndexForLayer(a));delete this.rowLayerMap[b.rowId];};LayerPanelController.prototype.moveRow=function(b,a){this.layerPanel.moveRow(this.getRowIndexForLayer(b),a?this.getRowIndexForLayer(a):undefined);};LayerPanelController.prototype.selectRow=function(a){this.layerPanel.selectRow(this.getRowIndexForLayer(a));};LayerPanelController.prototype.updateButtons=function(){var e=this.lmDelegate.getNumberOfVisibleLayers();var d=e>1?"enable":"disable";for(var c=0,a=this.lmDelegate.layers.length;c<a;c++){var b=this.lmDelegate.layers[c];var f=this.getRowForLayer(b);var g=b.isHidden()?"disable":"enable";f.rowButton[g]();f.visibilityToggleButton.toggle(!b.isHidden());if(!b.isHidden()){f.visibilityToggleButton[d]();}}this.layerPanel.cstrip.deleteLayerButton[d]();};LayerPanelController.prototype.updateRowLayerName=function(a,b){this.getRowForLayer(a).setName(b);};LayerPanelController.prototype.updateRowColor=function(b,a){this.getRowForLayer(b).setColor(a);};LayerPanelRow.styleGhost="ghost";LayerPanelRow.rowHeight=26;LayerPanelRow.halfRowHeight=13;LayerPanelRow.rowInnerHeight=17;function LayerPanelRow(f,c,b,d,a,e){this.rowId=f;this.rowDiv=document.createElement("div");this.rowDiv.className="layer_panel_row";this.rowButton=new GuiButton(f,this.rowDiv,a,"handleRowButton",false,"",null,true);this.rowDragger=new GuiDraggable(this.rowButton,"handleBeginDragRow","handleDragRow","handleDropRow",3,e).enable();this.rowDropTarget=new GuiDropTarget(this.rowButton,"handleRowEnterDropTarget","handleRowExitDropTarget","handleRowMoveWithinDropTarget").enable();if(!d){this.rowButton.enable();}this.visibilityToggleDiv=document.createElement("div");this.visibilityToggleDiv.className="visibility_toggle";this.visibilityToggleButton=new GuiButton(f,this.visibilityToggleDiv,a,"handleVisibilityToggle",true,"Hide Layer, Show Layer").enable().toggle(!d);this.layerNameDiv=document.createElement("div");this.layerNameDiv.className="layer_name";this.layerNameDiv.setAttribute("unselectable","on");this.layerNameDiv.innerHTML=c;this.layerNameButton=new GuiButton(f,this.layerNameDiv,a,"handleLayerNameButton",false,"","dblclick").enable();this.colorWellDiv=document.createElement("div");this.colorWellDiv.className="color_well";this.colorWellDiv.style.backgroundColor=b;this.colorWellButton=new GuiButton(f,this.colorWellDiv,a,"handleColorWell",false,"Pick Color").enable();this.jscolorInput=document.createElement("input");this.jscolorInput.className="color";this.jscolorPicker=new JsColorPicker(f,this.colorWellDiv,a,"handleJsColorPicker",this.jscolorInput);this.layerNameInput=document.createElement("input");this.layerNameInput.className="layer_name_input";this.layerNameGuiField=new GuiTextField(f,this.layerNameInput,a,"handleLayerNameField",true);this.rowDiv.appendChild(this.layerNameInput);this.rowDiv.appendChild(this.jscolorInput);this.rowDiv.appendChild(this.colorWellDiv);this.rowDiv.appendChild(this.visibilityToggleDiv);this.rowDiv.appendChild(this.layerNameDiv);}LayerPanelRow.prototype.getName=function(){return this.layerNameDiv.innerHTML;};LayerPanelRow.prototype.setName=function(a){this.layerNameDiv.innerHTML=a;};LayerPanelRow.prototype.getColor=function(){return Util.rgbToHex(this.colorWellDiv.style.backgroundColor);};LayerPanelRow.prototype.setColor=function(a){this.colorWellDiv.style.backgroundColor=a;this.jscolorPicker.setColor(a);};LayerPanelRow.prototype.cleanup=function(){this.rowButton.killAllListeners();this.rowDragger.killAllListeners();this.rowDropTarget.killAllListeners();this.visibilityToggleButton.killAllListeners();this.layerNameButton.killAllListeners();this.colorWellButton.killAllListeners();this.jscolorPicker.killAllListeners();this.layerNameGuiField.killAllListeners();};LayerPanel.defaultPosition="0px";LayerPanel.collapsePosition="-160px";LayerPanel.collapseTransitionLength=0.25;LayerPanel.rowSnapAnimationLength=0.125;function LayerPanel(b,a,d,c){LayerPanel.baseConstructor.call(this);this.mainDiv=b;this.dynamicDiv=a;this.cstripDiv=d;this.insertMarkDiv=c;this.insertMarkDiv.style.display="none";this.rows=[];this.rowBtnFamily=new GuiButtonFamily();this.dropTargetFamily=new GuiDropTargetFamily();this.rowIdCounter=1;this.cstrip=new LayerPanelControlStrip(Util.firstNonTextChild(this.cstripDiv),this);this.isCollapsed=false;this.collapseAnimation=null;this.ghostRow=null;this.ghostOriginalPosition=null;this.ghostPosition=new Coord2D(0,0);this.dropTargetIndex=-1;}Util.extend(LayerPanel,EventHandler);LayerPanel.prototype.setController=function(a){this.controller=a;};LayerPanel.prototype.newRow=function(b,a,d,c){return this.insertRow(new LayerPanelRow("row"+this.rowIdCounter++,b,a,d,this,this.dropTargetFamily),c).rowId;};LayerPanel.prototype.insertRow=function(a,b){if(b!==undefined){Util.assert(b>=0&&b<this.rows.length,"Invalid 'beforeRowIndex' argument passed to LayerPanel::insertRow");this.dynamicDiv.insertBefore(a.rowDiv,this.rows[b].rowDiv.nextSibling);this.rows.splice(b,0,a);}else{if(this.rows.length>0){this.dynamicDiv.insertBefore(a.rowDiv,this.rows.peek().rowDiv);}else{this.dynamicDiv.appendChild(a.rowDiv);}this.rows.push(a);}this.rowBtnFamily.addButton(a.rowButton);this.dropTargetFamily.addDropTarget(a.rowDropTarget);return a;};LayerPanel.prototype.removeRow=function(b){Util.assert(b>=0&&b<this.rows.length,"Invalid 'rowIndex' argument passed to LayerPanel::removeRow");var a=this.rows[b];a.cleanup();this.dynamicDiv.removeChild(a.rowDiv);this.rowBtnFamily.removeButton(a.rowButton);this.dropTargetFamily.removeDropTarget(a.rowDropTarget);this.rows.splice(b,1);return a;};LayerPanel.prototype.moveRow=function(d,a){var b=this.rows[d];var c=a!==undefined?this.rows[a]:null;this.dynamicDiv.removeChild(b.rowDiv);this.rows.splice(d,1);if(c){this.dynamicDiv.insertBefore(b.rowDiv,c.rowDiv.nextSibling);this.rows.splice(a>d?a-1:a,0,b);}else{this.dynamicDiv.insertBefore(b.rowDiv,this.rows.peek().rowDiv);this.rows.push(b);}};LayerPanel.prototype.clearAllRows=function(){for(var a=this.rows.length-1;a>=0;a--){this.removeRow(a);}};LayerPanel.prototype.selectRow=function(a){this.rowBtnFamily.toggleButton(this.rows[a].rowButton);};LayerPanel.prototype.toggleCollapse=function(){this.isCollapsed=!this.isCollapsed;if(this.collapseAnimation){this.collapseAnimation.stop();}this.collapseAnimation=new Animation(LayerPanel.collapseTransitionLength,function(){this.collapseAnimation=null;}.bindTo(this));this.collapseAnimation.add(this.mainDiv.style,"right",this.mainDiv.style.right?this.mainDiv.style.right:LayerPanel.defaultPosition,this.isCollapsed?LayerPanel.collapsePosition:LayerPanel.defaultPosition,-1);this.collapseAnimation.begin();this.cstrip.lpCollapseButton.toggle();};LayerPanel.prototype.getRowWithId=function(a){return this.rows[this.getRowIndexForId(a)];};LayerPanel.prototype.getRowIndexForId=function(c){for(var a=0,b=this.rows.length;a<b;a++){if(this.rows[a].rowId==c){return a;}}return -1;};LayerPanel.prototype.createGhostRow=function(b){if(!this.ghostRow){var c=b.rowButton;var a=c.getClientPosition();this.ghostOriginalPosition=a.clone();this.ghostRow=b.rowDiv.cloneNode(true);this.ghostRow.style.pointerEvents="none";Util.addHtmlClass(this.ghostRow,LayerPanelRow.styleGhost);this.ghostRow.style.position="fixed";this.setGhostRowPosition(a.x,a.y);document.body.appendChild(this.ghostRow);}};LayerPanel.prototype.deleteGhostRow=function(){if(this.ghostRow){this.ghostRow.parentNode.removeChild(this.ghostRow);this.ghostRow=null;}};LayerPanel.prototype.setGhostRowPosition=function(a,b){if(this.ghostRow){this.ghostPosition.x=a;this.ghostPosition.y=b;this.ghostRow.style.left=a+"px";this.ghostRow.style.top=b+"px";}};LayerPanel.prototype.translateGhostRow=function(b,a){this.setGhostRowPosition(this.ghostPosition.x+b,this.ghostPosition.y+a);};LayerPanel.prototype.handleRowButton=function(b,a){if(a.target==b.htmlNode||a.target==this.getRowWithId(b.getId()).layerNameDiv){if(!b.isToggled()){this.controller.switchToLayer(b.getId());}}};LayerPanel.prototype.handleVisibilityToggle=function(b,a){this.controller.setLayerVisibility(b.getId(),b.isToggled());};LayerPanel.prototype.handleColorWell=function(b,a){var c=this.getRowWithId(b.getId());c.jscolorPicker.setColor(c.getColor());c.jscolorPicker.activate();};LayerPanel.prototype.handleJsColorPicker=function(c,b,a){this.controller.setLayerColor(c.getId(),b);};LayerPanel.prototype.handleNewLayerButton=function(b,a){this.controller.newLayer(b.getId());};LayerPanel.prototype.handleDeleteLayerButton=function(b,a){this.controller.deleteCurrentLayer(b.getId());};LayerPanel.prototype.handleCollapseButton=function(b,a){this.toggleCollapse();};LayerPanel.prototype.handleLayerNameButton=function(b,a){var c=this.getRowWithId(b.getId());c.layerNameGuiField.activate(c.getName());};LayerPanel.prototype.handleLayerNameField=function(b,c,a){if(c!=""&&!c.match(/^\s+$/)){this.controller.setLayerName(b.getId(),c);}};LayerPanel.prototype.handleBeginDragRow=function(b,a){this.createGhostRow(this.getRowWithId(b.getId()));this.dropTargetIndex=-1;};LayerPanel.prototype.handleDragRow=function(d,c,b,a){this.translateGhostRow(c,b);};LayerPanel.prototype.handleDropRow=function(e,f,a){var d=this.getRowIndexForId(e.getId());var b=function(){this.deleteGhostRow();if(this.dropTargetIndex>=0&&d!=this.dropTargetIndex&&this.dropTargetIndex!=d+1){this.controller.moveLayer(e.getId(),this.dropTargetIndex>=this.rows.length?undefined:this.rows[this.dropTargetIndex].rowId);}}.bindTo(this);if(this.dropTargetIndex==-1){var c=new Animation(LayerPanel.rowSnapAnimationLength,b);c.add(this.ghostRow.style,"left",this.ghostPosition.x+"px",this.ghostOriginalPosition.x+"px",-1);c.add(this.ghostRow.style,"top",this.ghostPosition.y+"px",this.ghostOriginalPosition.y+"px",-1);c.begin();}else{b();}this.insertMarkDiv.style.display="none";};LayerPanel.prototype.handleRowEnterDropTarget=function(b,a){};LayerPanel.prototype.handleRowExitDropTarget=function(b,a){this.insertMarkDiv.style.display="none";this.dropTargetIndex=-1;};LayerPanel.prototype.handleRowMoveWithinDropTarget=function(d,c,b,a){var e=b>LayerPanelRow.halfRowHeight;var f=d.getClientPosition().y;this.dropTargetIndex=e?this.getRowIndexForId(d.getId()):this.getRowIndexForId(d.getId())+1;this.insertMarkDiv.style.display="";this.insertMarkDiv.style.top=((e?f+LayerPanelRow.rowHeight+1:f)-LayerPanelRow.halfRowHeight)+"px";};function LayerPanelControlStrip(b,a){this.newLayerDiv=document.createElement("div");this.newLayerDiv.className="new_layer_button";this.newLayerButton=new GuiButton("new_layer",this.newLayerDiv,a,"handleNewLayerButton",false,"New Layer").enable();this.deleteLayerDiv=document.createElement("div");this.deleteLayerDiv.className="delete_layer_button";this.deleteLayerButton=new GuiButton("delete_layer",this.deleteLayerDiv,a,"handleDeleteLayerButton",false,"Delete Selected Layer").enable();this.lpCollapseDiv=document.createElement("div");this.lpCollapseDiv.className="lp_collapse_button";this.lpCollapseButton=new GuiButton("lp_collapse",this.lpCollapseDiv,a,"handleCollapseButton",false,"Hide Layer Panel [\\], Show Layer Panel [\\]").enable().toggle(true);b.appendChild(this.deleteLayerDiv);b.appendChild(this.newLayerDiv);b.appendChild(this.lpCollapseDiv);}UnderlaySlider.fxLength=0.25;function UnderlaySlider(e,d,b,c,a){UnderlaySlider.baseConstructor.call(this,e,d,b,c);this.cabinetDiv=a;setTimeout(function(){this.cabinetDiv.style.display="block";this.cabinetWidth=this.cabinetDiv.offsetWidth+"px";this.cabinetDiv.style.display="none";}.bindTo(this),0);this.hidden=true;this.animation=null;this.cabinetDiv.style.display="none";this.registerListener("change",this.htmlNode,false);}Util.extend(UnderlaySlider,GuiControl);UnderlaySlider.prototype.show=function(){if(this.hidden){this.hidden=false;this.cabinetDiv.style.display="";if(this.animation){this.animation.stop();}this.animation=new Animation(UnderlaySlider.fxLength);this.animation.add(this.cabinetDiv.style,"width","1px",this.cabinetWidth,-1);this.animation.begin();}};UnderlaySlider.prototype.hide=function(){if(!this.hidden){this.hidden=true;if(this.animation){this.animation.stop();}this.animation=new Animation(UnderlaySlider.fxLength,function(){this.cabinetDiv.style.display="none";}.bindTo(this));this.animation.add(this.cabinetDiv.style,"width",this.cabinetWidth,"1px",-1);this.animation.begin();}};UnderlaySlider.prototype.setValue=function(a){this.htmlNode.value=a;};UnderlaySlider.prototype.change=function(a){this.invokeAction(this.action,this,this.htmlNode.value);};Modal.curtainOpacity=0.6;function Modal(b,a){Modal.baseConstructor.call(this);this.popupDiv=b;this.closeBoxDiv=a;this.curtainDiv=null;this.popupDiv.style.display="none";}Util.extend(Modal,EventHandler);Modal.prototype.show=function(){this.curtainDiv=document.createElement("div");this.curtainDiv.style.position="fixed";this.curtainDiv.style.width="100%";this.curtainDiv.style.height="100%";this.curtainDiv.style.background="#000";this.curtainDiv.style.opacity=Modal.curtainOpacity;document.body.appendChild(this.curtainDiv);this.popupDiv.parentNode.removeChild(this.popupDiv);document.body.appendChild(this.popupDiv);this.popupDiv.style.display="";this.registerListener("mousedown",this.closeBoxDiv,false);this.registerListener("keydown",window,false);};Modal.prototype.hide=function(){this.unregisterListener("mousedown",this.closeBoxDiv,false);this.unregisterListener("keydown",window,false);this.popupDiv.style.display="none";this.curtainDiv.parentNode.removeChild(this.curtainDiv);this.curtainDiv=null;};Modal.prototype.mousedown=function(a){this.hide();};Modal.prototype.keydown=function(a){if(a.keyCode==KeyCode.esc){this.hide();}};UserInterface.defaultTool="lineTool";UserInterface.cursorDefault="cursorDefault";UserInterface.cursorZoomAndPan="cursorZoomAndPan";UserInterface.cursorCrosshair="cursorCrosshair";function UserInterface(b,e,a,c,d){UserInterface.baseConstructor.call(this);this.clipBoard=b;this.appController=e;this.newDocHandler=a;this.saveHandler=c;this.loadHandler=d;this.toolTip=new ToolTip(document.getElementById("tooltip"));this.initSvg();this.initAutoScale();this.initLayerPanel();this.initMenuBar();this.initNavBar();this.initToolBar();this.initToolSet();this.initFileImporters();this.initModals();this.registerListener("keydown",window,false);this.registerListener("keyup",window,false);this.registerListener("contextmenu",window,true);window.onbeforeunload=function(f){if(!this.umDelegate.stateIsClean()){var g="There are unsaved changes to this document.";f.returnValue=g;return g;}}.bindTo(this);}Util.extend(UserInterface,EventHandler);UserInterface.prototype.prepareForDocument=function(a){this.underlayImage=a.underlayImage;this.umDelegate=new UndoManagerDelegate(a.undoManager,this);if(!this.underlayImage.isHidden()){this.hideHud();this.ulSlider.show();this.ulMenu.enableMenuItem("mi_remove_ul");this.ulSlider.setValue(1);}else{this.showHud();this.ulSlider.hide();this.ulMenu.disableMenuItem("mi_remove_ul");}if(this.zap){this.zap.killAllListeners();}this.lpController=new LayerPanelController(this.layerPanel);this.layerPanel.setController(this.lpController);this.lmDelegate=new LayerManagerDelegate(a.layerManager,this.lpController,this);this.lpController.setLayerManagerDelegate(this.lmDelegate);this.lpController.populateLayerPanel();this.zap=new Zap(this.masterGroup,this.autoScale,this.lmDelegate,this.underlayImage,this.toolTip);for(var b in this.toolIndex){this.toolIndex[b].tool.setManagers(this.lmDelegate,this.umDelegate);}if(this.currentTool===null){this.setTool(UserInterface.defaultTool);}else{this.toolIndex[this.currentTool].tool.reset();}this.updateUndoMenuItems();this.updateClippingMenuItems();this.updateNavBar();a.connectDelegates(this.lmDelegate,this.umDelegate);};UserInterface.prototype.setTool=function(a){if(this.toolIndex[a]&&a!=this.currentTool){if(this.currentTool!==null){this.toolIndex[this.currentTool].tool.deactivate();}this.currentTool=a;this.toolIndex[this.currentTool].tool.activate();this.setCursorToCurrentTool();}};UserInterface.prototype.setCursorToCurrentTool=function(){this.setCursor(this.toolIndex[this.currentTool].cursor);};UserInterface.prototype.setCursor=function(a){this.rootGroup.set("class",a);};UserInterface.prototype.showHud=function(){this.hudGroup.set("display","");};UserInterface.prototype.hideHud=function(){this.hudGroup.set("display","none");};UserInterface.prototype.initSvg=function(){this.staticUnderlayGroup=new Group(document.getElementById("static_underlay"));this.rootGroup=new Group(document.getElementById("root"));if(Alberti.crispLines){this.rootGroup.positionAbsolute(Alberti.halfOriginalWindowWidth,Alberti.halfOriginalWindowHeight);}else{this.rootGroup.positionAbsolute(Alberti.halfOriginalWindowWidth+0.5,Alberti.halfOriginalWindowHeight+0.5);}this.rootGroup.push();this.staticOverlayGroup=new Group(document.getElementById("static_overlay"));this.masterGroup=new Group(document.getElementById("master"));if(Alberti.crispLines){this.masterGroup.set("class","optimized");}this.underlayGroup=new Group(document.getElementById("underlay"));this.overlayGroup=new Group(document.getElementById("overlay"));this.hudGroup=new Group(document.getElementById("hud"));};UserInterface.prototype.initToolSet=function(){var a={masterGroup:this.masterGroup,overlayGroup:this.overlayGroup,underlayGroup:this.underlayGroup,toolTip:this.toolTip};this.toolIndex={selectionTool:{tool:new ToolSelection(a),cursor:UserInterface.cursorDefault},markerTool:{tool:new ToolMarker(a),cursor:UserInterface.cursorCrosshair},lineTool:{tool:new ToolLine(a),cursor:UserInterface.cursorCrosshair},circularArcTool:{tool:new ToolCircleArc(a),cursor:UserInterface.cursorCrosshair},ellipticalArcTool:{tool:new ToolEllipticalArc(a),cursor:UserInterface.cursorCrosshair},bezierTool:{tool:new ToolBezier(a),cursor:UserInterface.cursorCrosshair}};this.tbButtonMap={select_tool_btn:"selectionTool",marker_tool_btn:"markerTool",line_tool_btn:"lineTool",carc_tool_btn:"circularArcTool",earc_tool_btn:"ellipticalArcTool",bez_tool_btn:"bezierTool"};this.tbHotKeys={49:this.selectToolBtn,50:this.lineToolBtn,51:this.circularArcToolBtn,52:this.ellipticalArcToolBtn,53:this.bezierToolBtn};this.currentTool=null;};UserInterface.prototype.initAutoScale=function(){var b=new SvgContainer(document.getElementById(Point.templateId));var a=new SvgContainer(document.getElementById(Point.selectedTemplateId));this.autoScale=new AutoScale();this.autoScale.registerObject(b,AutoScale.scale,1);this.autoScale.registerObject(a,AutoScale.scale,1);this.autoScale.registerObject(this.hudGroup,AutoScale.scale,1);if(Alberti.nonScalingLinesHack){this.autoScale.registerObject(this.masterGroup,AutoScale.lineWidth,Alberti.defaultLineWidth);this.autoScale.registerStyle(document.styleSheets[0].cssRules[0].style,AutoScale.dashArray,4);}};UserInterface.prototype.initFileImporters=function(){this.docImporter=new FileImporter(document.getElementById("fi"),"image/svg+xml",true,this.appController,"handleOpenDocument","svg");this.ulImgImporter=new FileImporter(document.getElementById("uii"),"image/gif,image/jpeg,image/png,image/tiff",false,this,"handleImportUlImage","jpg|jpeg|png|tiff|tif|gif");};UserInterface.prototype.initLayerPanel=function(){var b=document.getElementById("layer_panel");var a=document.getElementById("layer_panel_dynamic");var d=document.getElementById("layer_panel_control_strip");var c=document.createElement("div");c.id="insertmark";document.body.appendChild(c);this.layerPanel=new LayerPanel(b,a,d,c);};UserInterface.prototype.initMenuBar=function(){this.helpMenu=new GuiMenu("help_menu",document.getElementById("help_menu"),this,"handleMenu",document.getElementById("help_menu_btn"));this.fileMenu=new GuiMenu("file_menu",document.getElementById("file_menu"),this,"handleMenu",document.getElementById("file_menu_btn"));this.editMenu=new GuiMenu("edit_menu",document.getElementById("edit_menu"),this,"handleMenu",document.getElementById("edit_menu_btn"));this.ulMenu=new GuiMenu("ul_menu",document.getElementById("ul_menu"),this,"handleMenu",document.getElementById("ul_menu_btn"));this.editMenu.disableMenuItem("mi_paste");this.ulMenu.disableMenuItem("mi_remove_ul");this.menuBar=new GuiMenuBar();this.menuBar.addMenu(this.helpMenu);this.menuBar.addMenu(this.fileMenu);this.menuBar.addMenu(this.editMenu);this.ulSlider=new UnderlaySlider("ul_slider",document.getElementById("ul_opac_slider"),this,"handleUlSlider",document.getElementById("ul_slider_cab"));};UserInterface.prototype.initNavBar=function(){this.centerWorkspaceBtn=new GuiButton("center_ws_btn",document.getElementById("center_ws_btn"),this,"handleNavBar",false,"Center Workspace","",true).enable();this.nextMarkerBtn=new GuiButton("next_marker_btn",document.getElementById("next_marker_btn"),this,"handleNavBar",false,"Pan To Next Marker [Space]","",true).enable();this.prevMarkerBtn=new GuiButton("prev_marker_btn",document.getElementById("prev_marker_btn"),this,"handleNavBar",false,"Pan To Previous Marker [Shift-Space]","",true).enable();this.nextMarkerBtn.disable();this.prevMarkerBtn.disable();};UserInterface.prototype.initToolBar=function(){this.selectToolBtn=new GuiButton("select_tool_btn",document.getElementById("select_tool_btn"),this,"handleToolBar",false,"Selection Tool [1]","",true).enable();this.markerToolBtn=new GuiButton("marker_tool_btn",document.getElementById("marker_tool_btn"),this,"handleToolBar",false,"Marker Tool","",true).enable();this.lineToolBtn=new GuiButton("line_tool_btn",document.getElementById("line_tool_btn"),this,"handleToolBar",false,"Line Tool [2]","",true).enable();this.circularArcToolBtn=new GuiButton("carc_tool_btn",document.getElementById("carc_tool_btn"),this,"handleToolBar",false,"Circular Arc Tool [3]","",true).enable();this.ellipticalArcToolBtn=new GuiButton("earc_tool_btn",document.getElementById("earc_tool_btn"),this,"handleToolBar",false,"Perspective Arc Tool [4]","",true).enable();this.bezierToolBtn=new GuiButton("bez_tool_btn",document.getElementById("bez_tool_btn"),this,"handleToolBar",false,"Bezier Tool [5]","",true).enable();this.tbButtonFamily=new GuiButtonFamily();this.tbButtonFamily.addButton(this.selectToolBtn);this.tbButtonFamily.addButton(this.markerToolBtn);this.tbButtonFamily.addButton(this.lineToolBtn);this.tbButtonFamily.addButton(this.circularArcToolBtn);this.tbButtonFamily.addButton(this.ellipticalArcToolBtn);this.tbButtonFamily.addButton(this.bezierToolBtn);this.tbButtonFamily.toggleButton(this.lineToolBtn);};UserInterface.prototype.updateUndoMenuItems=function(b,a){if(b){this.editMenu.enableMenuItem("mi_undo");}else{this.editMenu.disableMenuItem("mi_undo");}if(a){this.editMenu.enableMenuItem("mi_redo");}else{this.editMenu.disableMenuItem("mi_redo");}};UserInterface.prototype.updateNavBar=function(){if(this.lmDelegate.getNumMarkers()>0){this.nextMarkerBtn.enable();this.prevMarkerBtn.enable();}else{this.nextMarkerBtn.disable();this.prevMarkerBtn.disable();}};UserInterface.prototype.initModals=function(){this.aboutBox=new Modal(document.getElementById("about_box"),document.getElementById("abt_cb"));};UserInterface.prototype.updateClippingMenuItems=function(a){if(a){this.editMenu.enableMenuItem("mi_cut");this.editMenu.enableMenuItem("mi_delete");}else{this.editMenu.disableMenuItem("mi_cut");this.editMenu.disableMenuItem("mi_delete");}};UserInterface.prototype.discardUnsavedChanges=function(){if(!this.umDelegate.stateIsClean()){return confirm("There are unsaved changes to this document. Are you sure you want to discard these changes and open another document?");}return true;};UserInterface.prototype.handleImportUlImage=function(a){this.underlayImage.setSourceToDataUrl(a);this.underlayImage.opacity=1;this.zap.updateUnderlayImage();this.underlayImage.show();this.hideHud();this.ulMenu.enableMenuItem("mi_remove_ul");this.ulSlider.show();this.ulSlider.setValue(1);};UserInterface.prototype.handleMenu=function(c){switch(c){case"mi_new_doc":var a=true;if(!this.umDelegate.stateIsClean()){a=confirm("There are unsaved changes to this document. Are you sure you want to discard these changes and create a new document?");}if(a){this.appController[this.newDocHandler]();}break;case"mi_open_doc":if(this.discardUnsavedChanges()){this.docImporter.prompt();}break;case"mi_save_doc":this.appController[this.saveHandler](AlbertiDocument.exportTypeSvg);break;case"mi_undo":this.umDelegate.undo();break;case"mi_redo":this.umDelegate.redo();break;case"mi_cut":var b=this.lmDelegate.getSelectedShapes();if(b.length>0){this.clipBoard.copy(b);this.lmDelegate.deleteSelectedShapes();this.editMenu.enableMenuItem("mi_paste");}break;case"mi_paste":if(!this.clipBoard.isEmpty()){this.umDelegate.recordStart();this.clipBoard.paste(this.lmDelegate);this.umDelegate.recordStop();this.clipBoard.clear();this.editMenu.disableMenuItem("mi_paste");}break;case"mi_delete":this.lmDelegate.deleteSelectedShapes();break;case"mi_select_all":this.lmDelegate.setSelection(this.lmDelegate.getShapesInCurrentLayer());break;case"mi_import_ul":this.ulImgImporter.prompt();break;case"mi_remove_ul":this.underlayImage.hide();this.ulMenu.disableMenuItem("mi_remove_ul");this.ulSlider.hide();this.showHud();break;case"mi_help":window.open("help.html","alb_help","resizable=yes,scrollbars=yes,status=no,toolbar=no,width=650");break;case"mi_about":this.aboutBox.show();break;}};UserInterface.prototype.handleNavBar=function(a){switch(a.getId()){case"center_ws_btn":this.zap.panTo(new Coord2D(0,0),true);break;case"next_marker_btn":if(this.lmDelegate.getNumMarkers()>0){var b=this.lmDelegate.nextMarker();this.zap.panTo(b?b:this.zap.getLastPanPosition());}break;case"prev_marker_btn":if(this.lmDelegate.getNumMarkers()>0){var b=this.lmDelegate.previousMarker();this.zap.panTo(b?b:this.zap.getLastPanPosition());}break;}};UserInterface.prototype.handleToolBarItemId=function(a){this.setTool(this.tbButtonMap[a]);};UserInterface.prototype.handleToolBar=function(a){this.setTool(this.tbButtonMap[a.getId()]);this.tbButtonFamily.toggleButton(a);};UserInterface.prototype.handleUlSlider=function(a,b){if(b>0){this.underlayImage.show();this.underlayImage.opacity=b;this.underlayImage.update();this.hideHud();}else{this.underlayImage.hide();this.showHud();}};UserInterface.prototype.keydown=function(a){if(!a.shiftKey){switch(a.keyCode){case KeyCode.manPan:case KeyCode.alt:this.zap.enablePanning();this.setCursor(UserInterface.cursorZoomAndPan);this.toolIndex[this.currentTool].tool.disable();break;case KeyCode.autoPan:this.nextMarkerBtn.click();break;case KeyCode.del:case KeyCode.backspace:this.handleMenu("mi_delete");a.preventDefault();break;case KeyCode.selectAll:this.handleMenu("mi_select_all");break;case KeyCode.undoRedo:this.handleMenu("mi_undo");break;case KeyCode.cut:this.handleMenu("mi_cut");break;case KeyCode.paste:this.handleMenu("mi_paste");break;case KeyCode.lpCollapse:this.layerPanel.toggleCollapse();break;case KeyCode.arrowUp:this.lmDelegate.switchToVisibleLayerAboveCurrentLayer();this.toolTip.setText("Select layer: "+this.lmDelegate.getCurrentLayer().name,true);break;case KeyCode.arrowDown:this.lmDelegate.switchToVisibleLayerBelowCurrentLayer();this.toolTip.setText("Select layer: "+this.lmDelegate.getCurrentLayer().name,true);break;default:var b=this.tbHotKeys[a.keyCode.toString()];if(b){b.click();}break;}}else{switch(a.keyCode){case KeyCode.autoPan:this.prevMarkerBtn.click();break;case KeyCode.undoRedo:this.handleMenu("mi_redo");break;case KeyCode.newDoc:this.handleMenu("mi_new_doc");break;case KeyCode.save:this.handleMenu("mi_save_doc");break;case KeyCode.load:if(this.discardUnsavedChanges()){this.docImporter.prompt();}break;}}};UserInterface.prototype.keyup=function(a){switch(a.keyCode){case KeyCode.manPan:case KeyCode.alt:this.zap.disablePanning();this.setCursorToCurrentTool();this.toolIndex[this.currentTool].tool.enable();break;}};UserInterface.prototype.contextmenu=function(a){a.preventDefault();};
]]> </script>
</head><body onload="main()">
	<noscript>
		<div id="js_required">
			Javascript must be enabled in order for Alberti to run.
		</div>
	</noscript>
	<div id="content" style="display:none">
		<div id="hidden_div">
			<input type="file" id="fi" />
			<input type="file" id="uii" />
		</div>
		<img id="underlayimg" src="images/dummy.png" style="display:none" />
		<svg id="svgroot" style="position: absolute; width:100%; height:100%"
			xmlns="http://www.w3.org/2000/svg" version="1.1"
			xmlns:xlink="http://www.w3.org/1999/xlink"
			xmlns:berti="http://www.albertidraw.com/alberti">
			<defs>
				<marker id="marker_selected" refX="2" refY="2" markerWidth="4" markerHeight="4">
					<rect x="0" y="0" width="4" height="4" />
				</marker>
				<g id="point_template" shape-rendering="auto">
					<circle cx="0" cy="0" r="1" stroke="none" stroke-width="1" />
					<circle cx="0" cy="0" r="3" stroke-width="1.5" fill="none" />
				</g>
				<g id="point_template_sel" shape-rendering="auto">
					<circle cx="0" cy="0" r="1" stroke="none" stroke-width="1" />
					<circle cx="0" cy="0" r="3" stroke-width="1.5" fill="none" />
					<circle cx="0" cy="0" r="5" stroke-width="1.5" fill="none" stroke-dasharray="4, 4" />
				</g>
			</defs>
			<g id="static_underlay"></g>
			<g id="root">
				<!-- This large rectangle is used to set the cursor -->
				<rect id="background" x="-10000" y="-10000" width="20000" height="20000" pointer-events="all" />
				<g id="master">
					<g id="underlay"></g>
					<g id="hud">
						<line x1="-18" y1="-18" x2="-10" y2="-10" stroke="#bbbbcc" stroke-width="1" />
						<line x1="-18"  y1="18" x2="-10"  y2="10" stroke="#bbbbcc" stroke-width="1" />
						<line  x1="18" y1="-18"  x2="10" y2="-10" stroke="#bbbbcc" stroke-width="1" />
						<line  x1="18"  y1="18"  x2="10"  y2="10" stroke="#bbbbcc" stroke-width="1" />
						<line  x1="4"   y1="4"  x2="-4"  y2="-4" stroke="#bbbbcc" stroke-width="1" />
						<line  x1="4"  y1="-4"  x2="-4"   y2="4" stroke="#bbbbcc" stroke-width="1" />
					</g>
					<g id="workspace"></g>
					<g id="overlay"></g>
				</g>
			</g>
			<g id="static_overlay"></g>
		</svg>
		<div id="striptop"></div>
		<div id="layer_panel">
			<div id="layer_panel_dynamic"></div>
			<div id="layer_panel_control_strip">
				<div class="layer_panel_row"></div>
			</div>
		</div>
		<div id="toolbar">
			<div id="select_tool_btn" class="side_btn"><div></div></div>
			<div class="tb_hr"></div>
			<div id="line_tool_btn" class="side_btn"><div></div></div>
			<div id="carc_tool_btn" class="side_btn"><div></div></div>
			<div class="tb_hr"></div>
			<div id="earc_tool_btn" class="side_btn"><div></div></div>
			<div id="bez_tool_btn" class="side_btn"><div></div></div>
			<div class="tb_hr"></div>
			<div id="marker_tool_btn" class="side_btn"><div></div></div>
		</div>
		<div id="menubar">
			<div id="help_menu_btn" class="mb_btn">?</div>
			<div id="file_menu_btn" class="mb_btn">File</div>
			<div id="edit_menu_btn" class="mb_btn">Edit</div>
			<div class="mb_vr"></div>
			<div class="btn_wrapper">
				<div id="center_ws_btn" class="top_btn"></div>
				<div id="next_marker_btn" class="top_btn"></div>
				<div id="prev_marker_btn" class="top_btn"></div>
			</div>
			<div class="mb_vr"></div>
			<div id="ul_menu_btn" class="mb_btn"></div>
			<div id="ul_slider_cab">
				<div class="btn_wrapper">
					<div id="ul_slider_wrapper">
						<label for="ul_opac_slider">Opacity:</label><input id="ul_opac_slider" type="range" min="0" max="1.0" value="1.0" step="0.01"/>
					</div>
				</div>
			</div>
		</div>
		<ul id="help_menu" class="menu">
			<li id="mi_help"><span class="mi_name">Help</span><span class="mi_spacer">.</span></li>
			<li id="mi_about"><span class="mi_name">About Alberti</span><span class="mi_spacer">.</span></li>
		</ul>
		<ul id="file_menu" class="menu">
			<li id="mi_new_doc"><span class="mi_name">New</span><span class="mi_scut">&#x21e7;N</span></li>
			<li id="mi_open_doc"><span class="mi_name">Open...</span><span class="mi_scut">&#x21e7;O</span></li>
			<li class="mi_hr"><hr /></li>
			<li id="mi_save_doc"><span class="mi_name">Save As...</span><span class="mi_scut">&#x21e7;S</span></li>
		</ul>
		<ul id="edit_menu" class="menu">
			<li id="mi_undo"><span class="mi_name">Undo</span><span class="mi_scut">Z</span></li>
			<li id="mi_redo"><span class="mi_name">Redo</span><span class="mi_scut">&#x21e7;Z</span></li>
			<li class="mi_hr"><hr /></li>
			<li id="mi_cut"><span class="mi_name">Cut</span><span class="mi_scut">X</span></li>
			<li id="mi_paste"><span class="mi_name">Paste</span><span class="mi_scut">V</span></li>
			<li id="mi_delete"><span class="mi_name">Delete</span><span class="mi_spacer">.</span></li>
			<li id="mi_select_all"><span class="mi_name">Select All In Layer</span><span class="mi_scut">A</span></li>
		</ul>
		<ul id="ul_menu" class="menu">
			<li id="mi_import_ul">
				<span class="mi_name">Import Underlay...</span><span class="mi_spacer">.</span>
			</li>
			<li id="mi_remove_ul"><span class="mi_name">Remove Underlay</span><span class="mi_spacer">.</span></li>
		</ul>
		<div id="tooltip"></div>
		<div id="about_box" class="modal">
			<div id="abt_cb" class="cbox"></div>
			<div id="about_top">
				<div class="kickup">
					<span class="masthead">Alberti</span>
					<span class="blurb">Perspective drawing and layout</span>
				</div>
			</div>
			<div id="about_bot">
				<div id="about_left">
					<p>Created by</p>
					<p class="indent">
						<p>Alaric Holloway</p>
					</p>
					<p>Acknowledgements</p>
					<p class="indent">
						<p>Jan Odvrko<br/><a href="http://jscolor.com" target="_blank">JSColor</a></p>
						<p>Frank Yan<br/><a href="http://frankyan.com/labs/html5slider/" target="_blank">html5slider</a></p>
						<p>James Coglan<br/><a href="http://sylvester.jcoglan.com/" target="_blank">Sylvester</a></p>
						<p>Kevin Lindsey<br/><a href="http://www.kevlindev.com/tutorials/basics/index.htm" target="_blank">SVG Basics</a></p>
					</p>
					<p class="license">
						Alberti is &copy; 2011 Alaric Holloway, and is licensed under <a href="http://www.gnu.org/copyleft/gpl.html" target="_blank">GPL</a>. Get the <a href="https://github.com/worminger/Alberti" target="_blank">source code</a>.
					</p>
				</div>
				<div style="clear:both"></div>
			</div>
			<div id="version">
			</div>
		</div>
	</div>
</body></html>
